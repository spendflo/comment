{
  "version": 3,
  "sources": ["scripts/partial-database-dump.ts", "server/src/admin/databaseDump/index.ts", "common/const/Urls.ts", "common/const/Ids.ts", "server/src/logging/Logger.ts", "server/src/entity/application/ApplicationEntity.ts", "server/src/featureflags/index.ts", "server/src/config/MagicEnv.ts", "server/src/config/Env.ts", "common/const/FeatureFlags.ts", "server/src/email/index.ts", "common/types/index.ts", "server/src/entity/email_notification/EmailOutboundNotificationEntity.ts", "server/src/email/utils.ts", "server/src/entity/event/EventEntity.ts", "common/const/Sizes.ts", "server/src/entity/customer/CustomerEntity.ts", "server/src/logging/flatFormat.ts", "package.json", "server/src/logging/prometheus.ts", "server/src/auth/index.ts", "server/src/util/CordError.ts", "server/src/entity/org_members/OrgMembersEntity.ts", "server/src/util/readReplicaDatabase.ts"],
  "sourcesContent": ["#!/usr/bin/env -S node --enable-source-maps\n\n// This script connects to the radical database and\n// creates a partial dump of it.\n//\n// Please look at `server/src/admin/databaseDump/index.ts` for more information.\n//\n// This script can be run without running a server instance. Instead of\n// downloading the database dump using `curl`, run this script like this\n//\n// Typical use:\n// # build/index.mjs --target=scripts\n// # dist/scripts/partial-database-dump.js --envFile .env >dump.sql\n// # psql -f dump.sql new_radical_db_local\n//\n// The above assumes that:\n// * there is a file called \".env\" which has the POSTGRES_* variables in it,\n//   pointing to the PostgreSQL database from which you want to create the\n//   partial dump.\n// * you have a local database server, which has a database called\n//   `new_radical_db_local` on it\n// * if there is any data in `new_radical_db_local`, you are ready to wipe all\n//   of it.\n//\n// Please look at `server/src/admin/databaseDump/index.ts` for more information.\n\nimport { promises as fs } from 'fs';\nimport * as path from 'path';\nimport yargs from 'yargs';\nimport * as dotenv from 'dotenv';\n\nimport { streamPartialDump } from 'server/src/admin/databaseDump/index.ts';\nimport { getReadReplicaDbConfigFromEnv } from 'server/src/util/readReplicaDatabase.ts';\n\nasync function main() {\n  const argv = yargs(process.argv.slice(2))\n    .option({\n      envFile: {\n        description: 'path to the .env file with database configuration',\n        default: '.env',\n        type: 'string',\n      },\n    })\n    .help().argv;\n\n  const env = dotenv.parse(\n    await fs.readFile(path.resolve(process.cwd(), argv.envFile), {\n      encoding: 'utf8',\n    }),\n  );\n\n  await streamPartialDump(process.stdout, getReadReplicaDbConfigFromEnv(env));\n}\n\nmain().then(\n  () => {\n    process.exit(0);\n  },\n  (error) => {\n    console.error(error);\n    process.exit(1);\n  },\n);\n", "// This function connects to the radical database (the same as Sequelize\n// connects to) and streams a partial dump of it to the given WritableStream.\n// The stream contains all the SQL commands to create the Cord tables, indexes,\n// types, functions etc., and then loads data into those tables. The data is\n// partial in the sense that the `orgs` table will only contain one entry: our\n// own org (as defined by `RADICAL_ORG_ID`). All the other tables will contain\n// only those rows that do not reference an org other than ours in any way.\n//\n// Typical use:\n// ```\n// # curl --header \"Authorization: TOKEN\" \\\n//       https://admin.cord.com/partial-database-dump >dump.sql\n// # psql -f dump.sql radical_db_local\n// ```\n// (`TOKEN` needs to be replaced with the authorization token of a logged-in\n// admin user. You can copy and paste it from the sidebar: go to the Hacks\n// panel and copy all contents of the 'Authorization Header' field, beginning\n// with and including \"Bearer\".)\n//\n// The above assumes that:\n// * you have a local database server, which has a database called\n//   `radical_db_local` on it\n// * you are ready to wipe all the data that is currently stored in\n//   `radical_db_local`\n//\n// What it does:\n// * the first command contacts admin.api.cord which runs this function, and\n//   the output is saved locally into a file called `dump.sql`\n// * the second command starts the PostgreSQL command line client, asks it to\n//   connect to your database `radical_db_local` and execute all the statements\n//   in `dump.sql` in it. This will wipe all the contents of `radical_db_local`\n//   (well, of the `cord` schema), and then recreates all the tables, types,\n//   functions etc., loads data into the tables, and then finalises the database\n//   schema (creates indexes, sets up constraints etc.)\n//\n// What you have afterwards:\n// The `radical_db_local` database will have a `cord` schema that will have\n// exactly the same structure as the production database. In terms of database\n// migration, it is in an identical state to the production database. It also\n// has a subset of data, namely all data that does not reference in any way\n// an org other than our own (as defined as RADICAL_ORG_ID in common/const/Ids).\n//\n// BE CAREFUL!!!\n// Make sure you never execute `dump.sql` in the production database, as it\n// would also wipe all data and then only recreate the data belonging to our\n// org.\n//\n// When you run this script, it connects to the database  and immediately\n// begins a read-only transaction, thus making sure that it does not make any\n// changes whatsoever to the database it is connected to. The transaction is\n// configured such that it operates on a snapshot of the database, and it does\n// not interfere at all with the production traffic (i.e. it will never block\n// any other database connection). As a result, the dump created contains a\n// consistent set of data.\n//\n// The output of this function is a SQL text file, i.e. a file containing a\n// series of (very many) SQL statements. Feel free to inspect the file. Again:\n// executing this file in a database means first wiping all Cord tables, before\n// recreating them and loading some data into them.\n//\n// While you should never execute the created dump on the prod db, it is very\n// safe to execute it on your local database: the whole file is also\n// encapsulated in a transaction. Meaning that, if any of the statements fails,\n// all changes to your local database (including the wipe at the beginning) are\n// rolled back. So, if replaying the dump fails, you keep your existing\n// database.\n//\n// Q & A\n//\n// Q: do I need to modify this file if I make changes to our database schema\n// (like a database migration)?\n// A: you shouldn't need to. This code in this file is very smart at inspecting\n// the database it connects to, so if you create a new table, it will also\n// include that in future runs. If, however, you want to exclude your table\n// from being included in the dumps this file creates, you will have to add the\n// name of the table in the `additionalConstraints` object defined below in the\n// code.  If you give it a value of `false`, no data will be loaded for the\n// given table. Alternatively, you can load _some_ data by specifying a\n// constraint (like in a WHERE clause). For example, we don't copy all the data\n// from the very big `events` table, but only the last 3 days of data (as per\n// the `serverTimestamp` column). If you want similar treatment of your new\n// table, add a constraint there.\n//\n// Q: is there anything at all I need to keep in mind when I write database\n// migrations, with regards to these partial database dumps?\n// A: always declare your foreign key relationships! There are many reasons to\n// do this, and this file adds one more. The code in here inspects declared\n// foreign key relationships to figure out what data belongs to orgs other than\n// our own org. If you don't declare foreign keys, this script might include\n// data it shouldn't.\n//\n// Q: I'm working on something that includes a database migration. During\n// development, I applied my new migration, but I have changed it since. I\n// forgot to run `npm run migrate-down` before I made changes, so I'm not even\n// quite sure what exact state my database is in. Anyway, I'd quite like to\n// get back to a known state, from which I can apply my migration again. Can\n// a partial database dump from this code help me?\n// A: yeah sure, just run the procedure described at the top. Bootstrapping your\n// local database from prod means that you have the exact same database schema\n// that prod has right now. That won't have your migration in it at all. So\n// you can just run `npm run migrate` afterwards to have your work-in-progress\n// migratation applied.\n//\n// Q: when bootstrapping my local database from prod, will my local database\n// look like the one in prod, or like the `migrations` folder of my local\n// checkout.\n// A: strictly the former. This code gets all information from the database it\n// connects to, and no information from checked-in database migrations or your\n// local checkout.\n\nimport * as child_process from 'child_process';\nimport Pg from 'pg';\nimport { to as copyTo } from 'pg-copy-streams';\n\nimport {\n  CORD_CUSTOMER_ID,\n  CORD_PLATFORM_ORG_ID,\n  CORD_SDK_TEST_ORG_ID,\n  RADICAL_ORG_ID,\n  RADICAL_TEST_ORG_ID,\n} from 'common/const/Ids.ts';\nimport { anonymousLogger } from 'server/src/logging/Logger.ts';\nimport type { DatabaseConfig } from 'server/src/util/readReplicaDatabase.ts';\n\nconst { escapeLiteral, escapeIdentifier } = Pg.Client.prototype;\n\n// Add ids of orgs here that you want to have included in the partial dumps.\nconst includedOrgIDs = [\n  RADICAL_ORG_ID,\n  RADICAL_TEST_ORG_ID,\n  CORD_PLATFORM_ORG_ID,\n  CORD_SDK_TEST_ORG_ID,\n  '084f65aa-5de9-48af-a297-32a17c7fd6f4', // clack_all (public channels),\n  '644c0620-4799-4469-a202-eb092f76181b', // clack_utility_users (users needed for Clack to work)\n];\nconst orgIDsLiteral = `(${includedOrgIDs.map(escapeLiteral).join(',')})`;\n\n// Additional constraints.\n// Some tables are very big and the data in them not very important. Let's\n// get _some_ data, but not all.\n// If a table is set to `false`, no data is copied at all.\nconst additionalConstraints: Record<\n  string,\n  ((alias: string) => string) | false | undefined\n> = {\n  // This script was written pre-SDK and so uses the org as the basis of what\n  // information to include, \"down\" from there. Since the application is \"above\"\n  // that in the heirarchy, we should quickly limit ourselves to just our own\n  // customer ID. Someday we should rewrite this script to go \"down\" from\n  // certain app IDs, but this is good enough for now.\n  applications: (alias) => `${alias}.\"customerID\" = '${CORD_CUSTOMER_ID}'`,\n  console_users: (alias) => `${alias}.\"customerID\" = '${CORD_CUSTOMER_ID}'`,\n\n  // The `users` table does not contain a foreign key. What we want is include\n  // only those users that are referenced by a profile in the org_members table\n  // in our org.\n  users: (alias) =>\n    `${alias}.id IN (\n      SELECT DISTINCT \"userID\" FROM \"org_members\"\n      WHERE \"orgID\" IN ${orgIDsLiteral}\n    )`,\n\n  // Contains customer secrets for their s3_buckets, don't include\n  s3_buckets: false,\n\n  // Big tables that we don't need.\n  events: false,\n  application_usage_metrics: false,\n  sessions: false,\n};\n\nexport function streamPartialDump(\n  output: NodeJS.WritableStream,\n  dbconfig: DatabaseConfig,\n) {\n  return beginDump(dbconfig, output, (pg) => streamPartialDumpImpl(output, pg));\n}\n\nexport async function beginDump<T>(\n  dbconfig: DatabaseConfig,\n  output: NodeJS.WritableStream,\n  func: (pg: Pg.Client) => Promise<T>,\n) {\n  // Connect to the database\n  const pg = new Pg.Client(dbconfig);\n  await pg.connect();\n\n  try {\n    // This is the process environment we pass to the `pg_dump` command line tool.\n    const psqlClientEnv = {\n      ...process.env,\n      PGDATABASE: dbconfig.database,\n      PGHOST: dbconfig.host,\n      PGPORT: dbconfig.port?.toString(),\n      PGUSER: dbconfig.user,\n      PGPASSWORD: dbconfig.password,\n    };\n\n    // Make sure all commands see the contents of both the `cord` and the `public`\n    // schema\n    await pg.query('SET search_path=cord,public;');\n\n    // Start a read-only transaction. The specific type of transaction is one\n    // suited for long-running backup operations, like this one.\n    // From `https://www.postgresql.org/docs/12/sql-set-transaction.html`:\n    // > The DEFERRABLE transaction property has no effect unless the transaction\n    // > is also SERIALIZABLE and READ ONLY. When all three of these properties\n    // > are selected for a transaction, the transaction may block when first\n    // > acquiring its snapshot, after which it is able to run without the normal\n    // > overhead of a SERIALIZABLE transaction and without any risk of\n    // > contributing to or being canceled by a serialization failure. This mode\n    // > is well suited for long-running reports or backups.\n    //\n    // If we are configured to hit a read-only Aurora replica, it will not let us\n    // use SERIALIZABLE transactions. Being connected to a read-only endpoint, we\n    // don't need to worry about serialization failures, so a REPEATABLE READ\n    // transaction is fine.\n    await pg\n      .query(\n        'BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY DEFERRABLE;',\n      )\n      .catch((error) => {\n        if (\n          error.toString() ===\n          'error: cannot use serializable mode in a hot standby'\n        ) {\n          return pg.query(\n            'BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ READ ONLY;',\n          );\n        } else {\n          return Promise.reject(error);\n        }\n      });\n\n    // Get the id of the snapshot we're working on, so we can pass it to pg_dump\n    // below. This means that pg_dump will work like if it was executed within\n    // this transaction. So its output will be guaranteed to be perfectly\n    // consistent with all the data we extract from the database.\n    const snapshotId = (await pg.query('SELECT pg_export_snapshot() AS id;'))\n      .rows[0].id;\n\n    // First start a transaction.\n    let preData = 'BEGIN;\\n\\n';\n    // Remove the whole `cord` schema, if it exists. This will wipe all Cord\n    // tables, types, functions etc. and all Cord data from the database in which\n    // this file will be executed.\n    preData += 'DROP SCHEMA IF EXISTS cord CASCADE;\\n';\n\n    // This gets us all the Postgresql statements to create tables, functions,\n    // data types etc. Everything we need to have before we can insert data.\n    preData += await spawn(\n      'pg_dump',\n      [\n        `--snapshot=${snapshotId}`,\n        '--section=pre-data',\n        '--no-owner',\n        '--no-acl',\n        '--schema=cord',\n      ],\n      psqlClientEnv,\n    );\n\n    // This gets us all the Postgresql statements to create indexes, add\n    // constraints on tables etc. Everything we need to do to have the complete\n    // database schema. Inserting data is easier before this has happened, so\n    // that's why we have separate preData and postData parts of the database\n    // schema.\n    let postData = await spawn(\n      'pg_dump',\n      [\n        `--snapshot=${snapshotId}`,\n        '--section=post-data',\n        '--no-owner',\n        '--no-acl',\n        '--schema=cord',\n      ],\n      psqlClientEnv,\n    );\n\n    // Make sure, the rest of the SQL file will look for tables in both `cord`\n    // and `public` schemas.\n    preData += '\\nSET search_path = cord, public;\\n';\n\n    // SequelizeMeta table\n    // * create the table if it doesn't exist\n    // * remove all rows from it\n    // * copy over all rows from the source database\n    preData += `\n      CREATE TABLE IF NOT EXISTS public.\"SequelizeMeta\" (\n          name character varying(255) NOT NULL\n      );\n      TRUNCATE public.\"SequelizeMeta\";`;\n\n    const migrationNames = (\n      await pg.query('SELECT name FROM public.\"SequelizeMeta\" ORDER BY name;')\n    ).rows.map((row) => row.name);\n    if (migrationNames.length) {\n      preData += `\n      INSERT INTO public.\"SequelizeMeta\" (name) VALUES ${migrationNames\n        .map((name) => `(${pg.escapeLiteral(name)})`)\n        .join(', ')};\\n\\n`;\n    }\n\n    // Just one more thing: in `migrations/20201019134849-pg-boss.js` we created\n    // one function in the \"public\" schema (`gen_random_uuid`). It is used by\n    // pgboss, and normally it would come from the `pgcrypto` extension. By\n    // providing this shim function, we got rid of the dependence on\n    // `pgcrypto`.  Our database schema dump only included the `cord` schema,\n    // so we still have to add that one function.\n    preData += `CREATE OR REPLACE FUNCTION public.gen_random_uuid()\n                RETURNS uuid AS 'SELECT uuid_generate_v4();' LANGUAGE SQL;\\n\\n`;\n\n    // If all of the above executed without an error, commit everything to the\n    // database!\n    postData += '\\n\\nCOMMIT;\\n';\n\n    output.write(preData);\n    const result = await func(pg);\n    output.write(postData);\n\n    return result;\n  } finally {\n    pg.end().catch(\n      anonymousLogger().exceptionLogger('pg.end() threw exception'),\n    );\n  }\n}\n\nasync function streamPartialDumpImpl(\n  output: NodeJS.WritableStream,\n  pg: Pg.Client,\n) {\n  // Get a list of tables in the cord schema. The `tables` map will contain\n  // values with fields `oid` (numerical identifier of the table), `name`,\n  // `columns` (list of column name strings). We also put an empty list of\n  // foreign keys in those objects (`fkeys`), which we will populate in the next\n  // step. And we copy over the `additionalConstraint` if there is one defined\n  // for this table at the top of this file.\n  const tables = new Map<number, Table>();\n  for (const row of (\n    await pg.query(`\n      WITH \"attributes\" AS (\n          SELECT\n              attrelid,\n              jsonb_agg(attname::text ORDER BY attnum) AS attributes\n          FROM pg_catalog.pg_attribute\n          WHERE attnum >= 1\n          AND NOT attisdropped\n          AND attgenerated != 's'\n          GROUP BY attrelid\n      )\n      SELECT\n          cls.oid::int4 AS oid,\n          cls.relname AS name,\n          COALESCE(attributes.attributes, '[]'::jsonb) AS columns\n      FROM pg_catalog.pg_class cls\n      LEFT OUTER JOIN attributes ON cls.oid = attributes.attrelid\n      WHERE relnamespace='cord'::regnamespace AND relkind='r';`)\n  ).rows) {\n    tables.set(row.oid, {\n      ...row,\n      fkeys: [],\n      additionalConstraint: additionalConstraints[row.name] ?? null,\n    });\n  }\n\n  // Get all foreign keys. For each declared foreign key relationship, we add\n  // one `ForeignKey` object to the `Table.fkeys` array, which contains the\n  // referenced table, the names of the columns containing the foreign key\n  // fields in this table, the corresponding column names in the referenced\n  // table, and also the comparison\n  // operator (typically `=`).\n  for (const row of (\n    await pg.query(`\n      SELECT\n          conrelid AS \"tableOid\",\n          confrelid AS \"referencedTableOid\",\n          array_to_json(ARRAY(\n              SELECT jsonb_build_object(\n                  'column', att.attname::text,\n                  'nullable', NOT att.attnotnull\n                )\n              FROM unnest(conkey) k\n              LEFT OUTER JOIN pg_catalog.pg_attribute att\n              ON att.attnum=k AND att.attrelid=conrelid\n          )) AS fkey,\n          ARRAY(\n              SELECT att.attname::text\n              FROM unnest(confkey) k\n              LEFT OUTER JOIN pg_catalog.pg_attribute att\n              ON att.attnum=k AND att.attrelid=confrelid\n          ) AS rkey,\n          ARRAY(\n              SELECT opr.oprname::text\n              FROM unnest(conpfeqop) k\n              LEFT OUTER JOIN pg_catalog.pg_operator opr ON opr.oid=k\n          ) AS ops\n          FROM pg_catalog.pg_constraint WHERE contype='f';`)\n  ).rows) {\n    const table = tables.get(row.tableOid);\n    const referencedTable = tables.get(row.referencedTableOid);\n    if (table && referencedTable) {\n      const keys = (\n        row.fkey as Array<{\n          column: string;\n          nullable: boolean;\n        }>\n      ).map(({ column, nullable }, idx) => ({\n        column,\n        nullable,\n        referencedColumn: row.rkey[idx] as string,\n        operator: row.ops[idx] as string,\n      }));\n      if (keys.length) {\n        const nullable =\n          keys.some(({ nullable: keyIsNullable }) => keyIsNullable) &&\n          // HACK: the notifications table has complex checks that this script\n          // doesn't understand to know what rows to pull. However, those checks\n          // more-or-less have the property that if an fkey column is non-null,\n          // it needs to remain non-null, so we can just treat all of the notif\n          // table's fkeys as non-nullable.\n          table.name !== 'notifications';\n\n        table.fkeys.push({\n          referencedTable,\n          nullable,\n          keys,\n        });\n      }\n    }\n  }\n\n  // Now copy the table data!\n  for (const table of tables.values()) {\n    await dumpTable(output, pg, table);\n  }\n\n  // We don't need the database anymore. Close the transaction.\n  await pg.query('ROLLBACK');\n\n  // When foreign key columns are nullable, we don't restrict the rows of a\n  // table to those that reference rows that are also copied. Instead we now set\n  // those columns to NULL for rows that reference foreign rows we did not copy.\n  for (const table of tables.values()) {\n    for (const fkey of table.fkeys) {\n      if (fkey.nullable) {\n        output.write(\n          `\\\\echo Fixing dangling foreign keys in ${table.name} (${fkey.keys\n            .map(({ column }) => column)\n            .join(', ')})\\n`,\n        );\n        output.write(`UPDATE ${escapeIdentifier(table.name)} AS _t SET `);\n        output.write(\n          fkey.keys\n            .filter(({ nullable }) => nullable)\n            .map(({ column }) => `${escapeIdentifier(column)}=NULL`)\n            .join(', '),\n        );\n        output.write(` WHERE NOT (${foreignKeyNullCheck('_t', fkey.keys)})`);\n        output.write(\n          ` AND (${fkey.keys\n            .map(({ column }) => `_t.${escapeIdentifier(column)}`)\n            .join(', ')}) NOT IN (SELECT ${fkey.keys\n            .map(({ referencedColumn }) => escapeIdentifier(referencedColumn))\n            .join(', ')} FROM ${escapeIdentifier(\n            fkey.referencedTable.name,\n          )});\\n`,\n        );\n      }\n    }\n  }\n\n  // Our work is done.\n}\n\ntype Table = {\n  oid: number;\n  name: string;\n  columns: string[];\n  fkeys: ForeignKey[];\n  additionalConstraint: ((alias: string) => string) | false | null;\n};\ntype ForeignKey = {\n  referencedTable: Table;\n  keys: ForeignKeyColumn[];\n  nullable: boolean;\n};\ntype ForeignKeyColumn = {\n  column: string;\n  nullable: boolean;\n  referencedColumn: string;\n  operator: string;\n};\n\nlet serial = 0;\nasync function dumpTable(\n  output: NodeJS.WritableStream,\n  pg: Pg.Client,\n  table: Table,\n) {\n  const alias = `t_${serial++}`;\n  const { joins, where } = resolveForeignKeys(table, alias, []);\n\n  const query = `SELECT\n     ${table.columns.map((n) => `${alias}.${escapeIdentifier(n)}`).join(', ')}\n     FROM ${escapeIdentifier(table.name)} ${alias}\n     ${joins.join('\\n')}\n     ${where ? 'WHERE ' : ''}${where}`;\n\n  output.write(\n    `\\\\echo Loading data into table ${table.name}...\n-- ${query.replace(/\\n/g, '\\n-- ')};\n     \\n\\nCOPY ${escapeIdentifier(table.name)} (${table.columns\n       .map(escapeIdentifier)\n       .join(', ')}) FROM stdin;\\n`,\n  );\n\n  await dumpData(pg, query, output);\n\n  output.write('\\\\.\\n\\n\\n');\n}\n\nfunction resolveForeignKeys(\n  table: Table,\n  alias: string,\n  visitedTables: Table[],\n): { joins: string[]; where: string } {\n  if (table.additionalConstraint === false) {\n    return { joins: [], where: 'FALSE' };\n  }\n\n  if (table.name === 'orgs') {\n    const where = `${alias}.id IN ${orgIDsLiteral}`;\n    return { joins: [], where };\n  }\n\n  if (visitedTables.includes(table)) {\n    console.warn(\n      `Foreign keys self-join: ${visitedTables\n        .map((t) => t.name)\n        .join(', ')} => ${table.name}`,\n    );\n    return { where: '', joins: [] };\n  }\n  visitedTables = [...visitedTables, table];\n\n  const where: string[] = [];\n  const joins: string[] = [];\n\n  if (table.additionalConstraint) {\n    // The user activity table is very big. As an additional condition, only\n    // copy over rows from the last 14 days.\n    where.push(`(${table.additionalConstraint(alias)})`);\n  }\n\n  for (const { referencedTable, keys } of table.fkeys.filter(\n    ({ nullable }) => !nullable,\n  )) {\n    if (\n      referencedTable.name === 'orgs' &&\n      keys.length === 1 &&\n      keys[0].referencedColumn === 'id'\n    ) {\n      // If the foreign key references `orgs.id`, we don't have to do the join\n      // at all, we can check the foreign key itself.\n      where.push(\n        `(\n          ${alias}.${escapeIdentifier(keys[0].column)} IS NULL OR\n          ${alias}.${escapeIdentifier(keys[0].column)} IN ${orgIDsLiteral})`,\n      );\n    } else if (referencedTable.additionalConstraint !== false) {\n      const referencedAlias = `j_${serial++}`;\n      const { where: fwhere, joins: fjoins } = resolveForeignKeys(\n        referencedTable,\n        referencedAlias,\n        visitedTables,\n      );\n      if (fwhere) {\n        joins.push(`LEFT OUTER JOIN ${escapeIdentifier(\n          referencedTable.name,\n        )} ${referencedAlias}\n    ON (${keys\n      .map(\n        ({ column, referencedColumn, operator }) =>\n          `${alias}.${escapeIdentifier(\n            column,\n          )} ${operator} ${referencedAlias}.${escapeIdentifier(\n            referencedColumn,\n          )}`,\n      )\n      .join(' AND ')})`);\n        joins.push(...fjoins);\n\n        where.push(`(${foreignKeyNullCheck(alias, keys)} OR (${fwhere}))`);\n      }\n    } else {\n      where.push(foreignKeyNullCheck(alias, keys));\n    }\n  }\n\n  return { where: where.join(' AND '), joins };\n}\n\nfunction foreignKeyNullCheck(alias: string, keys: ForeignKeyColumn[]) {\n  return keys.length === 0\n    ? 'FALSE'\n    : keys.length === 1\n    ? `${alias}.${escapeIdentifier(keys[0].column)} IS NULL`\n    : 'num_nulls(' +\n      keys\n        .map(({ column }) => `${alias}.${escapeIdentifier(column)}`)\n        .join(', ') +\n      ') > 0';\n}\n\nfunction dumpData(pg: Pg.Client, query: string, output: NodeJS.WritableStream) {\n  return new Promise<void>((resolve, reject) => {\n    const stream = pg.query(copyTo(`COPY (${query}) TO STDOUT;`));\n    //stream.pipe(output);\n    stream.on('end', resolve);\n    stream.on('error', reject);\n    stream.on('data', (chunk) => output.write(chunk));\n  });\n}\n\nfunction spawn(\n  command: string,\n  args: string[],\n  env: typeof process.env,\n): Promise<string> {\n  return new Promise<string>((resolve, reject) => {\n    const proc = child_process.spawn(command, args, {\n      stdio: ['ignore', 'pipe', 'inherit'],\n      env,\n    });\n    let stdout = '';\n\n    proc.on('error', reject);\n    proc.on('exit', (code) => {\n      if (code === 0) {\n        resolve(stdout);\n      } else {\n        reject(new Error(`Child process exited with status ${code}`));\n      }\n    });\n    proc.stdout.on('data', (data) => {\n      stdout += data;\n    });\n  });\n}\n", "// This is for important URLs to all kinds of services\n\nexport const TOP_SERVER_HOST = process.env.TOP_SERVER_HOST!;\nexport const APP_SERVER_HOST = process.env.APP_SERVER_HOST!;\nexport const API_SERVER_HOST = process.env.API_SERVER_HOST!;\nexport const API_SERVER_HOST_PRODUCTION =\n  process.env.API_SERVER_HOST_PRODUCTION!;\nexport const ADMIN_SERVER_HOST = process.env.ADMIN_SERVER_HOST!;\nexport const CONSOLE_SERVER_HOST = process.env.CONSOLE_SERVER_HOST!;\nexport const MARKETING_SERVER_HOST = process.env.MARKETING_SERVER_HOST!;\nexport const CORD_TO_HOST = process.env.CORD_TO_HOST!;\nexport const AUTH0_CUSTOM_LOGIN_DOMAIN = process.env.AUTH0_CUSTOM_LOGIN_DOMAIN!;\nexport const DOCS_SERVER_HOST = process.env.DOCS_SERVER_HOST!;\nexport const SLACK_APP_REDIRECT_HOST = process.env.SLACK_APP_REDIRECT_HOST;\n\nexport const TOP_ORIGIN = 'https://' + process.env.TOP_SERVER_HOST;\nexport const APP_ORIGIN = 'https://' + process.env.APP_SERVER_HOST;\nexport const API_ORIGIN = 'https://' + process.env.API_SERVER_HOST;\nexport const ADMIN_ORIGIN = 'https://' + process.env.ADMIN_SERVER_HOST;\nexport const CONSOLE_ORIGIN = 'https://' + process.env.CONSOLE_SERVER_HOST;\nexport const MARKETING_ORIGIN = 'https://' + process.env.MARKETING_SERVER_HOST;\nexport const CORD_TO_ORIGIN = 'https://' + process.env.CORD_TO_HOST;\nexport const AUTH0_ORIGIN = 'https://' + process.env.AUTH0_CUSTOM_LOGIN_DOMAIN;\nexport const DOCS_ORIGIN = 'https://' + process.env.DOCS_SERVER_HOST;\nexport const DOCS_AI_CHATBOT_SERVER_HOST =\n  process.env.DOCS_AI_CHATBOT_SERVER_HOST;\nexport const COMMUNITY_ORIGIN = 'https://' + process.env.COMMUNITY_SERVER_HOST;\n\n// See https://github.com/getcord/interactive-demos\nexport const DEMO_APPS_WEBHOOK_URL =\n  'https://cord-interactive-demos.vercel.app/events';\n", "import { DOCS_ORIGIN } from 'common/const/Urls.ts';\n\nexport const SUPPORT_USER_UUID = 'c9a61e1d-7c8a-4c7e-838a-9d431cf4ed77';\nexport const RADICAL_ORG_ID = '6bba8678-b14e-4af7-b2f2-05ee807dfa82';\nexport const RADICAL_TEST_ORG_ID = '3689f86d-0c70-40de-a2f0-a4a9ea4994e3';\nexport const CORD_PLATFORM_ORG_ID = '746c0b57-7363-4766-9ee9-7ae8ec7531a8';\nexport const CORD_ADMIN_PLATFORM_ORG_ID =\n  '84ae9086-8414-4ed3-ab73-096e6438f095';\nexport const CORD_SDK_TEST_ORG_ID = 'edda098d-6db7-4202-a5ac-ff3293b78c47';\nexport const GILLIAN_TEST_SLACK_ORG_ID = 'f7ab9ab8-f5b2-41a4-a419-1b8076626d3f';\nexport const KAT_TEST_SLACK_ORG_ID = '4506fadd-f8dc-4795-9b5d-d28feda39d84';\nexport const CORD_SLACK_TEAM_ID = 'T012Y0TBQLW'; // radicalhqworkspace\nexport const CORD_TEST_SLACK_TEAM_ID = 'T015UJY6YQK'; // radicaltestorg\n\nexport const SLACK_APP_CLIENT_ID = '1100027398710.1180115520790';\nexport const SLACK_APP_ID = 'A015A3DFAP8';\nexport const SLACK_DEV_APP_CLIENT_ID = '1198644236835.1943446227956';\nexport const SLACK_ADMIN_LOGIN_APP_CLIENT_ID = '1100027398710.2437628320357';\nexport const SLACK_ADMIN_LOGIN_APP_ID = 'A02CVJG9EAH';\nexport const SLACK_DEV_APP_ID = 'A01TRD46PU4';\nexport const SLACK_INTERNAL_TOOLS_APP_ID = 'A04JKM945CM';\nexport const CORD_UPDATES_TEST_CHANNEL_ID = 'C0547K3V868';\n\n// As opposed to e.g. a customer's Slack app\nexport const CORD_SLACK_APP_IDS = [\n  SLACK_APP_ID,\n  SLACK_DEV_APP_ID,\n  SLACK_ADMIN_LOGIN_APP_ID,\n  SLACK_INTERNAL_TOOLS_APP_ID,\n];\n\nexport const CORD_APPLICATION_ID = '5a076ee9-8b9e-4156-9ac4-871bdc4569ec';\nexport const CORD_SDK_TEST_APPLICATION_ID =\n  'b6501bf5-46f7-4db7-9996-c42dd9f758b0';\nexport const CORD_SAMPLE_TOKEN_CUSTOMER_ID =\n  '1c367aca-37c9-4733-8bef-e9f11a7d0f17';\nexport const CORD_DEMO_APPS_TOKEN_CUSTOMER_ID =\n  '4383cf39-8b6a-4c33-9d8a-71567ed47a60';\nexport const CORD_DOCS_SAMPLE_TOKEN_APPLICATION_ID =\n  'aeb2797f-f0a3-485c-a317-4986e2c8343b';\nexport const CORD_AUTOMATED_TESTS_APPLICATION_ID =\n  'dfa86152-9e7e-4d2d-acd6-bfddef71f58e';\nexport const CLACK_APPLICATION_ID = '5fa22ba9-5446-4af8-bc93-7ce54a9aa0ba';\nexport const CORD_HOMEPAGE_APPLICATION_ID =\n  '29e6499a-bbed-4eb2-b057-b36d60ad76c9';\nexport const AUTH0_CLIENT_ID = process.env.AUTH0_CLIENT_ID!;\n\nexport const CORD_CUSTOMER_ID = '12ed6251-28d5-4686-9a75-20a15bd31499';\n\nexport const CSS_CUSTOMIZATION_ON_DOCS_PREFIX = 'css-customization-';\nexport const BETA_V2_DOCS_PREFIX = 'beta2-';\nexport const LIVE_CSS_ON_DOCS_THREAD_ID_PREFIX = 'live-css-docs-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_THREAD_ID_PREFIX =\n  'live-component-docs-thread-';\nexport const LIVE_COMPONENT_INBOX_THREAD_ID_PREFIX =\n  'live_component-docs-inbox-thread-';\nexport const LIVE_COMPONENT_INBOX_LAUNCHER_THREAD_ID_PREFIX =\n  'live_component-docs-inbox-launcher-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_COMPOSER_THREAD_ID_PREFIX =\n  'live-component-docs-composer-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_MESSAGE_THREAD_ID_PREFIX =\n  'live-component-docs-message-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_MESSAGE_CONTENT_THREAD_ID_PREFIX =\n  'live-component-docs-message-content-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_PIN_THREAD_ID_PREFIX =\n  'live-component-docs-pin-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_REACTIONS_THREAD_ID_PREFIX =\n  'live-component-docs-reactions-thread-';\nexport const LIVE_COMPONENT_ON_DOCS_EXTERNAL_NOTIFICATION_PREFIX =\n  'live-component-docs-external-notification-';\nexport const LIVE_CUSTOMIZATION_ON_DOCS_REPLACEMENTS_THREAD_ID_PREFIX =\n  'live-customization-docs-replacements-thread-';\nexport const DOCS_TOKEN_KEY = 'docs-token';\n\nexport const LIVE_COMPONENT_ON_DOCS_NO_AVATAR_USER_ID = 'noavatar';\n\nexport const DOCS_LIVE_PAGE_LOCATIONS = {\n  cssCustomization: 'css-customization',\n  liveCss: 'live-css-docs',\n  liveThread: 'live-thread',\n  liveThreadList: 'live-thread-list',\n  livePin: 'live-pin',\n  livePinChartExample: 'live-pin-chart-example',\n  liveFloatingThreads: 'live-floating-threads',\n  liveSelectionComments: 'live-selection-comments',\n  liveSidebar: 'live-sidebar',\n  liveInbox: 'live-inbox',\n  liveInboxLauncher: 'live-inbox-launcher',\n  liveSidebarLauncher: 'live-sidebar-launcher',\n  livePagePresence: 'live-page-presence',\n  livePresenceFacepile: 'live-presence-facepile',\n  liveComposer: 'live-composer',\n  liveMessage: 'live-message',\n  liveMessageContent: 'live-message-content',\n  liveNotificationList: 'live-notification-list',\n  liveThreadedComments: 'live-threaded-comments',\n  liveReactions: 'live-reactions',\n  liveReplacementsTutorial: 'live-replacements-tutorial',\n  liveBetaV2Thread: 'live-beta-v2-thread',\n  liveBetaV2Threads: 'live-beta-v2-threads',\n};\n\nexport const CORD_DOCS_CLIENT_TOKEN = '__cord_docs_token__';\n\nexport const DOCS_URLS = {\n  tutorials: {\n    getProductionReady: {\n      addYourBranding: `${DOCS_ORIGIN}/get-started/live-css-editor`,\n    },\n    integrationGuide: `${DOCS_ORIGIN}/get-started/integration-guide`,\n    demoApps: `${DOCS_ORIGIN}/get-started/demo-apps`,\n  },\n  components: {\n    thread: `${DOCS_ORIGIN}/components/cord-thread`,\n    threadList: `${DOCS_ORIGIN}/components/cord-thread-list`,\n    threadedComments: `${DOCS_ORIGIN}/components/cord-threaded-comments`,\n    sidebar: `${DOCS_ORIGIN}/components/cord-sidebar`,\n    inbox: `${DOCS_ORIGIN}/components/cord-inbox`,\n    inboxLauncher: `${DOCS_ORIGIN}/components/cord-inbox-launcher`,\n    sidebarLauncher: `${DOCS_ORIGIN}/components/cord-sidebar-launcher`,\n    composer: `${DOCS_ORIGIN}/components/cord-composer`,\n    message: `${DOCS_ORIGIN}/components/cord-message`,\n    messageContent: `${DOCS_ORIGIN}/components/cord-message-content`,\n    reactions: `${DOCS_ORIGIN}/components/cord-reactions`,\n  },\n  howTo: {\n    customThreadedComments: `${DOCS_ORIGIN}/customization/custom-threaded-comments`,\n    cssCustomization: `${DOCS_ORIGIN}/customization/css`,\n    replacements: `${DOCS_ORIGIN}/customization/custom-react-components/tutorial`,\n  },\n  getStarted: {\n    authenticateYourUser: `${DOCS_ORIGIN}/get-started/integration-guide/generate-an-auth-token`,\n  },\n  betaV2Components: {\n    threads: `${DOCS_ORIGIN}/components/cord-threads?version=2.0`,\n    thread: `${DOCS_ORIGIN}/components/cord-thread?version=2.0`,\n  },\n};\n\nexport const CORD_DEV_CONSOLE_LOGGING_SLACK_CHANNEL_ID = 'C05FAVBSSN7';\nexport const CORD_SELF_SERVE_SLACK_CHANNEL_ID = 'C05GR4WSV5Z';\n\n// Tokens created for the sample token and demo apps environment types both\n// create groups with this id.  Both of them need to use the same groupID because\n// it is hardcoded into the demo apps client code, and while the demo apps mostly\n// use the demo apps environment apps, they sometimes use sample app tokens.\nexport const DEMO_APPS_APP_GROUP_ID = 'my-first-group';\n", "import { hostname, userInfo } from 'os';\nimport { serializeError } from 'serialize-error';\nimport winston from 'winston';\nimport WinstonCloudWatch from 'winston-cloudwatch';\nimport Transport from 'winston-transport';\nimport * as Sentry from '@sentry/node';\nimport { ApplicationEntity } from 'server/src/entity/application/ApplicationEntity.ts';\nimport '@sentry/tracing';\n\nimport env from 'server/src/config/Env.ts';\nimport { flatFormat } from 'server/src/logging/flatFormat.ts';\nimport packageData from 'package.json';\nimport { Counter } from 'server/src/logging/prometheus.ts';\nimport type { JsonObject } from 'common/types/index.ts';\nimport { Viewer } from 'server/src/auth/index.ts';\nimport { CordError } from 'server/src/util/CordError.ts';\n\n// Our build process replaces `BUILDCONSTANTS.loggingProcessName` with an\n// appropriate string (e.g. 'server' or 'asyncWorker') and\n// `BUILDCONSTANTS.sentryDSN` with either `undefined` or a string value for a\n// Sentry DSN\ndeclare const BUILDCONSTANTS: {\n  loggingProcessName: string;\n  sentryDSN: undefined | string;\n};\n\n// The loglevel for the console output can be specified using the environment\n// variable `LOGLEVEL`\nconst logLevel = env.LOGLEVEL;\n\nconst defaultMeta: any = {\n  process: BUILDCONSTANTS.loggingProcessName,\n  serverVersion: packageData.version,\n  serverGitCommit: process.env.COMMIT_HASH || process.env.npm_package_gitHead,\n  serverHost: hostname(),\n};\n\nif (process.env.CORD_WORKER_NAME) {\n  defaultMeta.workerName = process.env.CORD_WORKER_NAME;\n}\n\n// Sentry logging\nconst sentryLogging = !!(BUILDCONSTANTS.sentryDSN && env.SENTRY_ENVIRONMENT);\nif (sentryLogging) {\n  Sentry.init({\n    dsn: BUILDCONSTANTS.sentryDSN,\n    environment: env.SENTRY_ENVIRONMENT,\n    release: env.SENTRY_RELEASE,\n    tracesSampleRate: parseFloat(env.SENTRY_TRACE_SAMPLE_RATE ?? '0'),\n    attachStacktrace: true,\n    normalizeDepth: 10,\n  });\n}\n\n// Winston logging\nconst winstonLogger = winston.createLogger({ defaultMeta });\n\nwinstonLogger.add(\n  new winston.transports.Console({\n    level: logLevel,\n    format: winston.format.combine(winston.format.timestamp(), flatFormat()),\n    handleExceptions: true,\n  }),\n);\n\n// Keep track of logging in a Prometheus metric. The cleanest way to do this is\n// by adding a separate transport, because that allows us to set the loglevel\n// for this independently. No matter what `env.LOGLEVEL` is set to, the\n// Prometheus metric keeps track of *all* log messages, even the 'silly' ones.\n// ('silly' is the name of the lowest loglevel in Prometheus.)\nconst counter = Counter({\n  name: 'ServerLogging',\n  help: 'Number of log messages emitted by server',\n  labelNames: ['level'],\n});\n\nconst LEVEL = Symbol.for('level');\nclass MetricLogger extends Transport {\n  log(info: any, next: () => void) {\n    counter.inc({ level: info[LEVEL] });\n    next();\n  }\n}\n\nexport type LoggingTags = { [tag: string]: number | string | boolean };\n\nwinstonLogger.add(new MetricLogger({ level: 'silly' }));\n\n// CloudWatch logging is configured via the environment\nlet winstonCW: WinstonCloudWatch | undefined = undefined;\nif (env.CLOUDWATCH_LOGLEVEL && !process.env.IS_TEST) {\n  if (!env.CLOUDWATCH_LOG_GROUP_NAME) {\n    throw new Error(\n      `CloudWatch logging is enabled (CLOUDWATCH_LOGLEVEL is set), so\n       CLOUDWATCH_LOG_GROUP_NAME must be provided, too!`,\n    );\n  }\n\n  // CloudWatch stream names must not contain ':' or '*' characters\n  const defaultStreamName = () =>\n    `${new Date().toISOString().replace(/:/g, '.')} ${\n      userInfo().username\n    } ${hostname()}(${process.pid})`;\n\n  winstonCW = new WinstonCloudWatch({\n    // \"name\" is optional with default value \"CloudWatch\" but the\n    // typedefinition has name as required. See\n    // https://githubmemory.com/repo/lazywithclass/winston-cloudwatch/issues/155\n    name: 'CloudWatch',\n    level: env.CLOUDWATCH_LOGLEVEL,\n    logGroupName: env.CLOUDWATCH_LOG_GROUP_NAME,\n    logStreamName: env.CLOUDWATCH_LOG_STREAM_NAME || defaultStreamName(),\n    awsRegion: env.CLOUDWATCH_AWS_REGION,\n    jsonMessage: true,\n  });\n  winstonLogger.add(winstonCW);\n} else {\n  if (env.CLOUDWATCH_LOG_GROUP_NAME || env.CLOUDWATCH_LOG_STREAM_NAME) {\n    throw new Error(\n      `Some CLOUDWATCH_* variables are set, but CLOUDWATCH_LOGLEVEL is not.`,\n    );\n  }\n}\n\nexport function flushAndCloseWinstonCloudWatch() {\n  if (winstonCW) {\n    return new Promise<void>((resolve, _reject) => {\n      winstonCW!.kthxbye((_err) => resolve());\n    });\n  } else {\n    return undefined;\n  }\n}\n\nconst SENTRY_LOG_LEVEL: Record<string, Sentry.SeverityLevel | undefined> = {\n  error: 'error',\n  warn: 'warning',\n};\n\nconst cleanupSequelizeError = (error: any) => {\n  // remove references to the instance object as they contain deep SQL information\n  // like db password, etc\n  const suberrors = error.errors;\n  if (Array.isArray(suberrors)) {\n    // eslint-disable-next-line @typescript-eslint/no-shadow -- Disabling for pre-existing problems. Please do not copy this comment, and consider fixing this one!\n    suberrors.forEach((error) => delete error.instance);\n  }\n};\n\nconst MAX_ORG_IDS_TO_LOG = 50;\n\nexport class Logger {\n  private readonly truncatedViewer: Record<string, unknown>;\n  private readonly metadata: JsonObject;\n  private appName: string | undefined;\n\n  constructor(viewer: Viewer, additionalMeta?: JsonObject) {\n    this.truncatedViewer = { ...viewer };\n    this.metadata = { ...defaultMeta, ...additionalMeta };\n\n    if (\n      viewer.relevantOrgIDs &&\n      viewer.relevantOrgIDs.length > MAX_ORG_IDS_TO_LOG\n    ) {\n      this.truncatedViewer.relevantOrgIDs = [\n        ...viewer.relevantOrgIDs.slice(0, MAX_ORG_IDS_TO_LOG),\n        `(truncated from ${viewer.relevantOrgIDs.length} orgs)`,\n      ];\n    }\n\n    void this.addAppName(viewer);\n  }\n\n  public childLogger(viewer: Viewer, additionalMeta?: JsonObject) {\n    return new Logger(viewer, { ...this.metadata, ...additionalMeta });\n  }\n\n  private viewerToLog() {\n    return {\n      ...this.truncatedViewer,\n      ...(this.appName && { appName: this.appName }),\n    };\n  }\n\n  public log(\n    level: 'debug' | 'info' | 'warn' | 'error',\n    message: string,\n    meta?: JsonObject,\n    options?: { sentryFingerPrint?: string[] },\n  ) {\n    if (sentryLogging && !process.env.IS_TEST) {\n      const sentryLevel = SENTRY_LOG_LEVEL[level];\n      if (sentryLevel) {\n        const sentryEventID = Sentry.captureMessage(message, {\n          level: sentryLevel,\n          extra: { ...defaultMeta, ...meta },\n          tags: { loggingProcessName: BUILDCONSTANTS.loggingProcessName },\n          fingerprint: options?.sentryFingerPrint,\n          user: this.viewerToLog(),\n        });\n        meta = { ...this.metadata, ...meta, sentryEventID };\n      }\n    }\n\n    winstonLogger.log(level, message, {\n      viewer: this.viewerToLog(),\n      ...this.metadata,\n      ...meta,\n    });\n  }\n\n  public debug(\n    message: string,\n    meta?: JsonObject,\n    options?: { sentryFingerPrint?: string[] },\n  ) {\n    this.log('debug', message, meta, options);\n  }\n\n  public info(\n    message: string,\n    meta?: JsonObject,\n    options?: { sentryFingerPrint?: string[] },\n  ) {\n    this.log('info', message, meta, options);\n  }\n\n  public warn(\n    message: string,\n    meta?: JsonObject,\n    options?: { sentryFingerPrint?: string[] },\n  ) {\n    this.log('warn', message, meta, options);\n  }\n\n  public error(\n    message: string,\n    meta?: JsonObject,\n    options?: { sentryFingerPrint?: string[] },\n  ) {\n    this.log('error', message, meta, options);\n  }\n\n  public logLoggerInfo() {\n    this.info(\n      `Logging through winston. Console log level set to \"${logLevel}\", CloudWatch logging is ${\n        env.CLOUDWATCH_LOGLEVEL === undefined\n          ? 'disabled'\n          : `set to \"${env.CLOUDWATCH_LOGLEVEL}\"`\n      }`,\n    );\n  }\n\n  /**\n  Useful when dealing with promises:\n\n  ```\n  promise.catch(exceptionLogger('something broke'))\n  ```\n*/\n  public exceptionLogger =\n    (message: string, meta?: JsonObject, tags?: LoggingTags) => (error: any) =>\n      this.logException(\n        message,\n        error,\n        { ...this.metadata, ...meta },\n        tags,\n        'error',\n      );\n\n  /**\n  To be used imperatively:\n\n  ```\n  try {\n    // ...\n  } catch (e) {\n    logException('something broke', e)\n  }\n  ```\n*/\n  public logException(\n    message: string,\n    error: any,\n    meta?: JsonObject,\n    tags?: LoggingTags,\n    level: 'debug' | 'info' | 'warn' | 'error' = 'error',\n  ) {\n    // Make a good effort to produce a nice error log message from the given\n    // `message`, `error` (and optionally `meta`), but make sure that those\n    // efforts don't sabotage the logging, i.e. if something throws on the way,\n    // catch the error and make sure _something_ gets logged.\n    if (error.name?.startsWith('Sequelize')) {\n      cleanupSequelizeError(error);\n    }\n\n    let serializedError: any = undefined;\n    try {\n      serializedError = serializeError(error, { maxDepth: 50 });\n    } catch (e) {\n      winstonLogger.log(\n        level,\n        `logException: serializeError threw an exception (${message})`,\n        {\n          error: `${error}`,\n          viewer: this.viewerToLog(),\n          ...this.metadata,\n          ...meta,\n        },\n      );\n    }\n\n    if (serializedError !== undefined) {\n      // If serializing the error above failed, we have already logged a simple\n      // error representation to Winston above.\n      if (!message) {\n        try {\n          message = `${serializedError.name}: ${serializedError.message}`;\n        } catch (e) {\n          message = `${serializedError}`;\n        }\n      }\n\n      winstonLogger.log(level, message, {\n        error: serializedError,\n        viewer: this.viewerToLog(),\n        ...this.metadata,\n        ...meta,\n      });\n    }\n\n    if ((level === 'warn' || level === 'error') && !process.env.IS_TEST) {\n      Sentry.withScope((scope) => {\n        scope.setTags({\n          ...(error instanceof CordError && error.loggingTags),\n          ...tags,\n        });\n        // serializedError is undefined, if serializing failed\n        if (serializedError && error instanceof CordError) {\n          // Remove these properties, they'll get attached under other names\n          delete serializedError.loggingMetadata;\n          delete serializedError.loggingTags;\n        }\n        scope.setExtra('error', serializedError);\n\n        scope.setExtra('message', message);\n        scope.setExtra('meta', {\n          ...this.metadata,\n          ...(error instanceof CordError && error.loggingMetadata),\n          ...meta,\n        });\n        scope.setExtra('user', this.viewerToLog());\n\n        // We hand the original error object to Sentry\n        Sentry.captureException(error, {\n          level: SENTRY_LOG_LEVEL[level],\n        });\n      });\n    }\n  }\n\n  private async addAppName(viewer: Viewer) {\n    if (!viewer?.platformApplicationID) {\n      return;\n    }\n\n    const app = await ApplicationEntity.findByPk(viewer.platformApplicationID);\n    this.appName = app?.name;\n  }\n}\n\nlet _anonymousLogger: Logger | undefined = undefined;\nexport function anonymousLogger() {\n  if (_anonymousLogger === undefined) {\n    _anonymousLogger = new Logger(Viewer.createAnonymousViewer());\n  }\n  return _anonymousLogger;\n}\n", "import { Table, Column, Model } from 'sequelize-typescript';\nimport type { CreationOptional } from 'sequelize';\nimport { DataTypes } from 'sequelize';\nimport type {\n  UUID,\n  CustomLinks,\n  CustomNUX,\n  ApplicationEnvironment,\n} from 'common/types/index.ts';\nimport { getTypedFeatureFlagValue } from 'server/src/featureflags/index.ts';\nimport { FeatureFlags } from 'common/const/FeatureFlags.ts';\n\nexport type CustomEmailTemplate = {\n  partnerName: string;\n  imageURL: string;\n  sender?: string;\n  logoConfig?: { height: string; width: string };\n};\n\nexport type ApplicationTierType = 'free' | 'starter' | 'premium';\n\nexport type CustomSlackAppDetails = {\n  clientID: string;\n  clientSecret: string;\n  signingSecret: string;\n};\n\n@Table({\n  tableName: 'applications',\n  timestamps: false,\n})\nexport class ApplicationEntity extends Model {\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n    primaryKey: true,\n    defaultValue: DataTypes.UUIDV4,\n  })\n  id!: UUID;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: false,\n  })\n  name!: string;\n\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  sharedSecret!: string;\n\n  @Column({ type: DataTypes.TIME })\n  createdTimestamp!: CreationOptional<Date>;\n\n  @Column({\n    type: DataTypes.JSONB,\n  })\n  customEmailTemplate!: CustomEmailTemplate | null;\n\n  @Column({\n    type: DataTypes.BOOLEAN,\n    defaultValue: true,\n  })\n  enableEmailNotifications!: boolean;\n\n  @Column({\n    type: DataTypes.JSONB,\n  })\n  customLinks!: CustomLinks | null;\n\n  @Column({\n    type: DataTypes.UUID,\n    defaultValue: null,\n  })\n  customS3Bucket!: UUID | null; // the s3 bucket to be used for this application\n\n  @Column({\n    type: DataTypes.TEXT,\n    defaultValue: null,\n  })\n  segmentWriteKey!: string | null; // the Segment Write key we use to write partner events\n\n  @Column({\n    type: DataTypes.JSONB,\n  })\n  customNUX!: CustomNUX | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  iconURL!: string | null;\n\n  @Column({\n    type: DataTypes.ENUM('free', 'starter', 'premium'),\n    defaultValue: 'free',\n    allowNull: false,\n  })\n  type!: ApplicationTierType;\n\n  @Column({\n    type: DataTypes.ENUM(\n      'production',\n      'staging',\n      'sample',\n      'sampletoken',\n      'demo',\n    ),\n    defaultValue: 'production',\n    allowNull: false,\n  })\n  environment!: ApplicationEnvironment;\n\n  @Column({\n    type: DataTypes.UUID,\n  })\n  supportOrgID!: UUID | null;\n\n  @Column({\n    type: DataTypes.UUID,\n  })\n  supportBotID!: UUID | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  supportSlackChannelID!: string | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  redirectURI!: string | null;\n\n  @Column({\n    type: DataTypes.UUID,\n    defaultValue: null,\n  })\n  customerID!: UUID;\n\n  @Column({\n    type: DataTypes.BOOLEAN,\n    defaultValue: false,\n  })\n  slackConnectAllOrgs!: boolean;\n\n  @Column({\n    type: DataTypes.STRING,\n    defaultValue: null,\n  })\n  eventWebhookURL!: string | null;\n\n  @Column({\n    type: DataTypes.ARRAY(DataTypes.TEXT),\n    defaultValue: null,\n  })\n  eventWebhookSubscriptions!: string[] | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n    defaultValue: null,\n  })\n  customSlackAppID!: string | null;\n\n  @Column({\n    type: DataTypes.JSONB,\n    defaultValue: null,\n  })\n  customSlackAppDetails!: CustomSlackAppDetails | null;\n\n  public async isSupportChatEnabled(): Promise<boolean> {\n    const isSupportFlagEnabled = await getTypedFeatureFlagValue(\n      FeatureFlags.SUPPORT_CHAT_ENABLED,\n      {\n        userID: 'anonymous',\n        orgID: undefined,\n        platformApplicationID: this.id,\n        version: null,\n        customerID: this.customerID,\n      },\n    );\n\n    return Boolean(\n      isSupportFlagEnabled &&\n        this.supportBotID &&\n        this.supportOrgID &&\n        this.supportSlackChannelID,\n    );\n  }\n\n  public getCustomSlackAppDetails(): CustomSlackAppDetails | null {\n    const details = this.customSlackAppDetails;\n\n    if (\n      details &&\n      typeof details === 'object' &&\n      !Array.isArray(details) &&\n      typeof details.clientID === 'string' &&\n      typeof details.clientSecret === 'string' &&\n      typeof details.signingSecret === 'string'\n    ) {\n      return {\n        clientID: details.clientID,\n        clientSecret: details.clientSecret,\n        signingSecret: details.signingSecret,\n      };\n    }\n    return null;\n  }\n}\n", "import * as LaunchDarkly from '@launchdarkly/node-server-sdk';\nimport type {\n  ApplicationEnvironment,\n  SimpleValue,\n  UUID,\n} from 'common/types/index.ts';\nimport env from 'server/src/config/Env.ts';\nimport type { RequestContext } from 'server/src/RequestContext.ts';\nimport { FeatureFlags as CommonFeatureFlags } from 'common/const/FeatureFlags.ts';\nimport type { FeatureFlag } from 'common/const/FeatureFlags.ts';\nimport type { Viewer } from 'server/src/auth/index.ts';\nimport type { ApplicationEntity } from 'server/src/entity/application/ApplicationEntity.ts';\nimport {\n  DEFAULT_MENTION_NOTIFICATION_V2_TEMPLATE_ID,\n  DEFAULT_SHARE_TO_EMAIL_TEMPLATE_ID,\n  DEFAULT_THREAD_RESOLVE_TEMPLATE_ID,\n} from 'server/src/email/index.ts';\n\nlet client: LaunchDarkly.LDClient | undefined = undefined;\nlet clientReady = false;\n\n// ADD NEW FLAGS HERE IF THEY ARE ONLY USED SERVER-SIDE.\n// If the new flag is also going to be used client side (in external/)\n// then add your new flag in common/const/FeatureFlags.ts\n//\n// See more explanation on how to define in flags in:\n// common/const/FeatureFlags.ts\nconst ServerOnlyFeatureFlags = {\n  QUERY_PARAM_DEEP_LINKS: {\n    key: 'query_param_deep_links',\n    defaultValue: false,\n  } as FeatureFlag<'query_param_deep_links', boolean>,\n  NOTIFY_PAGE_VISITORS_OF_EVERY_MESSAGE: {\n    key: 'notify_page_visitors_of_every_new_message',\n    defaultValue: false,\n  } as FeatureFlag<'notify_page_visitors_of_every_new_message', boolean>,\n  USER_IS_BLOCKED: {\n    key: 'user_is_blocked',\n    defaultValue: false,\n  } as FeatureFlag<'user_is_blocked', boolean>,\n  SHOW_CORD_COPY_IN_TASKS: {\n    key: 'show-cord-copy-in-tasks',\n    defaultValue: true,\n  } as FeatureFlag<'show-cord-copy-in-tasks', boolean>,\n  LOADER_CACHES: {\n    key: 'loader_caches',\n    defaultValue: true,\n  } as FeatureFlag<'loader_caches', boolean>,\n  SUBSCRIBE_ALL_ORG_MEMBERS: {\n    key: 'subscribe_all_org_members',\n    defaultValue: false,\n  },\n  WRITE_TO_EVENTS_TABLE: {\n    key: 'write_to_events_table',\n    defaultValue: true,\n  },\n  ALLOW_MAGIC_GRAPHQL_ORG_ID_OVERRIDE: {\n    key: 'allow-magic-graph-ql-org-id-override',\n    defaultValue: true,\n  },\n  GRANULAR_PERMISSIONS: {\n    key: 'granular-permissions',\n    defaultValue: false,\n  },\n  SKIP_PUBLISH_USER_IDENTITY_UPDATE: {\n    key: 'skip_publish_user_identity_update',\n    defaultValue: false,\n  },\n  RATE_LIMITS: {\n    key: 'rate_limits',\n    defaultValue: { maxCount: 50000, seconds: 5 * 60 },\n  },\n  EMAIL_NOTIFICATION_TEMPLATE_ID: {\n    key: 'email-notification-template-id',\n    defaultValue: {\n      mention: DEFAULT_MENTION_NOTIFICATION_V2_TEMPLATE_ID,\n      share_to_email: DEFAULT_SHARE_TO_EMAIL_TEMPLATE_ID,\n      thread_resolve: DEFAULT_THREAD_RESOLVE_TEMPLATE_ID,\n    },\n  },\n} as const;\n\nexport const FeatureFlags = {\n  ...CommonFeatureFlags,\n  ...ServerOnlyFeatureFlags,\n} as const satisfies {\n  [key: string]: FeatureFlag<string, SimpleValue | object>;\n};\n\ntype MockClient =\n  | undefined\n  | ((\n      key: string,\n      user: FlagsUser,\n    ) => Promise<boolean | string | number | null>);\n// This is used in our test environments\nlet mockClient: MockClient;\n\nexport async function initFeatureFlags() {\n  if (client) {\n    throw new Error('Feature flags already initialized');\n  }\n  if (!env.LAUNCHDARKLY_API_KEY) {\n    return;\n  }\n  client = LaunchDarkly.init(env.LAUNCHDARKLY_API_KEY);\n  await client.waitForInitialization();\n  clientReady = true;\n}\n\nexport function closeFeatureFlags() {\n  if (client) {\n    client.close();\n    client = undefined;\n    clientReady = false;\n  }\n}\n\nexport type FlagsUser = {\n  userID: UUID | 'anonymous';\n  orgID?: UUID;\n  platformApplicationID: UUID | 'extension' | 'console';\n  version: string | null;\n  customerID?: UUID;\n  appEnvironment?: ApplicationEnvironment;\n};\n\n/**\n * Prefer flagsUserFromContext if you have a full context, as it has more info\n * in it.\n */\nexport function flagsUserFromViewer(viewer: Viewer): FlagsUser {\n  return {\n    userID: viewer.userID ?? 'anonymous',\n    orgID: viewer.orgID,\n    platformApplicationID: viewer.platformApplicationID ?? 'extension',\n    version: null,\n  };\n}\n\nexport function flagsUserFromContext(context: RequestContext): FlagsUser {\n  return {\n    ...flagsUserFromViewer(context.session.viewer),\n    version: context.clientVersion,\n    customerID: context.application?.customerID,\n  };\n}\n\n/**\n * For the REST API etc where there isn't a user. Prefer one of the other\n * functions if there is a user.\n */\nexport function flagsUserFromApplication(app: ApplicationEntity): FlagsUser {\n  return {\n    userID: 'anonymous',\n    platformApplicationID: app.id,\n    version: null,\n    customerID: app.customerID,\n  };\n}\n\n/**\n * Returns the value of the given feature flag in LaunchDarkly for the given\n * user, or the default value if LaunchDarkly cannot be reached for any reason.\n */\nexport async function getTypedFeatureFlagValue<\n  K extends (typeof FeatureFlags)[keyof typeof FeatureFlags]['key'],\n  T,\n>(feature: FeatureFlag<K, T>, user: FlagsUser): Promise<T> {\n  const value = (await getFeatureFlagValue(feature.key, user)) as T | null;\n  return value === null ? feature.defaultValue : value;\n}\n\nexport async function getFeatureFlagValue(key: string, user: FlagsUser) {\n  // To allow us to mock feature flags for our tests\n  if (mockClient) {\n    return await mockClient(key, user);\n  }\n  if (!client || !clientReady) {\n    return null;\n  }\n  const versionValue = versionToNumber(user.version);\n  const ldUser = {\n    // The choice of delimiter here is restricted by LaunchDarkly's website\n    // currently being flaky for users with a key that contains characters that\n    // need to be percent-encoded, so we need to choose something that doesn't\n    // get encoded.\n    key: user.orgID ? `${user.userID}_${user.orgID}` : user.userID,\n    custom: {\n      userID: user.userID,\n      ...(user.orgID && { orgID: user.orgID }),\n      platformApplicationID: user.platformApplicationID,\n      ...(versionValue && { version: versionValue }),\n      ...(user.customerID && { customerID: user.customerID }),\n      ...(user.appEnvironment && { appEnvironment: user.appEnvironment }),\n    },\n  };\n  return await (client.variation(key, ldUser, null) as Promise<\n    boolean | string | number | null\n  >);\n}\n\nfunction versionToNumber(version: string | null): number | null {\n  if (!version) {\n    return null;\n  }\n  if (version.startsWith('dev-')) {\n    return -1;\n  }\n  const match = version.match(/^(\\d+)[.](\\d+)[.](\\d+)$/);\n  if (!match) {\n    return null;\n  }\n  return 100000 * (parseInt(match[1], 10) - 1) + parseInt(match[2], 10);\n}\n\nexport function initMockFeatureFlagForTest(fn: MockClient) {\n  mockClient = fn;\n}\n", "// There is some TypeScript trickery in this file. It is optimised for making\n// the use of `magicEnv` look good. The call to `magicEnv` should look readable\n// and self-explanatory, and the type hints displayed by the IDE should be\n// useful.\n\n// Define types to declare variables as required, optional or having a default\n// value.  If these classes were empty, TypeScript would treat them as\n// interchangeable. By giving them different shapes (i.e. different members),\n// TypeScript will keep them apart.\nclass RequiredVariable {\n  public readonly req = true;\n}\nclass OptionalVariable {\n  public readonly opt = true;\n}\nclass VariableWithDefaultValue {\n  constructor(public readonly defaultValue: string) {}\n}\n\n// These are the helpers that are used by the caller of `magicEnv` to define\n// their environment fields.\nexport const required = new RequiredVariable();\nexport const optional = new OptionalVariable();\n// eslint-disable-next-line @typescript-eslint/no-shadow -- Disabling for pre-existing problems. Please do not copy this comment, and consider fixing this one!\nexport const defaultValue = (defaultValue: string) =>\n  new VariableWithDefaultValue(defaultValue);\n\n// Here comes the main function of this module: `magicEnv`. It takes one\n// parameter: a JavaScript object with string keys and values of type\n// RequiredVariable, OptionalVariable or VariableWithDefaultValue.\n//\n// `magicEnv` is a template function, which is quite important.\n// `EnvDefinitionType` is the specific type of the environment definition.\n// That type must comply with the restriction that it is an object with string\n// keys and those variable types as values.  However, we will need the\n// *specific* type, i.e. a TypeScript type that contains the specific keys with\n// the corresponding value types. We get access to this type by templating this\n// function.\nexport function magicEnv<\n  EnvDefinitionType extends {\n    [key: string]:\n      | RequiredVariable\n      | OptionalVariable\n      | VariableWithDefaultValue;\n  },\n>(\n  processEnv: { [key: string]: string | undefined },\n  envDefinition: EnvDefinitionType,\n) {\n  // Now start constructing the result of this function.\n  const env: Partial<{ [k in keyof EnvDefinitionType]: string }> = {};\n\n  // And now we iterate through the `envDefinition` object, which we received\n  // from the callback function.\n  for (const key of Object.keys(envDefinition) as (string &\n    keyof EnvDefinitionType)[]) {\n    // This is the value from the process environment\n    const value: string | undefined = processEnv[key];\n\n    // This is the value from the definition object at the top\n    const fieldDefinition:\n      | RequiredVariable\n      | OptionalVariable\n      | VariableWithDefaultValue = envDefinition[key];\n\n    if ((fieldDefinition as any).req) {\n      // This is a required variable.\n\n      if (value === undefined) {\n        throw new Error(`Missing key ${key} in environment`);\n      } else {\n        env[key] = value;\n      }\n    } else if ((fieldDefinition as any).opt) {\n      // This is an optional variable. `value` may be a string or undefined.\n\n      env[key] = value;\n    } else {\n      // This is a variable with a default value (the value of\n      // `fieldDefinition`)\n\n      if (value === undefined) {\n        env[key] = (fieldDefinition as VariableWithDefaultValue).defaultValue;\n      } else {\n        env[key] = value;\n      }\n    }\n  }\n\n  // Return the `env` object that we have just constructed, but return with a\n  // special type that we define here: it is an object which contains all the\n  // keys that the definition object has. The value type is `string`, except\n  // for fields that correspond to optional variables, those have type\n  // `string | undefined`. All fields are declared readonly.\n  return env as {\n    readonly [k in keyof EnvDefinitionType]: EnvDefinitionType[k] extends OptionalVariable\n      ? string | undefined\n      : string;\n  };\n}\n", "import {\n  magicEnv,\n  required,\n  optional,\n  defaultValue,\n} from 'server/src/config/MagicEnv.ts';\n\nexport default magicEnv(process.env, {\n  // `process.env.NODE_ENV` is used in our code, but also in many third party\n  // libraries we import, to switch between development and production mode.\n  // Just to make sure it is set in the process environment, we include it here.\n  NODE_ENV: required,\n\n  // Normally one of `prod`, `staging`, `dev`, `test`, or `loadtest`\n  CORD_TIER: required,\n\n  // Accept connections on these ports\n  API_SERVER_PORT: optional,\n  ADMIN_SERVER_PORT: optional,\n  METRICS_SERVER_PORT: optional,\n  STATUS_SERVER_PORT: optional,\n  CONSOLE_SERVER_PORT: optional,\n  DOCS_SERVER_PORT: optional,\n\n  // PostgreSQL connection configuration - required\n  POSTGRES_HOST: required,\n  POSTGRES_PORT: required,\n  POSTGRES_USER: required,\n  POSTGRES_PASSWORD: required,\n  POSTGRES_DB: required,\n\n  // PostgreSQL read-only server, if there is one (user/password/db setting same\n  // as above)\n  POSTGRES_READ_HOST: optional,\n  POSTGRES_READ_PORT: optional,\n\n  // Redis connection configuration\n  REDIS_PORT: required,\n  REDIS_HOST: required,\n  PREDIS_PORT: required,\n  PREDIS_HOST: required,\n\n  // URLs pointing to our own endpoints\n  TOP_SERVER_HOST: required,\n  APP_SERVER_HOST: required,\n  API_SERVER_HOST: required,\n  API_SERVER_HOST_PRODUCTION: required,\n  ADMIN_SERVER_HOST: required,\n  MARKETING_SERVER_HOST: required,\n  PUBLIC_UPLOADS_HOST: required,\n  CONSOLE_SERVER_HOST: required,\n  CORD_TO_HOST: required,\n  DOCS_SERVER_HOST: required,\n  CLACK_SERVER_HOST: optional,\n  COMMUNITY_SERVER_HOST: required,\n\n  // Slack App credentials - required\n  SLACK_APP_CLIENT_SECRET: required,\n  SLACK_DEV_APP_CLIENT_SECRET: required,\n  SLACK_ADMIN_LOGIN_REDIRECT_HOST: optional,\n  SLACK_APP_REDIRECT_HOST: optional,\n  SLACK_SIGNING_SECRET: required,\n  SLACK_ADMIN_CLIENT_SECRET: required,\n  SLACK_ADMIN_SIGNING_SECRET: required,\n  SLACK_INTERNAL_BOT_TOKEN: required,\n  SLACK_INTERNAL_SIGNING_SECRET: required,\n  SLACK_CUSTOMER_UPDATES_BOT_TOKEN: required,\n\n  // S3 Bucket File storage\n  S3_ACCESS_KEY_ID: optional,\n  S3_ACCESS_KEY_SECRET: optional,\n  S3_REGION: required,\n  S3_BUCKET: required,\n  S3_PUBLIC_BUCKET: required,\n  S3_ENDPOINT: required,\n  S3_USE_PATH_BASED_URLS: required,\n\n  EMAIL_LINKS_TOKEN_SECRET: required,\n\n  // Jira App credentials - required\n  JIRA_APP_CLIENT_ID: required,\n  JIRA_APP_CLIENT_SECRET: required,\n\n  // Asana App credentials - required\n  ASANA_APP_CLIENT_ID: required,\n  ASANA_APP_CLIENT_SECRET: required,\n\n  // Linear App credentials - required\n  LINEAR_APP_CLIENT_ID: required,\n  LINEAR_APP_CLIENT_SECRET: required,\n\n  // Trello App credentials - required\n  TRELLO_APP_CLIENT_ID: required,\n  TRELLO_APP_CLIENT_SECRET: required,\n\n  // Monday App credentials - required\n  MONDAY_APP_CLIENT_ID: required,\n  MONDAY_APP_CLIENT_SECRET: required,\n\n  // Secret for session tokens - required\n  JWT_SIGNING_SECRET: required,\n\n  // Secret for signing OAuth flow state variables encoding the user and org IDs\n  OAUTH_STATE_SIGNING_SECRET: required,\n\n  // Secret for signing Slack OAuth flow state variables encoding the user and org IDs\n  SLACK_OAUTH_STATE_SIGNING_SECRET: required,\n\n  // Log level for console logging - optional ('info' if not provided)\n  LOGLEVEL: defaultValue('info'),\n\n  // Post error messages to this Slack channel,\n  CORD_OPS_SLACK_CHANNEL_ID: optional,\n\n  // Post informational changes to prod setup, including deploy and db migration\n  // messages, to this Slack channel\n  PROD_CHANGES_SLACK_CHANNEL_ID: optional,\n\n  // Post security/SOC2 compliance messages to this Slack channel,\n  CORD_SECURITY_SLACK_CHANNEL_ID: optional,\n\n  // Post info about go redirects to this Slack channel\n  CORD_GO_REDIRECTS_SLACK_CHANNEL_ID: optional,\n\n  // Post messages from customers to this Slack channel\n  CORD_ALL_CUSTOMERS_SLACK_CHANNEL_ID: optional,\n\n  // Post client request messages to this Slack channel\n  CORD_CLIENT_REQUESTS_SLACK_CHANNEL_ID: optional,\n\n  // For sending search queries from the docs site to Slack\n  CORD_DOCS_SEARCH_SLACK_CHANNEL_ID: optional,\n\n  // Cloudwatch config - optional. If these are not provided, Cloudwatch\n  // logging is disabled\n  CLOUDWATCH_LOGLEVEL: optional,\n  CLOUDWATCH_AWS_REGION: defaultValue('eu-west-2'), // our default region, London\n  CLOUDWATCH_LOG_GROUP_NAME: optional,\n  CLOUDWATCH_LOG_STREAM_NAME: optional,\n\n  // Host used when developing locally but an externally accessible url is\n  // needed. (example: d92dd1d1fa99.ngrok.io)\n  EXTERNAL_API_HOST_FOR_DEVELOPMENT: optional,\n\n  // path to static files for the admin app\n  ADMIN_SERVER_STATIC_PATH: defaultValue('dist/server/admin'),\n\n  // path to static files for the console app\n  CONSOLE_SERVER_STATIC_PATH: defaultValue('dist/server/console'),\n\n  // path to static files for the docs app\n  DOCS_SERVER_STATIC_PATH: defaultValue('dist/docs/static'),\n\n  // API key used to send transactional email notifications through Sendgrid.\n  SENDGRID_API_KEY: required,\n\n  // HTTP Basic Auth name and password for SendGrid's Inbound Parse webhooks\n  SENDGRID_INBOUND_WEBHOOK_USER: required,\n  SENDGRID_INBOUND_WEBHOOK_PASSWORD: required,\n\n  // API key used to fetch feature flags from LaunchDarkly\n  LAUNCHDARKLY_API_KEY: optional,\n\n  // Number of extra workers to run the api server in: 'auto' makes one per CPU; otherwise a specific number can be used\n  NUM_WORKERS: optional,\n\n  // Encryption key used when storing secrets in the database\n  PLATFORM_SECRETS_ENCRYPTION_KEY: required,\n\n  // Encryption key used when generating file permalinks\n  FILE_PROXY_SIGNING_SECRET_KEY: required,\n\n  // sentry.io environment setting\n  SENTRY_ENVIRONMENT: optional,\n  SENTRY_RELEASE: optional,\n  SENTRY_TRACE_SAMPLE_RATE: optional,\n\n  // Auth0 Environment variables\n  // 1) For SPA application\n  AUTH0_CLIENT_ID: required,\n  AUTH0_CUSTOM_LOGIN_DOMAIN: required,\n\n  // 2) For verifying incoming events\n  AUTH0_WEBHOOK_SECRET: required,\n\n  // 3) For server to server communication\n  AUTH0_MTM_CLIENT_ID: required,\n  AUTH0_MTM_CLIENT_SECRET: required,\n  AUTH0_GENERAL_DOMAIN: required,\n\n  // console.cord.com cord app credentials\n  DEV_CONSOLE_CORD_APP_SECRET: required,\n\n  // secret for signing admin tokens to serve as proof user is logged in to\n  // admin\n  ADMIN_TOKEN_SECRET: required,\n\n  // flag whether the SDK testbed should be built and served\n  INCLUDE_SDK_TESTBED: optional,\n\n  // secret for cookies on the docs web site\n  DOCS_COOKIE_PARSER_SECRET: optional,\n\n  // set email for all notifications when testing with users on testbed\n  TESTBED_USERS_EMAIL: optional,\n\n  // secret for creating searchable embeddings and generating search\n  // results within our docs\n  OPENAI_API_SECRET: required,\n\n  // secret for getting geographic information from an IP address\n  IPSTACK_API_SECRET: optional,\n\n  // Host for where we generate the ai chat bot in the docs\n  DOCS_AI_CHATBOT_SERVER_HOST: required,\n\n  // Google analytic events\n  GA_MEASUREMENT_ID: required,\n  GA_MEASUREMENT_PROTOCOL_API_SECRET: required,\n\n  // secret for stripe\n  STRIPE_SECRET_KEY: required,\n  STRIPE_WEBHOOK_SECRET_KEY: required,\n\n  DEMO_APPS_SHARED_SECRET: required,\n\n  // loops.so for sending newletters\n  LOOPS_SO_API_KEY: required,\n});\n", "// ADD NEW FLAGS HERE ONLY IF YOU NEED THEM ON THE CLIENT-SIDE\n// If the new flag is only used server-side then add your new flag in:\n// server/src/featureflags/index.ts\n// If you need to use them in BOTH the client AND the server, you only need\n// to add them once, in this file.\n//\n// Ensure they're set up in LaunchDarkly before you add them here.  The key for\n// the flag must match the key in LaunchDarkly.\n//\n// The full set of valid values for a flag should be in the second type argument\n// to FeatureFlag, so if you have a three-state feature flag of \"yes\", \"no\", and\n// \"maybeso\", you should declare it as:\n//\n// MULTI_STATE_FLAG: {\n//   key: 'multi_state_flag',\n//   defaultValue: 'no',\n// } as FeatureFlag<'multi_state_flag', 'yes' | 'no' | 'maybeso'>\nexport const FeatureFlags = {\n  USE_NEW_CSS_COMPONENTS: {\n    key: 'Use_new_CSS_components',\n    defaultValue: {},\n  } as FeatureFlag<'Use_new_CSS_components', Record<string, object>>,\n  SUPPORT_CHAT_ENABLED: {\n    key: 'support_chat_enabled',\n    defaultValue: false,\n  } as FeatureFlag<'support_chat_enabled', boolean>,\n  ENABLE_ANNOTATIONS_SCREENSHOTS: {\n    key: 'enable_annotations_screenshots',\n    defaultValue: true,\n  } as FeatureFlag<'enable_annotations_screenshots', boolean>,\n  ENABLE_PLAINTEXT_ANNOTATIONS: {\n    key: 'enable_plaintext_annotations',\n    defaultValue: true,\n  } as FeatureFlag<'enable_plaintext_annotations', boolean>,\n  ENABLE_ATTACHMENTS: {\n    key: 'enable_attachments',\n    defaultValue: true,\n  } as FeatureFlag<'enable_attachments', boolean>,\n  EMAIL_SHARING: {\n    key: 'email_sharing',\n    defaultValue: true,\n  } as FeatureFlag<'email_sharing', boolean>,\n  ENABLE_FORCE_REFRESH_PROVIDER: {\n    key: 'enable_force_refresh_provider',\n    defaultValue: false,\n  } as FeatureFlag<'enable_force_refresh_provider', boolean>,\n  MONDAY_TASKS: {\n    key: 'monday_tasks',\n    defaultValue: false,\n  } as FeatureFlag<'monday_tasks', boolean>,\n  TAKE_SCREENSHOT_WHEN_CREATING_THREAD: {\n    key: 'take_screenshot_when_creating_thread',\n    defaultValue: false,\n  } as FeatureFlag<'take_screenshot_when_creating_thread', boolean>,\n  TAKE_SCREENSHOT_WHEN_SENDING_MESSAGE: {\n    key: 'take_screenshot_when_sending_message',\n    defaultValue: false,\n  } as FeatureFlag<'take_screenshot_when_sending_message', boolean>,\n  OPEN_THREAD_SAME_PAGE: {\n    key: 'open_thread_same_page',\n    defaultValue: false,\n  } as FeatureFlag<'open_thread_same_page', boolean>,\n  SHOW_ACTIVATION_WELCOME_MESSAGE_NUX: {\n    key: 'show_activation_welcome_message_nux',\n    defaultValue: false,\n  } as FeatureFlag<'show_activation_welcome_message_nux', boolean>,\n  ENABLE_SLACK_FEATURES: {\n    key: 'enable-slack-features',\n    defaultValue: true,\n  } as FeatureFlag<'enable-slack-features', boolean>,\n  ENABLE_DEV_CONSOLE_SELF_SERVE: {\n    key: 'enable-dev-console-self-serve',\n    defaultValue: false,\n  } as FeatureFlag<'enable-dev-console-self-serve', boolean>,\n  // TODO: remove - no longer used\n  THREAD_STYLING_TWEAKS: {\n    key: 'thread_styling_tweaks',\n    defaultValue: false,\n  } as FeatureFlag<'thread_styling_tweaks', boolean>,\n  REMOVE_TASKS_FEATURE: {\n    key: 'remove_tasks_feature',\n    defaultValue: false,\n  } as FeatureFlag<'remove_tasks_feature', boolean>,\n  SHOW_COMMUNITY_IN_CONSOLE: {\n    key: 'show-community-in-console',\n    defaultValue: true,\n  } as FeatureFlag<'show-community-in-console', boolean>,\n  SHOW_CUSTOMER_ISSUES_IN_CONSOLE: {\n    key: 'show-customer-issues-in-console',\n    defaultValue: false,\n  } as FeatureFlag<'show-customer-issues-in-console', boolean>,\n  TAKE_SCREENSHOT_OF_CANVAS_ONLY: {\n    key: 'take_screenshot_of_canvas_only',\n    defaultValue: false,\n  } as FeatureFlag<'take_screenshot_of_canvas_only', boolean>,\n  SHOW_EVENTS_TAB_IN_CONSOLE: {\n    key: 'show_events_tab_in_console',\n    defaultValue: true,\n  } as FeatureFlag<'show_events_tab_in_console', boolean>,\n  ENABLE_TEXT_ANNOTATIONS: {\n    key: 'enable_text_annotations',\n    defaultValue: true,\n  } as FeatureFlag<'enable_text_annotations', boolean>,\n  ENABLE_EMAIL_NOTIFICATIONS: {\n    key: 'enable_email_notifications',\n    defaultValue: true,\n  } as FeatureFlag<'enable_email_notifications', boolean>,\n  ENABLE_ANNOTATIONS_OVERLAY: {\n    key: 'enable_annotations_overlay',\n    defaultValue: true,\n  } as FeatureFlag<'enable_annotations_overlay', boolean>,\n  ENABLE_SENTRY: {\n    key: 'enable_sentry',\n    defaultValue: true,\n  } as FeatureFlag<'enable_sentry', boolean>,\n  CONSOLE_WEBINAR_BANNER: {\n    key: 'console_webinar_banner',\n    defaultValue: {},\n  } as FeatureFlag<'console_webinar_banner', object>,\n  ENABLE_VIDEO_CAPABILITIES: {\n    key: 'enable_video_capabilities',\n    defaultValue: false,\n  } as FeatureFlag<'enable_video_capabilities', boolean>,\n  SHOW_LINK_PREVIEWS: {\n    key: 'show-link-previews',\n    defaultValue: true,\n  } as FeatureFlag<'show-link-previews', boolean>,\n  BILLING_ENABLED_IN_CONSOLE: {\n    key: 'billing_enabled_in_console',\n    defaultValue: true,\n  } as FeatureFlag<'billing_enabled_in_console', boolean>,\n  MENTION_NOTIFICATION_EMAIL_TEMPLATE_ID: {\n    key: 'mention_notification_email_template_id',\n    defaultValue: 'd-6309e6ccb36a4a769957795f475c8130',\n  } as FeatureFlag<\n    'mention_notification_email_template_id',\n    | 'd-6309e6ccb36a4a769957795f475c8130'\n    | 'd-8f2246c657a8498394e9caf181816bc3'\n    | 'd-8a8088e59eed4622b2d09078de372fe8'\n    | 'd-bc3669c391774addb7da37f92a3f97e3'\n  >,\n  SHOW_CONSOLE_LANDING_PAGE: {\n    key: 'show_console_landing_page',\n    defaultValue: false,\n  },\n} as const;\n\n// The generic type that makes this all work.  The first type parameter is\n// always set to a single string, and it makes it possible to do type inference\n// on the useFeatureFlag() call and figure out what the return value is.\nexport type FeatureFlag<K, T> = {\n  key: K;\n  defaultValue: T;\n};\n\n// The map of feature flag keys to the default value for that flag.  We have to\n// use `as any` in the assignment because TypeScript will only infer that the\n// return type is {[key: string]: union_of_all_flag_value_types} rather than\n// associating the right type with the right key.\nconst defaults: {\n  [P in keyof typeof FeatureFlags as (typeof FeatureFlags)[P]['key']]: (typeof FeatureFlags)[P]['defaultValue'];\n} = Object.fromEntries(\n  Object.entries(FeatureFlags).map(([_, v]) => [v.key, v.defaultValue]),\n) as any;\n\n/**\n * Returns an object that maps from feature flag keys to their default value.\n */\nexport function featureFlagDefaults() {\n  return defaults;\n}\n", "import * as sgMail from '@sendgrid/mail';\nimport * as jwt from 'jsonwebtoken';\nimport type { UUID } from 'common/types/index.ts';\nimport { LogLevel } from 'common/types/index.ts';\nimport env from 'server/src/config/Env.ts';\nimport type { CustomEmailTemplate } from 'server/src/entity/application/ApplicationEntity.ts';\nimport type { ThreadDetails } from 'server/src/util/email.ts';\nimport { EmailOutboundNotificationEntity } from 'server/src/entity/email_notification/EmailOutboundNotificationEntity.ts';\nimport { getReplyToEmailAddress } from 'server/src/email/utils.ts';\nimport { logServerEvent } from 'server/src/entity/event/EventMutator.ts';\nimport type { RequestContext } from 'server/src/RequestContext.ts';\nimport { DEFAULT_EMAIL_LOGO_WIDTH } from 'common/const/Sizes.ts';\nimport {\n  AUTH0_CUSTOM_LOGIN_DOMAIN,\n  CONSOLE_ORIGIN,\n} from 'common/const/Urls.ts';\nimport { AUTH0_CLIENT_ID } from 'common/const/Ids.ts';\nimport { CustomerEntity } from 'server/src/entity/customer/CustomerEntity.ts';\nimport type { NotificationType } from 'server/src/entity/notification/NotificationEntity.ts';\n\nsgMail.default.setApiKey(env.SENDGRID_API_KEY);\nexport const DEFAULT_MENTION_NOTIFICATION_V2_TEMPLATE_ID =\n  'd-6309e6ccb36a4a769957795f475c8130';\nexport const MENTION_NOTIFICATION_NO_POWERED_BY_CORD_TEMPLATE_ID =\n  'd-8a8088e59eed4622b2d09078de372fe8';\nexport const DEFAULT_SHARE_TO_EMAIL_TEMPLATE_ID =\n  'd-fecc876acf684ff2bca887748d86e4e1';\nexport const SHARE_TO_EMAIL_NO_POWERED_BY_CORD_TEMPLATE_ID =\n  'd-b70dc2c71ee541ee9e0c5f4cd84b32e3';\nexport const DEFAULT_THREAD_RESOLVE_TEMPLATE_ID =\n  'd-93aa618e7d0b4ba593c346f9a1f664c5';\nexport const THREAD_RESOLVE_NO_POWERED_BY_CORD_TEMPLATE_ID =\n  'd-37c14e17cc9649afb70495f029b3833d';\nconst SEND_CONSOLE_USER_INVITE_TEMPLATE_ID =\n  'd-ab157e4f588c4a30b6304e4e062b5f88';\nconst ACCESS_GRANTED_TO_CONSOLE_USER_TEMPLATE_ID =\n  'd-1bbf5f1a7a2948529de051d44eb873c9';\nconst ACCESS_DENIED_TO_CONSOLE_USER_TEMPLATE_ID =\n  'd-48ea1b657a2a4f9b95c9f81d38425306';\nconst REQUEST_ACCESS_TO_CUSTOMER_TEMPLATE_ID =\n  'd-bfe0627042f345f8b7877e6a97815359';\n\ntype UnsubscribeThreadTokenData = {\n  threadID: UUID;\n  userID: UUID;\n  orgID: UUID;\n  appID: UUID | null;\n};\n\nexport type ActionIcon = 'mention' | 'task' | 'paperclip';\n\nexport const encodeUnsubscribeThreadToken = (\n  data: UnsubscribeThreadTokenData,\n) => jwt.sign(data, env.EMAIL_LINKS_TOKEN_SECRET, { algorithm: 'HS512' });\n\nexport const decodeUnsubscribeThreadToken = (token: string) =>\n  jwt.verify(token, env.EMAIL_LINKS_TOKEN_SECRET, {\n    algorithms: ['HS512'],\n  }) as UnsubscribeThreadTokenData;\n\nexport type SendActionEmailNotificationData = {\n  context: RequestContext;\n  recipientEmail: string;\n  actionText: string;\n  actionIconType: ActionIcon;\n  pageName: string;\n  pageURL: string;\n  providerName: string | undefined;\n  unsubscribeURL: string;\n  partnerDetails: CustomEmailTemplate | undefined;\n  threadDetails: ThreadDetails;\n  emailNotification: EmailOutboundNotificationEntity;\n  /** You can edit templates in SendGrid */\n  templateId: string;\n  notificationType: NotificationType;\n};\n/*\n  Common function used to send thread-action and reply notifications.\n  They are similar in that they both notify of an action eg resolving\n  /unresolving a thread or a reply or @mention message.\n  */\nexport async function sendActionEmailNotification({\n  context,\n  recipientEmail,\n  actionText,\n  actionIconType,\n  pageName,\n  pageURL,\n  providerName,\n  unsubscribeURL,\n  partnerDetails,\n  threadDetails,\n  emailNotification,\n  /** You can edit templates in SendGrid */\n  templateId,\n  notificationType,\n}: SendActionEmailNotificationData) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const {\n    firstMessageDetails,\n    firstMessageUserDetails,\n    previousMessageDetails,\n    previousMessageUserDetails,\n    currentMessageDetails,\n    currentMessageUserDetails,\n    messagesCountLeft,\n  } = threadDetails;\n\n  const threadingHeaders = await getThreadingHeaders(emailNotification);\n\n  // See https://stackoverflow.com/questions/1027395/detecting-outlook-autoreply-out-of-office-emails#comment64988838_25324691\n  // Request that MS Exchange does not send automated replies (like Out of Office)\n  // back to this email\n  const noAutoResponseHeader = { 'X-Auto-Response-Suppress': 'OOF' };\n\n  const unsubscribeHeaders = {\n    'List-Unsubscribe': `<${unsubscribeURL}>`,\n    'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click',\n  };\n\n  let eventType = '';\n  let emailType = '';\n  if (notificationType === 'reply') {\n    eventType = 'email-mention-notification-sent-v2';\n    emailType = 'mention v2';\n  } else if (notificationType === 'thread_action') {\n    eventType = 'email-thread-action-notification-sent';\n    emailType = 'thread action';\n  }\n\n  const mailData = {\n    from: partnerDetails?.sender ?? 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    replyTo: getReplyToEmailAddress(\n      context.logger,\n      partnerDetails?.sender ?? `Cord <cord@cord.fyi>`,\n      emailNotification.id,\n    ),\n    templateId,\n    headers: {\n      ...threadingHeaders,\n      ...noAutoResponseHeader,\n      ...unsubscribeHeaders,\n    },\n    dynamicTemplateData: {\n      Action: actionText,\n      Action_Icon: actionIconType,\n      Page_Name: pageName,\n      Page_URL: pageURL,\n      Tool_Name: providerName,\n      First_Message_Details: firstMessageDetails,\n      First_Message_User_Details: firstMessageUserDetails,\n      Previous_Message_Details: previousMessageDetails,\n      Previous_Message_User_Details: previousMessageUserDetails,\n      Current_Message_Details: currentMessageDetails,\n      Current_Message_User_Details: currentMessageUserDetails,\n      Messages_Count_Left: messagesCountLeft,\n      Preview_Text: currentMessageDetails.message_preview,\n      Unsubscribe_URL: unsubscribeURL,\n      Partner_Name: partnerDetails?.partnerName,\n      Partner_Image_URL: partnerDetails?.imageURL,\n      Add_Explainer: false,\n      Image_Height: partnerDetails?.logoConfig?.height ?? 'auto',\n      Image_Width:\n        partnerDetails?.logoConfig?.width ?? DEFAULT_EMAIL_LOGO_WIDTH,\n    },\n  };\n  return await sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(`Sent ${emailType} email to ${recipientEmail}`);\n      logServerEvent({\n        session: context.session,\n        type: eventType,\n        logLevel: LogLevel.DEBUG,\n        payload: { from: mailData.from, to: mailData.to },\n      });\n\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(\n        `Failed sending ${emailType} email to ${recipientEmail}`,\n        {\n          error: error.response.body.errors,\n          from_address: mailData.from,\n          to_address: mailData.to,\n        },\n      );\n      return false;\n    });\n}\n\n// the EmailEmail repetition is intentional\nexport function sendShareThreadToEmailEmail(\n  context: RequestContext,\n  recipientEmail: string,\n  pageName: string,\n  pageURL: string,\n  partnerDetails: CustomEmailTemplate | undefined,\n  threadDetails: ThreadDetails,\n  emailNotification: EmailOutboundNotificationEntity | null,\n  templateID: string,\n) {\n  if (process.env.IS_TEST) {\n    return true;\n  }\n\n  const {\n    senderName,\n    firstMessageDetails,\n    firstMessageUserDetails,\n    previousMessageDetails,\n    previousMessageUserDetails,\n    currentMessageDetails,\n    currentMessageUserDetails,\n    messagesCountLeft,\n  } = threadDetails;\n\n  const mailData = {\n    from: partnerDetails?.sender ?? 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    replyTo: emailNotification\n      ? getReplyToEmailAddress(\n          context.logger,\n          partnerDetails?.sender ?? `Cord <cord@cord.fyi>`,\n          emailNotification.id,\n        )\n      : partnerDetails?.sender ?? `Cord <cord@cord.fyi>`,\n    templateId: templateID,\n    dynamicTemplateData: {\n      Page_Name: pageName,\n      Page_URL: pageURL,\n      Sender_Name: senderName,\n      First_Message_Details: firstMessageDetails,\n      First_Message_User_Details: firstMessageUserDetails,\n      Previous_Message_Details: previousMessageDetails,\n      Previous_Message_User_Details: previousMessageUserDetails,\n      Current_Message_Details: currentMessageDetails,\n      Current_Message_User_Details: currentMessageUserDetails,\n      Messages_Count_Left: messagesCountLeft,\n      Preview_Text: currentMessageDetails.message_preview,\n      Partner_Name: partnerDetails?.partnerName,\n      Partner_Image_URL: partnerDetails?.imageURL,\n      Image_Height: partnerDetails?.logoConfig?.height ?? 'auto',\n      Image_Width:\n        partnerDetails?.logoConfig?.width ?? DEFAULT_EMAIL_LOGO_WIDTH,\n    },\n  };\n  return sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(`Sent shareThreadToEmail email to ${recipientEmail}`);\n      logServerEvent({\n        session: context.session,\n        type: 'email-share-thread-to-email-sent',\n        logLevel: LogLevel.DEBUG,\n        payload: { from: mailData.from, to: mailData.to },\n      });\n\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(\n        `Failed sending shareThreadToEmail email to ${recipientEmail}`,\n        {\n          error: error.response.body.errors,\n        },\n      );\n      return false;\n    });\n}\n\ntype ThreadingHeaders =\n  | {\n      'Message-ID': string;\n    }\n  | {\n      'Message-ID': string;\n      'In-Reply-To': string;\n      References: string;\n    };\n// Returns the email headers Message-ID, In-Reply-To and References to enable\n// threading of emails (in the email client) for the same Cord thread.\n// We also use these headers when handling inbound replies in SendGridWebhookHandler\n// if the notificationID is not in the 'to' address.\nasync function getThreadingHeaders(\n  emailNotification: EmailOutboundNotificationEntity,\n): Promise<ThreadingHeaders> {\n  const isFirstEmail =\n    (await EmailOutboundNotificationEntity.count({\n      where: {\n        email: emailNotification.email,\n        threadID: emailNotification.threadID,\n      },\n    })) === 1;\n\n  if (isFirstEmail) {\n    return {\n      'Message-ID': `<thread-${emailNotification.threadID}@cord.fyi>`,\n    };\n  } else {\n    return {\n      'Message-ID': `<notif-${emailNotification.id}@cord.fyi>`,\n      'In-Reply-To': `<thread-${emailNotification.threadID}@cord.fyi>`,\n      References: `<thread-${emailNotification.threadID}@cord.fyi>`,\n    };\n  }\n}\n\nexport async function sendEmailInviteConsoleUser(\n  context: RequestContext,\n  recipientEmail: string,\n  inviterName: string,\n  customerID: UUID,\n) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const customer = await CustomerEntity.findByPk(customerID);\n\n  if (!customer) {\n    throw new Error('No customer, no customer invite!');\n  }\n\n  const inviteLink = encodeURI(\n    `https://${AUTH0_CUSTOM_LOGIN_DOMAIN}/authorize?` +\n      'response_type=code&' +\n      `client_id=${AUTH0_CLIENT_ID}&` +\n      `redirect_uri=${CONSOLE_ORIGIN}/login&` +\n      'scope=openid email profile&' +\n      'screen_hint=signup&' +\n      `login_hint=${recipientEmail}`,\n  );\n\n  const mailData = {\n    from: 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    templateId: SEND_CONSOLE_USER_INVITE_TEMPLATE_ID,\n    dynamicTemplateData: {\n      Invite_Link: inviteLink,\n      Inviter: inviterName,\n      Customer_Name: customer.name,\n    },\n  };\n  return await sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(\n        `Sent email to invite ${recipientEmail} to cord console`,\n      );\n      logServerEvent({\n        session: context.session,\n        type: 'email-invite-console-user',\n        logLevel: LogLevel.DEBUG,\n        payload: { from: mailData.from, to: mailData.to },\n      });\n\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(`Failed sending email to ${recipientEmail}`, {\n        error: error.response.body.errors,\n        from_address: mailData.from,\n        to_address: mailData.to,\n      });\n      return false;\n    });\n}\n\nexport async function sendAccessGrantedEmailToConsoleUser(\n  context: RequestContext,\n  recipientEmail: string,\n  customer: CustomerEntity,\n) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const mailData = {\n    from: 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    templateId: ACCESS_GRANTED_TO_CONSOLE_USER_TEMPLATE_ID,\n    dynamicTemplateData: {\n      Console_Link: `${CONSOLE_ORIGIN}/login`,\n      Customer_Name: customer.name,\n    },\n  };\n  return await sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(\n        `Sent email to ${recipientEmail} to notify access granted to customer in cord console`,\n      );\n      logServerEvent({\n        session: context.session,\n        type: 'email-granted-access-console-user',\n        logLevel: LogLevel.DEBUG,\n        payload: {\n          from: mailData.from,\n          to: mailData.to,\n          customerID: customer.id,\n        },\n      });\n\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(`Failed sending email to ${recipientEmail}`, {\n        error: error.response.body.errors,\n        from_address: mailData.from,\n        to_address: mailData.to,\n      });\n      return false;\n    });\n}\n\nexport async function sendAccessDeniedEmailToConsoleUser(\n  context: RequestContext,\n  recipientEmail: string,\n  customer: CustomerEntity,\n) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const mailData = {\n    from: 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    templateId: ACCESS_DENIED_TO_CONSOLE_USER_TEMPLATE_ID,\n    dynamicTemplateData: {\n      Console_Link: `${CONSOLE_ORIGIN}/login?newcustomer=true`,\n      Customer_Name: customer.name,\n    },\n  };\n\n  return await sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(\n        `Sent email to ${recipientEmail} to notify access denied to customer in cord console`,\n      );\n      logServerEvent({\n        session: context.session,\n        type: 'email-denied-access-console-user',\n        logLevel: LogLevel.DEBUG,\n        payload: {\n          from: mailData.from,\n          to: mailData.to,\n          customerID: customer.id,\n        },\n      });\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(`Failed sending email to ${recipientEmail}`, {\n        error: error.response.body.errors,\n        from_address: mailData.from,\n        to_address: mailData.to,\n      });\n      return false;\n    });\n}\n\n/**\n * Used for when a console user requests access to an existing customer\n */\nasync function sendRequestAccessEmailToConsoleUser(\n  context: RequestContext,\n  recipientEmail: string,\n  requesterEmail: string,\n  customerName: string,\n  customerID: UUID,\n) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const mailData = {\n    from: 'Cord <cord@cord.fyi>',\n    to: recipientEmail,\n    templateId: REQUEST_ACCESS_TO_CUSTOMER_TEMPLATE_ID,\n    dynamicTemplateData: {\n      Sender_Email: requesterEmail,\n      Customer_Name: customerName,\n      View_Access_Requests_Link: `${CONSOLE_ORIGIN}/usermanagement`,\n    },\n  };\n\n  return await sgMail.default\n    .send(mailData)\n    .then(() => {\n      context.logger.info(\n        `Sent request access email to ${recipientEmail} to cord console`,\n      );\n      logServerEvent({\n        session: context.session,\n        type: 'email-request-access-customer',\n        logLevel: LogLevel.DEBUG,\n        payload: { from: mailData.from, to: mailData.to, customerID },\n      });\n\n      return true;\n    })\n    .catch((error) => {\n      context.logger.error(`Failed sending email to ${recipientEmail}`, {\n        error: error.response.body.errors,\n        from_address: mailData.from,\n        to_address: mailData.to,\n      });\n      return false;\n    });\n}\n\nexport async function sendAccessRequestToCustomerConsoleUsers(\n  context: RequestContext,\n  requesterEmail: string,\n  customerID: UUID,\n) {\n  if (process.env.IS_TEST) {\n    return;\n  }\n\n  const customer = await CustomerEntity.findByPk(customerID);\n\n  if (!customer) {\n    throw new Error('No customer, no customer invite!');\n  }\n  const approvedCustomerConsoleUsers =\n    await context.loaders.consoleUserLoader.loadConsoleUsersForCustomer(\n      customerID,\n    );\n\n  if (approvedCustomerConsoleUsers.length === 0) {\n    throw new Error('No console users in this customer');\n  }\n\n  return await Promise.all(\n    approvedCustomerConsoleUsers.map((consoleUser) =>\n      sendRequestAccessEmailToConsoleUser(\n        context,\n        consoleUser.email,\n        requesterEmail,\n        customer.name,\n        customer.id,\n      ),\n    ),\n  );\n}\n", "// See #8935:\n/// <reference lib=\"es2022\" />\n\nimport type OpenAI from 'openai';\n\nimport jsonStableStringify from 'fast-json-stable-stringify';\nimport type { Placement } from '@floating-ui/react-dom';\nimport { isEqual } from '@cord-sdk/react/common/lib/fast-deep-equal.ts';\n\nexport type {\n  DocumentAnnotationResult,\n  Screenshot,\n  DocumentLocation,\n  LocationTextConfig,\n  HighlightedTextConfig,\n  AdditionalTargetData,\n  Annotation,\n  AnnotationWithThreadID,\n  AnnotationCapturePosition,\n} from '@cord-sdk/types';\nexport { locationJson } from '@cord-sdk/types';\nimport { locationJson, MessageNodeType } from '@cord-sdk/types';\nimport type {\n  FlatJsonObject,\n  LocationFilterOptions,\n  ResolvedStatus,\n  MessageAnnotation,\n  ElementIdentifierVersion,\n  EntityMetadata,\n  NotificationListFilter,\n  ThreadListFilter,\n  JsonValue,\n  JsonObject,\n  MessageContent,\n  MessageNode,\n  ViewerThreadStatus,\n} from '@cord-sdk/types';\n\nexport type {\n  MessageAnnotation,\n  ElementIdentifierVersion,\n  EntityMetadata,\n  NotificationListFilter,\n  ThreadListFilter,\n  JsonValue,\n  JsonObject,\n};\n\nexport type SimpleTranslationParameters = FlatJsonObject;\n\nexport enum DataTableQueries {\n  ADMIN_USERS = 'admin_users',\n  SET_ADMIN = 'set_admin',\n  USER_DETAILS = 'user_details',\n  ORG_DETAILS = 'org_details',\n  APP_DETAILS = 'app_details',\n  THREAD_DETAILS = 'thread_details',\n  MESSAGE_DETAILS = 'message_details',\n  CUSTOMER_DETAILS = 'customer_details',\n  ORG_MEMBER_DETAILS = 'org_member_details',\n  ID_SEARCH = 'id_search',\n  PROD_APPLICATIONS = 'prod_applications',\n  STAGING_APPLICATIONS = 'staging_applications',\n  SAMPLE_APPLICATIONS = 'sample_applications',\n  VERIFIED_CUSTOMERS = 'verified_customers',\n  SAMPLE_CUSTOMERS = 'sample_customers',\n  DEPLOYS = 'deploys',\n  PAGE_CONTEXTS = 'page_contexts',\n  BROWSER_METRICS = 'browser_metrics',\n  OS_METRICS = 'os_metrics',\n  GO_REDIRECTS = 'go_redirects',\n}\n\nexport type NonNullableKeys<T, K extends keyof T> = T & {\n  [P in K]: NonNullable<T[P]>;\n};\n\nexport type NullableKeys<T, K extends keyof T> = Omit<T, K> & {\n  [P in K]: T[P] | null;\n};\n\nexport type ElementOf<T extends Array<any>> = T[number];\n\n/**\n * A mapping type that effectively combines Required<T> and NonNullable<T> to\n * turn { foo?: string | undefined } into { foo: string }\n */\n// NOTE(9/9/2021): This is equivalent to Required<T> if we compiled with\n// --strictNullChecks, but we currently don't\nexport type ReallyRequired<T> = {\n  [P in keyof T]-?: NonNullable<T[P]>;\n};\n\nexport type { MessageContent, MessageNode };\nexport { MessageNodeType };\n\nexport type UUID = string;\n\nexport type Location = {\n  [k: string]: string | number | boolean;\n};\n\nexport type SortDirection = 'ascending' | 'descending';\n\nexport function isValidFlatJsonObject(obj: any): obj is FlatJsonObject {\n  if (!obj) {\n    return false;\n  }\n  if (typeof obj !== 'object' || Array.isArray(obj)) {\n    return false;\n  }\n  for (const [_, value] of Object.entries(obj)) {\n    const t = typeof value;\n    if (t !== 'string' && t !== 'number' && t !== 'boolean') {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function isLocation(obj: any): obj is Location {\n  return isValidFlatJsonObject(obj);\n}\n\nexport function isValidMetadata(obj: any): obj is EntityMetadata {\n  return isValidFlatJsonObject(obj);\n}\n\nexport function toLocation(obj: any): Location | null {\n  return isLocation(obj) ? obj : null;\n}\n\n// We receive location as either Location or LocationFilterOptions from\n// our apis. Since Location type can be flat object with multiple properties\n// we have to check the property type to make sure we're getting the right value.\n// eg: {value: 'foo', ...} is Location\n// while {value: {value: 'foo'} ...} is LocationFilterOptions\nexport function getLocationFilter(\n  obj: LocationFilterOptions | Location | undefined,\n): LocationFilterOptions | undefined {\n  if (!obj) {\n    return undefined;\n  }\n\n  if (isLocation(obj)) {\n    return { value: obj, partialMatch: false };\n  }\n\n  if (isLocation(obj.value)) {\n    return obj;\n  }\n  return undefined;\n}\n\n// Function to convert our external resolvedStatus filter enum\n// to our internal 'resolved' boolean property\nexport function getResolvedFromStatus(\n  status: ResolvedStatus,\n): boolean | undefined {\n  // we've not included a fallback value as this will just increase the chances\n  // of returning the wrong data somewhere. So we make sure to pass whatever\n  // we've said the default is for the API that's calling this.\n  switch (status) {\n    case 'resolved': {\n      return true;\n    }\n    case 'unresolved': {\n      return false;\n    }\n    case 'any': {\n      return undefined;\n    }\n    default: {\n      const unhandledStatus: never = status;\n      throw new Error('Invalid resolved status type ' + unhandledStatus);\n    }\n  }\n}\n\nexport function getViewerThreadFilter(\n  viewerStatus: ViewerThreadStatus | ViewerThreadStatus[] | undefined,\n): ViewerThreadStatus[] {\n  if (!viewerStatus) {\n    return [];\n  }\n  if (typeof viewerStatus === 'string') {\n    return [viewerStatus];\n  }\n  return viewerStatus;\n}\n\nexport function metadataMatches(\n  metadata: EntityMetadata,\n  matcher: EntityMetadata,\n): boolean {\n  for (const [key, value] of Object.entries(matcher)) {\n    if (metadata[key] !== value) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function locationMatches(context: Location, matcher: Location): boolean {\n  for (const [key, value] of Object.entries(matcher)) {\n    if (context[key] !== value) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction flatJsonObjectEqual(\n  a: FlatJsonObject | null,\n  b: FlatJsonObject | null,\n): boolean {\n  if (a === null && b === null) {\n    return true;\n  }\n  if (a === null || b === null) {\n    return false;\n  }\n  if (Object.keys(a).length !== Object.keys(b).length) {\n    return false;\n  }\n  for (const [key, value] of Object.entries(a)) {\n    if (b[key] !== value) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function locationEqual(a: Location | null, b: Location | null): boolean {\n  return flatJsonObjectEqual(a, b);\n}\n\nexport function metadataEqual(\n  a: EntityMetadata | null,\n  b: EntityMetadata | null,\n): boolean {\n  return flatJsonObjectEqual(a, b);\n}\n\n/**\n * Implements the canonical comparison for locations.  Currently, this sorts by\n * number of elements, then the JSON representation alphabetically, but we can\n * change that if we come up with something better.\n */\nexport function locationCompare(a: Location, b: Location): number {\n  const lengthA = Object.keys(a).length;\n  const lengthB = Object.keys(b).length;\n  if (lengthA !== lengthB) {\n    return lengthA - lengthB;\n  }\n  return locationJson(a).localeCompare(locationJson(b));\n}\n\nexport type PageContext = {\n  providerID: UUID | null;\n  data: Location;\n};\n\nexport function pageContextEqual(\n  a: PageContext | null,\n  b: PageContext | null,\n): boolean {\n  if (a === null && b === null) {\n    return true;\n  }\n  if (a === null || b === null) {\n    return false;\n  }\n  // Two contexts from different providers are never equal\n  if (a.providerID !== b.providerID) {\n    return false;\n  }\n  // If either has data, compare the data, otherwise compare the locations\n  return isEqual(a.data, b.data);\n}\n\n// This returns a string key that is equivalent from an equality perspective to\n// comparing the pageContexts.  Specifically, the intention is that\n// pageContextEqual(a, b) === (pageContextKey(a) === pageContextKey(b))\n\n// The functioning of this depends a lot on our specific logic of\n// building PageContexts, such that, for instance,\n// a.location === b.location => a.providerID === b.providerID.\n\n// It also needs to stay consistent with the logic in server/src/util/hash.ts.\nexport function pageContextKey(pageContext: PageContext): string {\n  return jsonStableStringify({\n    providerID: pageContext.providerID,\n    data: pageContext.data,\n  });\n}\n\n/**\n * Convert a PageContext-like object into an actual PageContext.\n *\n * The PageContext types that we exchange with GraphQL allow nullable fields to\n * be undefined as well. This function takes such objects and returns a valid\n * PageContext.\n */\ntype PageContextLike = {\n  providerID?: UUID | null;\n  data: Location;\n};\nexport function toPageContext(pageContext: PageContextLike): PageContext;\nexport function toPageContext(pageContext: null | undefined): null;\nexport function toPageContext(\n  pageContext: PageContextLike | null | undefined,\n): PageContext | null;\nexport function toPageContext(\n  pageContext: PageContextLike | null | undefined,\n): PageContext | null {\n  if (!pageContext) {\n    return null;\n  }\n  const { providerID, data } = pageContext;\n  if (!isLocation(data)) {\n    throw new Error('Invalid context');\n  }\n  return {\n    providerID: providerID ?? null,\n    data,\n  };\n}\n\nexport type OrgMemberState = 'active' | 'inactive' | 'deleted'; // must match the keys in OrgMemberStateEnumType\n\nexport type UserType = 'person' | 'bot'; // must match the keys in UserTypeEnumType\n\nexport type UserState = 'active' | 'deleted'; // must match the keys in UserStateEnumType\n\nexport type ImportedSlackMessageType = 'reply' | 'supportBotReply'; // must match the keys in ImportedSlackMessageTypeEnumType\n\nexport type MessageType = 'action_message' | 'user_message'; //must match the keys in MessageTypeEnumType\n\nexport interface Todo {\n  id: UUID;\n  done: boolean;\n}\n\nexport enum MessageAttachmentType {\n  FILE = 'file',\n  ANNOTATION = 'annotation',\n  SCREENSHOT = 'screenshot',\n}\n\nexport const MessageAnnotationAttachmentTypeName =\n  'MessageAnnotationAttachment';\n\nexport function parseElementIdentifierVersion(\n  val: string,\n): ElementIdentifierVersion | null {\n  if (val === '1' || val === '2') {\n    return val;\n  }\n  return null;\n}\n\nexport enum ElementIdentifierMatch {\n  EXACT = 'exact',\n  PARTIAL = 'partial',\n  NONE = 'none',\n}\n\nexport enum LocationMatch {\n  EXACT = 'exact',\n  SIBLING = 'sibling',\n  MULTIMEDIA = 'multimedia',\n  CHART = 'chart',\n  STALE = 'stale',\n  MAYBE_STALE = 'maybe_stale',\n  NONE = 'none',\n  // User has old extension, and does not have the latest identifier version\n  INCOMPATIBLE_IDENTIFIER_VERSION = 'incompatible_identifier_version',\n  // Used if fallback document coordinates are included, and we don't have an exact/sibling match\n  DOCUMENT_COORDINATES = 'document_coordinates',\n  // If we weren't able to annotate, so we're instead relying on the screenshot\n  // Examples: annotating a pdf, annotating an iframe we can't access\n  UNAVAILABLE = 'unavailable',\n  // If the annotation was on an inaccessible cross-domain iframe. We want to\n  // show it while the message is being drafted, but not after it's been posted\n  INACCESSIBLE_CROSS_DOMAIN_IFRAME = 'inaccessible_cross_domain_iframe',\n  OUTSIDE_ACCESSIBLE_VIRTUALISED_LIST = 'outside_accessible_virtualised_list',\n  OUTSIDE_INACCESSIBLE_VIRTUALISED_LIST = 'outside_inaccessible_virtualised_list',\n}\n\nexport function annotationHasLocation(annotation: MessageAnnotation) {\n  return annotation.location !== null || annotation.customLocation !== null;\n}\n\nexport const ThreadCreatedTypeName = 'ThreadCreated';\nexport const ThreadMessageAddedTypeName = 'ThreadMessageAdded';\nexport const ThreadMessageUpdatedTypeName = 'ThreadMessageUpdated';\nexport const ThreadMessageContentAppendedTypeName =\n  'ThreadMessageContentAppended';\nexport const ThreadMessageRemovedTypeName = 'ThreadMessageRemoved';\nexport const ThreadParticipantsUpdatedIncrementalTypeName =\n  'ThreadParticipantsUpdatedIncremental';\nexport const ThreadTypingUsersUpdatedTypeName = 'ThreadTypingUsersUpdated';\nexport const ThreadShareToSlackTypeName = 'ThreadShareToSlack';\nexport const ThreadPropertiesUpdatedTypeName = 'ThreadPropertiesUpdated';\nexport const ThreadSubscriberUpdatedTypeName = 'ThreadSubscriberUpdated';\nexport const ThreadDeletedTypeName = 'ThreadDeleted';\n\nexport const PageThreadAddedTypeName = 'PageThreadAdded';\nexport const PageThreadDeletedTypename = 'PageThreadDeleted';\nexport const PageThreadReplyAddedTypeName = 'PageThreadReplyAdded';\nexport const PageVisitorsUpdatedTypeName = 'PageVisitorsUpdated';\nexport const PageThreadResolvedTypeName = 'PageThreadResolved';\nexport const PageThreadUnresolvedTypeName = 'PageThreadUnresolved';\nexport const ThreadFilterablePropertiesMatchTypeName =\n  'ThreadFilterablePropertiesMatch';\nexport const ThreadFilterablePropertiesUnmatchTypeName =\n  'ThreadFilterablePropertiesUnmatch';\n\nexport const NotificationAddedTypeName = 'NotificationAdded';\nexport const NotificationReadStateUpdatedTypeName =\n  'NotificationReadStateUpdated';\nexport const NotificationDeletedTypeName = 'NotificationDeleted';\n\nexport const OrgMemberAddedTypeName = 'OrgMemberAdded';\nexport const OrgMemberRemovedTypeName = 'OrgMemberRemoved';\n\nexport const ConsoleGettingStartedUpdatedTypeName =\n  'ConsoleGettingStartedUpdated';\n\nexport const CustomerSubscriptionUpdatedTypeName =\n  'CustomerSubscriptionUpdated';\n\nexport type FileAttachmentInput = {\n  id: UUID;\n  fileID: UUID;\n};\n\n// Subset of winston log levels, which can be found in NpmConfigSetLevels type in winston type file\nexport enum LogLevel {\n  ERROR = 'error',\n  WARN = 'warn',\n  INFO = 'info',\n  DEBUG = 'debug',\n}\n\nexport type PopperPosition = Placement;\n\n// called when the sidebar shows and hides, with a reference to the Cord iframe\n// expected to make domain-specific document adjustments to accommodate the sidebar\n// in its two states (expanded / not).\nexport type DocumentMutator = (width: number | null) => void;\n\n// called with the document to initialize any mutator-specific elements and behavior\n// expected to return the actual mutator function\nexport type DocumentMutatorInitializer = (\n  document: Document,\n) => DocumentMutator;\n\nexport type SimpleValue = string | number | boolean;\n\nexport type PreferencesValueType = JsonValue;\n\nexport type PreferencesType = JsonObject;\n\nexport enum UserReference {\n  MENTION = 'mention',\n  ASSIGNEE = 'assignee',\n}\n\nexport type RuleProviderInfo = {\n  id: UUID; // the ID of the provider, should be unique among providers\n  name: string; // the name of the provider\n  iconURL?: string | null; // URL for a favicon-like image\n  nuxText?: string | null; // the text to show the user teaching them how to use Radical on this specific provider\n  disableAnnotations?: boolean; // if annotations should be disabled for this provider. example: slack static PDFs where due to the chrome pdf viewer we don't have access to the scroll position\n};\n\n// a ruleset provider should export all the rules specific to a SaaS, even when\n// those rules span across different domain names.\nexport type RuleProvider = RuleProviderInfo & {\n  domains: string[]; // the domains that this provider's rules cover\n  rules: ProviderRule[]; // deny and approve rules\n  mergeHashWithLocation?: boolean; // a fix for providers like Snowflake who have URLs with query parameters after the # in the URL\n  visibleInDiscoverToolsSection: boolean; // the state of wether the tool is visible in th Discover tools section in the NUX flow, i.e. internal tools should not be included, localhost should not be included\n  platformApplicationID: UUID | null; // Application ID of provider, if relevant\n\n  // the functions to call to mutate the document to make room for the sidebar.\n  // this is a list to allow per-domain granularity.\n  documentMutators: ProviderDocumentMutator[];\n};\n\nexport type ProviderRule = {\n  id: UUID;\n  type: ProviderRuleType;\n  matchPatterns: ProviderRuleMatchPatterns;\n  nameTemplate: string | null;\n  contextTransformation: PageContextTransformation;\n  observeDOMMutations: boolean;\n};\n\nexport type ProviderDocumentMutator =\n  | { id: UUID; type: 'default_css'; config: CSSMutatorConfig }\n  | { id: UUID; type: 'custom_css'; config: CSSMutatorConfig }\n  | { id: UUID; type: 'fixed_elements'; config: null };\n\nexport type ProviderDocumentMutatorType = ProviderDocumentMutator['type'];\n\nexport type CSSMutatorConfig = {\n  cssTemplate: string;\n};\n\nexport type ProviderRuleType = 'allow' | 'deny';\n\nexport type ProviderRuleMatchPatterns = {\n  protocol?: string;\n  domain?: string;\n  path?: string;\n  hash?: string;\n  queryParams?: { [key: string]: string };\n  selector?: string;\n  contains?: string;\n};\n\nexport type ProviderRuleTestMatchType = 'allow' | 'deny' | 'none';\n\nexport type PageDetails = {\n  pageContext: PageContext;\n  pageName: string | null;\n};\n\nexport type MatchResult = (\n  | {\n      match: 'allow' | 'deny';\n      ruleID: UUID;\n    }\n  | {\n      match: 'none';\n    }\n) &\n  PageDetails;\n\nexport type PageContextTransformationType =\n  | 'default'\n  | 'replace'\n  | 'extend'\n  | 'metabase';\n\nexport type PageContextTransformation = {\n  type: PageContextTransformationType;\n  data: JsonObject | null;\n};\n\nexport type ProvidersResult = {\n  ruleProviders: RuleProvider[];\n  version: string;\n};\n\nexport type DeepPartial<T> = {\n  [P in keyof T]?: DeepPartial<T[P]>;\n};\n\nexport type LinearTeam = {\n  id: string;\n  name: string;\n  projects: {\n    nodes: Array<{\n      id: string;\n      name: string;\n    }>;\n  };\n};\n\nexport type AtlassianProject = {\n  // expand: 'description,lead,issueTypes,url,projectKeys,permissions,insight',\n  id: string; // 10000\n  key: string; // STLR\n  name: string; // 'Stellar'\n  issueTypes: Array<{\n    id: string; //'10001'\n    // description: 'Tasks track small, distinct pieces of work.';\n    name: string;\n    subtask: boolean;\n    // avatarId: 10318;\n    // hierarchyLevel: 0;\n  }>;\n  simplified: boolean;\n  style: string; // 'next-gen'\n  isPrivate: boolean;\n  entityId: UUID;\n  uuid: UUID;\n};\n\nexport type MondayBoard = {\n  id: string;\n  name: string;\n  subitem_board?: {\n    id: string;\n  };\n  groups: Array<{\n    id: string;\n    title: string;\n    position: string;\n  }>;\n};\n\nexport type JiraConnectionPreferences = {\n  projectID: string;\n  issueType: string;\n  subissueType?: string;\n};\n\nexport type AsanaConnectionPreferences = {\n  projectID: string | undefined;\n};\n\nexport type MondayConnectionPreferences = {\n  boardID: string;\n  groupID?: string;\n};\n\ntype TrelloList = {\n  id: UUID;\n  name: string;\n  closed?: string;\n  pos?: number;\n  softLimit?: string;\n  idBoard?: UUID;\n  subscriber: boolean;\n};\n\ntype TrelloBoard = {\n  id: UUID;\n  name: string;\n  idOrganization: UUID;\n  lists: TrelloList[];\n};\n\ntype TrelloOrg = {\n  id: UUID;\n  name: string;\n};\n\nexport type TrelloConnectionPreferencesType = {\n  id: UUID;\n  email: string;\n  boards: TrelloBoard[];\n  organizations: TrelloOrg[];\n};\n\nexport type TrelloCard = {\n  name: string;\n  desc: string;\n  idList: UUID;\n};\n\nexport type AsanaProject = {\n  gid: string;\n  name: string;\n};\n\nexport type JiraIssuePreviewData = {\n  key: string;\n  title: string;\n  url: string;\n  assignee: string | undefined;\n  status: string;\n  done: boolean;\n  priority: string;\n  subtasks: Array<{\n    id: string;\n    title: string;\n    done: boolean;\n  }>;\n};\n\nexport type AsanaTaskPreviewData = {\n  title: string;\n  url: string;\n  assignee: string | undefined;\n  done: boolean;\n};\n\nexport type LinearIssuePreviewData = {\n  title: string;\n  identifier: string;\n  url: string;\n  assignee: string | undefined;\n  status: string;\n  priority: string;\n  done: boolean;\n  orgName: string | undefined;\n};\n\nexport type MondayItemPreviewData = {\n  title: string;\n  url: string;\n  assignee: string | undefined;\n  done: boolean;\n  assigneeColumnID: string | undefined;\n  statusColumnID: string | undefined;\n};\n\nexport type TaskPreviewData =\n  | AsanaTaskPreviewData\n  | JiraIssuePreviewData\n  | LinearIssuePreviewData\n  | MondayItemPreviewData;\n\nexport enum LinearIssueStateTypes {\n  BACKLOG = 'backlog',\n  TODO = 'unstarted',\n  IN_PROGRESS = 'started',\n  DONE = 'completed',\n  CANCELED = 'canceled',\n}\n\nexport type LinearConnectionPreferences = {\n  teamID: string;\n  projectID?: string;\n};\n\nexport type APICordTokenData = {\n  session_id: UUID;\n};\n\nexport type AppServerAuthTokenData = {\n  app_id: UUID;\n};\n\nexport type CustomerServerAuthTokenData = {\n  customer_id: UUID;\n};\n\nexport type NotificationChannels = {\n  slack: boolean;\n  email: boolean;\n};\n\nexport type CustomLinks = {\n  learnMore?: string | null;\n  upgradePlan?: string | null;\n  leaveFeedback?: string | null;\n};\n\nexport type ThirdPartyAuth = 'slack' | 'google' | 'ms-teams';\n\nexport type OutboundNotificationType =\n  | 'slack'\n  | 'email'\n  | 'slackEmailMatched'\n  | 'sharedToSlackChannel'\n  | 'sharedToEmail';\n\nexport type { Point2D } from '@cord-sdk/types';\n\nexport type CustomNUXStepContent = {\n  title: string | null;\n  text: string | null;\n  imageURL: string | null;\n};\n\nexport type CustomNUX = {\n  initialOpen: CustomNUXStepContent | null;\n  welcome: CustomNUXStepContent | null;\n};\n\nexport type SlackOAuthLinkOrgState = {\n  data: {\n    userID: string;\n    orgID: string;\n    platformApplicationID: string;\n  };\n  type: 'link_org';\n  nonce: string;\n};\n\nexport type SlackOAuthConsoleUserState = {\n  data: {\n    platformApplicationID: string;\n  };\n  type: 'console_user';\n  nonce: string;\n};\n\nexport type SlackOAuthDecodeState =\n  | SlackOAuthLinkOrgState\n  | SlackOAuthConsoleUserState;\n\nexport type ThreadSupportStatusType = 'open' | 'closed';\n\nexport type UserWithOrgDetails = {\n  id: UUID;\n  externalID: string;\n  displayName: string;\n  fullName: string;\n  name: string | null;\n  shortName: string | null;\n  profilePictureURL: string | null;\n  metadata: EntityMetadata;\n  canBeNotifiedOnSlack: boolean;\n};\n\nexport type OutboundNotificationMetadata =\n  OutboundNotificationMetadataByType[OutboundNotificationType];\n\n// when adding new fields to existing metadata types, either make the new\n// fields optional or run a backfill migration\nexport type OutboundNotificationMetadataByType = {\n  slack: Record<string, never>;\n  email: Record<string, never>;\n  slackEmailMatched: Record<string, never>;\n  sharedToSlackChannel: {\n    type: 'sharedToSlackChannel';\n    targetSlackChannelID: string;\n  };\n  sharedToEmail: {\n    type: 'sharedToEmail';\n    targetEmail: string;\n  };\n};\n\n// Internal threads are the standard mirrored Slack threads\n// that users can share to their linked Slack org.\n// Support threads are the ones mirrored to a vendor's Slack org\n// and support channel after a support bot is mentioned.\nexport type ThreadMirrorType = 'internal' | 'support';\n\nexport type Tier = 'prod' | 'staging' | 'test' | 'dev';\n\nexport type SharedToSlackInfo = {\n  channel: string | null;\n  slackURL: string | null;\n};\n\nexport type ThreadMode =\n  // Only shows the first message, and optionally the number of replies\n  | 'collapsed'\n  // Can show all messages, also includes a composer to add a new message\n  | 'inline'\n  // Used in the sidebar only - thread spans across the whole page\n  | 'fullHeight'\n  // The initial state when we are creating a new thread - composer only\n  | 'newThread';\n\nexport type Announcement =\n  | 'welcome'\n  | 'completeProfile'\n  | 'connectOrgToSlack'\n  | 'linkProfileToSlack'\n  | 'slackIsConnected';\n\nexport type ReferencedUserData = { id: UUID; name: string };\n\nconst DEPLOYMENT_TYPES = ['sdk'] as const;\n\nexport type DeploymentType = (typeof DEPLOYMENT_TYPES)[number];\n\nexport function isDeploymentType(s: string): s is DeploymentType {\n  if (DEPLOYMENT_TYPES.includes(s as DeploymentType)) {\n    return true;\n  }\n  return false;\n}\n\nexport function toDeploymentType(\n  s: string | null | undefined,\n): DeploymentType | null {\n  if (s && isDeploymentType(s)) {\n    return s;\n  }\n  return null;\n}\n\nexport type ApplicationEnvironment =\n  | 'production'\n  | 'staging'\n  | 'sample' // console self-serve test (not paying) app\n  | 'sampletoken' // sample token apps created for docs integration guide and demo apps opensource repos (wiped periodically)\n  | 'demo'; // temporary token apps created for docs and cord.com demo apps (wiped periodically)\n\n// NB you there are some classes of token you might expect are environments,\n// but actually all belong to one appID:\n// The docs live components are all in the CORD_DOCS_SAMPLE_TOKEN_APPLICATION_ID app\n// The e2e tests are all in the CORD_AUTOMATED_TESTS_APPLICATION_ID app\n// The CORD_PLAYGROUND_APPLICATION_ID has been retired from service\n\nexport type EmptyJsonObject = Record<string, never>;\n\nexport type CustomerType = 'verified' | 'sample';\n\nexport type CustomerImplementationStage =\n  | 'launched'\n  | 'implementing'\n  | 'proof_of_concept'\n  | 'inactive';\n\nexport type AdminCRTComingFrom = 'them' | 'us';\n\nexport type AdminCRTDecision = 'done' | 'accepted' | 'rejected' | 'pending';\n\nexport type AdminCRTCommunicationStatus =\n  | 'none'\n  | 'request_acked'\n  | 'decision_sent'\n  | 'decision_acked';\n\nexport type AdminCRTIssueType = 'request' | 'bug' | 'onboarding_step';\n\nexport type AdminCRTPriority = 'blocker' | 'high' | 'low';\n\nexport type AdminCRTCustomerIssue = {\n  customerID: UUID;\n  title: string;\n  body: string;\n  comingFrom: AdminCRTComingFrom;\n  decision: AdminCRTDecision;\n  communicationStatus: AdminCRTCommunicationStatus;\n  lastTouch?: string;\n  type: AdminCRTIssueType;\n  priority: AdminCRTPriority;\n  externallyVisible: boolean;\n  assignee?: UUID;\n};\n\nexport type DocsCachedEmbedding = {\n  url: string;\n  plaintext: string;\n  embedding?: OpenAI.CreateEmbeddingResponse | undefined;\n};\n\nexport type CordDotComCachedEmbedding = DocsCachedEmbedding & {\n  title: string;\n};\n\n// This is for the mouse move events within iframes\nexport type IframeMouseMoveData = { x: number; y: number; frame_id: string };\n\nexport type Maybe<T> = T | null | undefined;\nexport type Nullable<T> = T | null;\n", "import { Table, Column, Model } from 'sequelize-typescript';\nimport { DataTypes } from 'sequelize';\nimport type { UUID } from 'common/types/index.ts';\n\n@Table({\n  tableName: 'email_notifications',\n  timestamps: false,\n})\nexport class EmailOutboundNotificationEntity extends Model {\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n    primaryKey: true,\n    defaultValue: DataTypes.UUIDV4,\n  })\n  id!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n  })\n  userID!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n  })\n  orgID!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n  })\n  threadOrgID!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n  })\n  threadID!: UUID;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: false,\n  })\n  email!: string;\n}\n", "import addrs from 'email-addresses';\nimport isUUID from 'validator/lib/isUUID.js';\nimport replyParser from 'node-email-reply-parser';\nimport type { MessageContent, UUID } from 'common/types/index.ts';\nimport { MessageNodeType } from 'common/types/index.ts';\nimport { anonymousLogger } from 'server/src/logging/Logger.ts';\nimport type { Logger } from 'server/src/logging/Logger.ts';\nimport { EmailOutboundNotificationEntity } from 'server/src/entity/email_notification/EmailOutboundNotificationEntity.ts';\n\n// Parses an email address such as \"sponge@bob.com\" or\n// \"Sponge Bob <sponge@bob.com>\"\nexport function parseEmailAddress(emailAddress: string): addrs.ParsedMailbox {\n  const parsedAddress = addrs\n    .parseAddressList(emailAddress)\n    ?.find((email): email is addrs.ParsedMailbox => email.type === 'mailbox');\n  if (parsedAddress === undefined) {\n    throw new Error(`failed to parse email address: ${emailAddress}`);\n  }\n  return parsedAddress;\n}\n\n/**\n * Takes a sender email address and a notification ID, and returns a reply-to\n * email address such that replies to that address will be appended to the\n * thread associated with the notification ID.\n */\nexport function getReplyToEmailAddress(\n  logger: Logger,\n  senderEmailAddress: string,\n  notificationId: UUID,\n): string {\n  try {\n    const parsedAddress = parseEmailAddress(senderEmailAddress);\n\n    // Applications can use a white-label (non-@cord.fyi) sender email. That's\n    // fine, but replies MUST come via cord.fyi; those emails get routed through\n    // SendGrid, who call a webhook (search this repo for\n    // SendGridWebhookHandler) so we can handle them and e.g. append reply\n    // contents to the appropriate thread.\n    const replyToAddress = `${parsedAddress.local}-${notificationId}@cord.fyi`;\n    if (parsedAddress.name) {\n      return `${parsedAddress.name} <${replyToAddress}>`;\n    }\n    return replyToAddress;\n  } catch (e) {\n    logger.logException('failed to parse email address', e);\n    return senderEmailAddress;\n  }\n}\n\n// If email name ends with \"-UUID\" then it returns that UUID\nexport function extractCordEmailUUID(emailAddress: string): UUID | null {\n  try {\n    const parsedAddress = parseEmailAddress(emailAddress);\n    const uuidLength = 36;\n    // check that the address ends with a dash \"-\" and then 36 UUID characters\n    if (\n      parsedAddress.local.length < 1 + uuidLength ||\n      parsedAddress.local.slice(-(1 + uuidLength))[0] !== '-'\n    ) {\n      return null;\n    }\n    const maybeUUID = parsedAddress.local.slice(-uuidLength);\n    return isUUID.default(maybeUUID) ? maybeUUID : null;\n  } catch (e) {\n    anonymousLogger().logException(\n      'failed to parse email address',\n      e,\n      {},\n      undefined,\n      'warn',\n    );\n    return null;\n  }\n}\n\nexport function emailTextToMessageContent(\n  emailText: string,\n  attachments: string,\n): MessageContent {\n  // Unlike Gmail, Mac Mail does not automatically add a standard email\n  // signature separator like '--' at the begining of a signature block\n  // so our library was not detecting it as such.\n  // As a result, we were sending the signature as part of the reply message.\n\n  // To overcome this, we break up the email content into fragments and\n  // disregard anything that comes after the quoted text reply.\n  // Unfortunately, this will still be an issue for users who add their\n  // signatures above the quoted text and have no signature separator.\n  const replyFragments = replyParser(emailText).getFragments();\n  let replyBeforeQuotedText = '';\n  for (const fragment of replyFragments) {\n    if (fragment.isQuoted()) {\n      break;\n    }\n    replyBeforeQuotedText += fragment.getContent();\n  }\n\n  let replyText = replyParser(replyBeforeQuotedText).getVisibleText({\n    // from the docs of replyParser:\n    // Using aggressive mode runs the risk of losing visible lines which are\n    // interspersed with quoted lines, but is useful when parsing e.g. emails\n    // from a 'reply by email' feature which contain a large block of quoted\n    // text.\n    aggressive: true,\n  });\n\n  if (Number(attachments) > 0) {\n    replyText = replyText + `\\n(Unable to display attached files)`;\n  }\n\n  return replyText\n    .split(/\\r?\\n/)\n    .filter((l) => l.length > 0)\n    .map((line) => ({\n      type: MessageNodeType.PARAGRAPH,\n      children: [{ text: line }],\n    }));\n}\n\nexport async function getNotification(\n  toAddress: string,\n  inReplyToHeader: string | undefined,\n  fromEmail: string,\n  logger: Logger,\n) {\n  const notificationID = extractCordEmailUUID(toAddress);\n  if (notificationID) {\n    return await EmailOutboundNotificationEntity.findOne({\n      where: { id: notificationID },\n    });\n  }\n\n  if (inReplyToHeader) {\n    // Some mail clients, like Hubspot, do not respect the Reply-To email header\n    // and send their reply to the From header, which does not contain our notification\n    // ID.  In that case, we can try and pull out the ID we set in the 'Message-ID'\n    // header, which will now be the 'In-Reply-To' header in the incoming email\n    // (see getThreadingHeaders fn: these are headers which are used to thread\n    // messages nicely in email clients). This will either be the notification ID\n    // or thread ID, depending on whether this was a first notification or not.\n    // With the combination of the thread ID and the email this message came from,\n    // we should be able to find the Notification.\n    logger.debug(\n      'Unable to find notificationId in toAddress, will try to find from inReplyTo header',\n      {\n        toAddress,\n        inReplyToHeader,\n        fromEmail,\n      },\n    );\n\n    const threadOrNotificationID = extractCordEmailUUID(inReplyToHeader);\n\n    // First see if the ID we found is a notification ID\n    if (threadOrNotificationID) {\n      const notification = await EmailOutboundNotificationEntity.findOne({\n        where: { id: threadOrNotificationID },\n      });\n      if (notification) {\n        return notification;\n      }\n    }\n\n    let parsedFromEmail;\n\n    try {\n      const email = parseEmailAddress(fromEmail);\n      parsedFromEmail = email.address;\n    } catch (e: any) {\n      logger.warn('Error parsing from email', e);\n    }\n\n    // If we're still here, it wasn't a notification ID (or the notification has\n    // disappeared for some reason).  Assume it's a thread ID:\n    if (threadOrNotificationID && parsedFromEmail) {\n      return await EmailOutboundNotificationEntity.findOne({\n        where: { threadID: threadOrNotificationID, email: parsedFromEmail },\n      });\n    }\n  }\n\n  return null;\n}\n\nfunction getHeader(key: string, input: string) {\n  const pattern = new RegExp(`^${key}: (.+)$`, 'gm');\n  const match = pattern.exec(input);\n\n  return match?.[1];\n}\n\nexport type RelevantHeaders =\n  | Record<'messageID' | 'inReplyTo' | 'autoSubmitted', string | undefined>\n  | undefined;\n\n// We could use the mailparser npm package to do this but it would also require\n// adding another library as middleware (https://github.com/nodemailer/mailparser/issues/253)\n// and it didn't seem worth it for grabbing a couple of strings\n// Add more headers you might expect to find if you need them!\nexport function parseRelevantHeaders(headersString: string): RelevantHeaders {\n  // This is a specific ID for this incoming email and would be something like:\n  // '<CACnco=B99bM4+YPHkUNqgPT8azMcYCROss2BdPgA7pAoqW8egw@mail.gmail.com>',\n  const messageID = getHeader('Message-Id', headersString);\n  // This should be the Message-ID we set on the original email notification, which\n  // contains the threadID. See getThreadingHeaders.\n  const inReplyTo = getHeader('In-Reply-To', headersString);\n  // This is a header that should be set if a reply is automated, e.g. an OOO\n  const autoSubmitted = getHeader('Auto-Submitted', headersString);\n\n  return { messageID, inReplyTo, autoSubmitted };\n}\n", "import { Table, Column, PrimaryKey, Model } from 'sequelize-typescript';\nimport { DataTypes } from 'sequelize';\nimport type { UUID, JsonObject, Tier } from 'common/types/index.ts';\nimport type { Session } from 'server/src/auth/index.ts';\n\n@Table({\n  tableName: 'events',\n  timestamps: false,\n})\nexport class EventEntity extends Model {\n  @PrimaryKey\n  @Column({\n    type: DataTypes.UUID,\n    defaultValue: DataTypes.UUIDV4,\n  })\n  id!: UUID;\n\n  // The unique load of the page/DOM instance (i.e. window/DOM object) where\n  // the event was generated\n  @Column({\n    type: DataTypes.UUID,\n  })\n  pageLoadID!: UUID;\n\n  // The unique id of the extension installation\n  @Column({\n    type: DataTypes.UUID,\n  })\n  installationID!: UUID | null;\n\n  // The version of the client logging this event\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  version!: string | null;\n\n  // The version of the client logging this event\n  @Column({\n    type: DataTypes.JSONB,\n  })\n  utmParameters!: Session['utmParameters'] | null;\n\n  // The logged-in user when the event was generated (if there was one)\n  @Column({\n    type: DataTypes.UUID,\n  })\n  userID!: UUID | null;\n\n  // The user profile when the event was generated (if there was one)\n  @Column({\n    type: DataTypes.UUID,\n  })\n  orgID!: UUID | null;\n\n  // The platformApplicationID when the event was generated (if there was one)\n  @Column({\n    type: DataTypes.UUID,\n  })\n  platformApplicationID!: UUID | null;\n\n  // A monotically increasing (and usually sequential) index starting\n  // from zero at the beginning of the page that should help clarify\n  // the order of events in the case that the timestamps are inscrutable or too\n  // close to call.\n  @Column({\n    type: DataTypes.NUMBER,\n  })\n  eventNumber!: number;\n\n  // The timestamp as reported by the client (untrustworthy)\n  @Column({\n    type: DataTypes.TIME,\n  })\n  clientTimestamp!: Date;\n\n  // The timestamp for when the event reached the server (not\n  // guaranteed to be the time the event happened due to batching\n  // on the client)\n  @Column({\n    type: DataTypes.TIME,\n  })\n  serverTimestamp!: Date;\n\n  // An arbitrary label to differentiate this event\n  @Column({\n    type: DataTypes.STRING,\n  })\n  type!: string;\n\n  // An arbitrary data payload to send along with the event. Please\n  // be sane about what you log here. Think in 10s of bytes, not in\n  // kilobytes or megabytes.\n  @Column({\n    type: DataTypes.JSONB,\n    defaultValue: {},\n  })\n  payload!: JsonObject;\n\n  // A rich set of characteristics about the browser when the event\n  // generated.\n  @Column({\n    type: DataTypes.JSONB,\n    defaultValue: {},\n  })\n  metadata!: JsonObject;\n\n  @Column({\n    type: DataTypes.ENUM('prod', 'staging', 'test', 'dev'),\n    allowNull: false,\n    primaryKey: true,\n  })\n  tier!: Tier;\n}\n", "// General sizing\nconst XSMALL = 2;\nconst SMALL = 4;\nconst MEDIUM = 8;\nconst LARGE = 16;\nconst XLARGE = 24;\nconst XXLARGE = 32;\nconst XXXLARGE = 48;\n\nconst AVATAR_BORDER_WIDTH_PX = XSMALL;\n\nconst CHECKBOX_DEFAULT_SIZE_PX = LARGE;\nconst MAIN_CHAT_AVATAR_SIZE_PX = XLARGE + AVATAR_BORDER_WIDTH_PX * 2;\nconst MAIN_CHAT_AVATAR_MARGIN_RIGHT_PX = MEDIUM;\n\nexport const Sizes = {\n  // Sidebar\n  SIDEBAR_COMPACT_WIDTH: 312, // used when viewport width is <= VIEWPORT_WIDTH_BREAKPOINT\n  SIDEBAR_NORMAL_WIDTH: 416, // used when viewport width is > VIEWPORT_WIDTH_BREAKPOINT\n  SIDEBAR_MAX_WIDTH: 500,\n  VIEWPORT_WIDTH_BREAKPOINT: 1440,\n\n  // Navigation top bar\n  NAVIGATION_ITEM_SPACING_COMPACT: 12,\n  NAVIGATION_ITEM_SPACING_NORMAL: LARGE,\n\n  // subtract MEDIUM here, add it to the sidebar App.tsx container paddingBottom, to allow shadows to be visible\n  SIDEBAR_BOTTOM_SPACE: 96 - MEDIUM,\n\n  // Text\n  X_SMALL_TEXT_SIZE_PX: 10,\n  SMALL_TEXT_SIZE_PX: 12,\n  DEFAULT_TEXT_SIZE_PX: 14,\n  LARGE_TEXT_SIZE_PX: 18,\n  X_LARGE_TEXT_SIZE_PX: 24,\n  SMALL_LINE_HEIGHT_PX: 16,\n  DEFAULT_LINE_HEIGHT_PX: 20,\n  LARGE_LINE_HEIGHT_PX: 24,\n  X_LARGE_LINE_HEIGHT_PX: 32,\n  BOLD_TEXT_WEIGHT: 700,\n  NORMAL_TEXT_WEIGHT: 400,\n\n  // Spacing\n  SMALL_PADDING_PX: 6,\n  DEFAULT_PADDING_PX: 12,\n\n  DEFAULT_BORDER_RADIUS: SMALL,\n  LARGE_BORDER_RADIUS: MEDIUM,\n  SMALL_BORDER_RADIUS: XSMALL,\n\n  // Icon\n  DEFAULT_ICON_PADDING_PX: 4,\n\n  // Profile pics\n  PAGE_VISITORS_AVATAR_SIZE_PX: XLARGE + AVATAR_BORDER_WIDTH_PX * 2,\n  MAIN_CHAT_AVATAR_SIZE_PX,\n  MAIN_CHAT_AVATAR_MARGIN_RIGHT_PX,\n  MESSAGE_LEFT_PADDING:\n    MAIN_CHAT_AVATAR_SIZE_PX + MAIN_CHAT_AVATAR_MARGIN_RIGHT_PX,\n  AVATAR_BORDER_WIDTH_PX,\n  FACEPILE_AVATAR_OVERLAP_SIZE_PX: SMALL,\n  NOTIFICATION_FACEPILE_SIZE: LARGE + AVATAR_BORDER_WIDTH_PX * 2,\n\n  // Composer\n  COMPOSER_ADD_BUTTON_HEIGHT_PX: XXLARGE,\n  COMPOSER_ADD_BUTTON_WIDTH_PX: XXLARGE,\n  COMPOSER_HORIZONTAL_PADDING: MEDIUM,\n  COMPOSER_VERTICAL_PADDING: 18,\n  MAX_COMPOSER_EDITOR_HEIGHT: 448,\n\n  // Messages\n  MESSAGE_BLOCK_BOTTOM_MARGIN: XLARGE,\n  MESSAGE_BOTTOM_MARGIN: MEDIUM * 1.5,\n  MESSAGE_CONTENTS_TOP_MARGIN: 5,\n  MESSAGE_PARAGRAPH_TOP_MARGIN: MEDIUM,\n  MESSAGE_REACTIONS_TOP_MARGIN: SMALL,\n  MESSAGE_REACTIONS_BOTTOM_MARGIN: -MEDIUM,\n  MESSAGE_SEEN_BY_BOTTOM_MARGIN: MEDIUM,\n  MESSAGE_REACTIONS_FACEPILE_OVERLAP: 6,\n  MESSAGE_PAST_REACTION_HEIGHT: LARGE,\n  MESSAGE_ANNOTATION_HEIGHT_PX: 40,\n  MESSAGES_KEBAB_MENU_WIDTH_PX: 196,\n  MESSAGE_HEIGHT_TRUNCATE_AT_PX: 300,\n  MESSAGE_HEIGHT_TRUNCATE_TO_PX: 200,\n  INFINITE_SCROLL_THRESHOLD_PX: 400,\n  MESSAGE_ATTACHMENT_PLACEHOLDER_HEIGHT_PX: 92,\n  // 277 is the height of kebab menu for your own message, with one line of 'seen by'\n  // We set the minHeight of the share to slack menu to this\n  MIN_KEBAB_SLACK_MENU_HEIGHT: 277,\n  // Distance between kebab menu and kebab menu icon\n  KEBAB_MENU_OFFSET: SMALL,\n\n  // Bullets / numbered / todo lists\n  BULLET_PADDING_LEFT: CHECKBOX_DEFAULT_SIZE_PX + MEDIUM,\n\n  // Todo - feed this into the menu itself (prob via more dynamic svg)\n  MESSAGE_MENU_HEIGHT: 32,\n\n  // Tooltip\n  TOOLTIP_HORIZONTAL_PADDING_PX: MEDIUM,\n  TOOLTIP_VERTICAL_PADDING_PX: SMALL,\n  TOOLTIP_LINE_HEIGHT_PX: LARGE,\n  TOOLTIP_MAX_WIDTH_PX: 180,\n  ANNOTATION_TOOLTIP_MAX_WIDTH_PX: 180,\n\n  // Attachments\n  ATTACHMENT_THUMBNAIL_PX: 58,\n  PDF_ATTACHMENT_PX: 90,\n\n  // Modal\n  MODAL_SELECT_CHANNELS_MAX_HEIGHT_PX: 240,\n\n  // ImageModal\n  IMAGE_MODAL_SMALL_SCALE: 0.66,\n  IMAGE_MODAL_BUTTON_HEIGHT_SCALE_PX: 40,\n  IMAGE_MODAL_MENU_MAX_WIDTH_PX: 180,\n  IMAGE_MODAL_MENU_TOP_POSITION_PX: 44,\n\n  // Success Popup\n  SUCCESS_POPUP_HEIGHT: 36,\n\n  // Annotation pointer\n  ANNOTATION_POINTER_MIN_GAP_VS_SCREEN_EDGE: MEDIUM,\n  ANNOTATION_POINTER_SMALL_SIZE_PX: 34, // 32 + 1 for border on each side, which is included in the svg\n\n  // Annotation arrow\n  ANNOTATION_ARROW_CIRCLE_RADIUS: 4,\n  ANNOTATION_ARROW_HORIZONTAL_MARGIN_FOR_TOOLTIP: XXLARGE,\n\n  // Charts in webpage\n  MIN_CHART_SIZE_PX: 50,\n  MAX_CHART_CONTAINER_SIZE_RATIO: 1.25,\n\n  // Login\n  LOGIN_BUTTON_WIDTH_PX: 354,\n  LOGIN_BUTTON_HEIGHT_PX: 56,\n  LOGIN_MARGIN_PX: 56,\n  LOGIN_BUTTON_TEXT_SIZE_PX: 18,\n  LOGIN_TITLE_TEXT_SIZE_PX: 36,\n  EMAIL_PROMPT_HEIGHT_PX: 128,\n  EMAIL_PROMPT_INPUT_VERTICAL_PADDING_PX: 14,\n\n  // Welcome\n  WELCOME_PARAGRAPH_MAX_WIDTH_PX: 400,\n  WELCOME_VIDEO_MAX_HEIGHT_PX: 300,\n  WELCOME_VIDEO_MAX_WIDTH_PX: 600,\n\n  // Workspace\n  WORKSPACE_HORIZONTAL_MARGIN_PX: 56,\n  WORKSPACE_VERTICAL_GAP_PX: 40,\n  WORKSPACE_VERTICAL_GAP_SMALL_PX: 32,\n  WORKSPACE_SMALL_PADDING_PX: 12,\n  WORKSPACE_XSMALL_PADDING_PX: 6,\n  WORKSPACE_PARAGRAPH_MAX_WIDTH_PX: 480,\n  WORKSPACE_WIDTH_PX: 576,\n  WORKSPACE_LOGIN_WIDTH_PX: 640,\n  WORKSPACE_LOGIN_BUTTON_HEIGHT_PX: 48,\n  WORKSPACE_LOGIN_ORG_IMAGE_SIZE_PX: XXXLARGE,\n  WORKSPACE_GET_STARTED_STEP_MAX_WIDTH_PX: 290,\n  WORKSPACE_GET_STARTED_STEP_MIN_WIDTH_PX: 230,\n  RECENTLY_SHARED_MIN_WIDTH_PX: 120,\n  RECENTLY_SHARED_MAX_WIDTH_PX: 240,\n  UPDATES_MAX_WIDTH_PX: 320,\n\n  // Extension popup\n  EXTENSION_POPUP_WIDTH: 360,\n  EXTENSION_POPUP_HEIGHT: 540,\n  EXTENSION_POPUP_START_CONVERSATION_BUTTON_HEIGHT: 60,\n\n  SPINNER_DEFAULT_HEIGHT_PX: 20,\n  SPINNER_LARGE_HEIGHT_PX: 40,\n  CHECKBOX_DEFAULT_SIZE_PX,\n\n  DEFAULT_ICON_SIZE: 24,\n  SMALL_ICON_SIZE: 16,\n  X_SMALL_ICON_SIZE: 12,\n\n  DEFAULT_BORDER_WIDTH: 1,\n\n  COLLAPSED_THREAD_MESSAGE_HEIGHT: 44,\n  ADD_THREAD_BUTTONS_HEIGHT: 60,\n  GAP_BETWEEN_THREADS: XLARGE,\n  GAP_BETWEEN_GROUPED_THREADS: MEDIUM,\n  LOAD_OLDER_MESSAGES_BUTTON_HEIGHT: 33,\n\n  THREAD_MESSAGE_PADDING: MEDIUM,\n\n  SCREENSHOT_BLUR_PX: 10,\n\n  //Screen Size for Embed\n\n  MINIMUM_SCREEN_WIDTH: 600,\n  MINIMUM_SCREEN_HEIGHT: 600,\n\n  // Puppet Auth\n  PUPPET_MODAL_TOP_MARGIN: 60,\n  PUPPET_MODAL_TOP_PADDING: 36,\n  PUPPET_MODAL_PADDING: 40,\n  PUPPET_MODAL_VERTICAL_PADDING_BUTTON: 10,\n  PUPPET_MODAL_VERTICAL_PADDING_TEXT_FIELD: 10,\n\n  // Launcher / Close sidebar button\n  LAUNCHER_ICON_HEIGHT: 60,\n  LAUNCHER_ICON_WIDTH: 60,\n  CLOSE_SIDEBAR_ICON_HEIGHT: 60,\n  CLOSE_SIDEBAR_ICON_WIDTH: 60,\n  LAUNCHER_FIXED_RIGHT_LENGTH: 16,\n  LAUNCHER_FIXED_BOTTOM_LENGTH: 16,\n\n  XSMALL,\n  SMALL,\n  MEDIUM,\n  LARGE,\n  XLARGE,\n  XXLARGE,\n  XXXLARGE,\n};\n\nexport type FontSize =\n  | 'xSmall'\n  | 'small'\n  | 'default'\n  | 'large'\n  | 'xLarge'\n  | 'inherit';\nexport const FontSizes: {\n  [fontSize in FontSize]: number | string;\n} = {\n  xSmall: Sizes.X_SMALL_TEXT_SIZE_PX,\n  small: Sizes.SMALL_TEXT_SIZE_PX,\n  default: Sizes.DEFAULT_TEXT_SIZE_PX,\n  large: Sizes.LARGE_TEXT_SIZE_PX,\n  xLarge: Sizes.X_LARGE_TEXT_SIZE_PX,\n  inherit: 'inherit',\n};\n\nexport const LineHeights: { [fontSize in FontSize]: string } = {\n  xSmall: `${Sizes.SMALL_LINE_HEIGHT_PX}px`,\n  small: `${Sizes.SMALL_LINE_HEIGHT_PX}px`,\n  default: `${Sizes.DEFAULT_LINE_HEIGHT_PX}px`,\n  large: `${Sizes.LARGE_LINE_HEIGHT_PX}px`,\n  xLarge: `${Sizes.X_LARGE_LINE_HEIGHT_PX}px`,\n  inherit: 'inherit',\n};\n\nexport const MESSAGE_BLOCK_AVATAR_SIZE = 'l';\n\nexport const DEFAULT_EMAIL_LOGO_WIDTH = '140';\n", "import { Table, Column, Model } from 'sequelize-typescript';\nimport type { CreationOptional } from 'sequelize';\nimport { DataTypes } from 'sequelize';\nimport type {\n  CustomerImplementationStage,\n  CustomerType,\n  UUID,\n} from 'common/types/index.ts';\n\nexport type Addons = { [key: string]: string | number | boolean };\nexport type BillingType = 'stripe' | 'manual';\nexport type PricingTier = 'free' | 'pro' | 'scale';\n@Table({\n  tableName: 'customers',\n  timestamps: false,\n})\nexport class CustomerEntity extends Model {\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: false,\n    primaryKey: true,\n    defaultValue: DataTypes.UUIDV4,\n  })\n  id!: UUID;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: false,\n  })\n  name!: string;\n\n  @Column({\n    type: DataTypes.TEXT,\n  })\n  sharedSecret!: string;\n\n  @Column({\n    type: DataTypes.ENUM('verified', 'sample'),\n    defaultValue: 'verified',\n    allowNull: false,\n  })\n  type!: CustomerType;\n\n  @Column({\n    type: DataTypes.VIRTUAL(DataTypes.BOOLEAN, ['addons']),\n    get() {\n      const addons = this.getDataValue('addons');\n      return addons['custom_s3_bucket'] ?? false;\n    },\n  })\n  enableCustomS3Bucket!: boolean;\n\n  @Column({\n    type: DataTypes.VIRTUAL(DataTypes.BOOLEAN, ['addons']),\n    get() {\n      const addons = this.getDataValue('addons');\n      return addons['custom_segment_write_key'] ?? false;\n    },\n  })\n  enableCustomSegmentWriteKey!: boolean;\n\n  @Column({\n    type: DataTypes.VIRTUAL(DataTypes.BOOLEAN, ['addons']),\n    get() {\n      const addons = this.getDataValue('addons');\n      return addons['customer_support'] ?? false;\n    },\n  })\n  enableCustomerSupport!: boolean;\n\n  @Column({\n    type: DataTypes.ENUM(\n      'launched',\n      'implementing',\n      'proof_of_concept',\n      'inactive',\n    ),\n    allowNull: false,\n    defaultValue: 'proof_of_concept',\n  })\n  implementationStage!: CustomerImplementationStage;\n\n  @Column({\n    type: DataTypes.TIME,\n    allowNull: true,\n  })\n  launchDate!: Date | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: true,\n  })\n  slackChannel!: string | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: true,\n  })\n  signupCoupon!: string | null;\n\n  @Column({\n    type: DataTypes.TEXT,\n    allowNull: true,\n  })\n  stripeCustomerID!: CreationOptional<string | null>;\n\n  @Column({\n    type: DataTypes.ENUM('free', 'pro', 'scale'),\n    allowNull: true,\n    defaultValue: 'free',\n  })\n  pricingTier!: CreationOptional<PricingTier>;\n\n  @Column({\n    type: DataTypes.ENUM('active', 'inactive'),\n    allowNull: true,\n    defaultValue: 'inactive',\n  })\n  billingStatus!: CreationOptional<string>;\n\n  @Column({\n    type: DataTypes.ENUM('stripe', 'manual'),\n    allowNull: true,\n    defaultValue: null,\n  })\n  billingType!: CreationOptional<BillingType | null>;\n\n  @Column({\n    type: DataTypes.JSONB,\n    allowNull: false,\n    defaultValue: {},\n  })\n  addons!: CreationOptional<Addons>;\n\n  @Column({\n    type: DataTypes.TIME,\n    allowNull: true,\n  })\n  renewalDate!: CreationOptional<Date | null>;\n\n  @Column({\n    type: DataTypes.ARRAY(DataTypes.TEXT),\n    defaultValue: [],\n    allowNull: false,\n  })\n  planDescription!: CreationOptional<string[]>;\n}\n", "import { format } from 'winston';\nimport stringify from 'fast-json-stable-stringify';\n\nconst MESSAGE = Symbol.for('message');\n\n// This defines our custom log format for logging to the console.\n// It looks like `<LOGLEVEL> <TIMESTAMP>: <MESSAGE>[ <META>]`\n// where LOGLEVEL is a single capital letter (`EWIHVDS` for error, warn,\n// info, http, verbose, debug, silly) and META is a JSON object with\n// additional fields, such as `process` (`server`), `version` (taken from\n// package.json) etc.\n\nexport const flatFormat = format((info) => {\n  const { level, timestamp, message, splat: _, ...meta } = info;\n\n  let stringifiedMeta: string;\n  try {\n    stringifiedMeta = stringify(meta);\n  } catch (err) {\n    stringifiedMeta = `! stringify exception: ${err}`;\n  }\n\n  const formattedMessage = `${level\n    .substr(0, 1)\n    .toUpperCase()} ${timestamp}: ${message} ${stringifiedMeta}`;\n\n  (info as any)[MESSAGE] = formattedMessage;\n  return info;\n});\n", "{\n  \"name\": \"radical\",\n  \"version\": \"1.1093.0\",\n  \"description\": \"The monorepo for Radical\",\n  \"main\": \"index.js\",\n  \"repository\": \"ssh://radical@vault.phacility.com/source/monorepo.git\",\n  \"author\": \"jack@getradical.co\",\n  \"license\": \"NONE\",\n  \"private\": true,\n  \"type\": \"module\",\n  \"scripts\": {\n    \"test\": \"NODE_OPTIONS=--experimental-vm-modules jest\",\n    \"migrate\": \"sequelize-cli db:migrate\",\n    \"migrate-down\": \"sequelize-cli db:migrate:undo\",\n    \"build\": \"npm run tsc-once && ./build/index.mjs --mode=production --clean\",\n    \"build-demo-apps\": \"demo-apps/build-demo-apps.sh\",\n    \"build-sample-apps\": \"npm run build-demo-apps\",\n    \"check-database-schema\": \"./build/index.mjs --mode=development --target=scripts/check-database-schema.ts && ./dist/scripts/check-database-schema.js --check\",\n    \"codegen\": \"node ./build/index.mjs --mode=development --target=scripts/generate-graphql-types.ts && node ./dist/scripts/generate-graphql-types.js && node ./scripts/generate-dayjs.mjs > opensource/sdk-js/packages/react/common/dayjs.ts\",\n    \"docs-codegen\": \"./scripts/docs-codegen.sh\",\n    \"local-dev\": \"./ops/local-dev.sh\",\n    \"watch\": \"./build/index.mjs --mode=development --clean && (./build/index.mjs --mode=development --watch --skipInitialBuild & npm run start-external-dev & npm run start-local-s3 & nodemon --config nodemon-server.json & nodemon --config nodemon-docs-server.json & npm run tsc)\",\n    \"watch-external\": \"./build/index.mjs --mode=development --watch --target=external\",\n    \"watch-server\": \"./build/index.mjs --mode=development --watch --target=server\",\n    \"db-ssh-tunnel\": \"lsof -i '@localhost:15432' >/dev/null || ssh -f -N -L 15432:database-prod-read.int.cord.com:5432 zero\",\n    \"db-ssh-tunnel-write\": \"lsof -i '@localhost:25432' >/dev/null || ssh -f -N -L 25432:database-prod.int.cord.com:5432 zero\",\n    \"start-external-dev\": \"http-server ./dist/external -c-1 -a :: --silent --port 8179\",\n    \"start-local-s3\": \"cat ./localhost/localhost.key ./localhost/localhost.crt > ./localhost/localhost.packed && cd ops && docker-compose up localstack\",\n    \"start-postgres\": \". ./.env && export POSTGRES_USER POSTGRES_DB POSTGRES_PORT POSTGRES_PASSWORD && cd ops && docker-compose up postgres\",\n    \"start-redis\": \"cd ops && docker-compose up redis\",\n    \"start-server-dev\": \"NODE_EXTRA_CA_CERTS=\\\"$(mkcert -CAROOT)/rootCA.pem\\\" node -r dotenv/config --enable-source-maps ./dist/server/index.js\",\n    \"start-server-dev-snapshots\": \"NODE_EXTRA_CA_CERTS=\\\"$(mkcert -CAROOT)/rootCA.pem\\\" node -r dotenv/config --enable-source-maps --heapsnapshot-signal=SIGUSR2 ./dist/server/index.js\",\n    \"start-server-prod\": \"node -r dotenv/config dist/generic/server/index.js\",\n    \"start-asyncWorker-dev\": \"node -r dotenv/config --enable-source-maps ./dist/asyncWorker/asyncWorker.js\",\n    \"start-asyncWorker-prod\": \"node -r dotenv/config dist/generic/asyncWorker/asyncWorker.js\",\n    \"start-docs-server-dev\": \"NODE_EXTRA_CA_CERTS=\\\"$(mkcert -CAROOT)/rootCA.pem\\\" node -r dotenv/config --enable-source-maps ./dist/docs/server/index.js\",\n    \"start-docs-server-prod\": \"node -r dotenv/config dist/generic/docs/server/index.js\",\n    \"tsc\": \"tsc --incremental false --noEmit --skipLibCheck --watch --preserveWatchOutput\",\n    \"tsc-once\": \"tsc --incremental false --noEmit --skipLibCheck\",\n    \"wipe-postgres\": \"cd ops && POSTGRES_USER= POSTGRES_DB= POSTGRES_PASSWORD= docker-compose down --volumes\",\n    \"install\": \"find node_modules/@sentry/ -type f -print0 | grep -z -E '\\\\.(js|js\\\\.map|d\\\\.ts)$' | if sed --version >/dev/null 2>&1 ; then xargs -0 sed --in-place 's/\\\\b__SENTRY__\\\\b/_CORDSNTRY/g;'; else xargs -0 sed -i '' -E 's/[[:<:]]__SENTRY__[[:>:]]/_CORDSNTRY/g;'; fi\",\n    \"postinstall\": \"patch-package\",\n    \"repl\": \"./build/index.mjs --mode=development --target=repl && node ./dist/repl/index.js\",\n    \"generate-docs-embeddings\": \"./build/index.mjs --mode=development --target=scripts/docs-generate-search-data.ts && ./dist/scripts/docs-generate-search-data.js\",\n    \"extract-demo-apps-to-sandpack-object\": \"./build/index.mjs --mode=development --target=scripts/extract-demo-apps-to-sandpack-file-object.ts && ./dist/scripts/extract-demo-apps-to-sandpack-file-object.js\",\n    \"prepare\": \"[ \\\"$(git config core.hooksPath)\\\" = \\\".githooks\\\" ] && git config --unset core.hooksPath ; ln -s ../../.githooks/prepare-commit-msg .git/hooks/ > /dev/null 2>&1 || true\"\n  },\n  \"jest\": {\n    \"extensionsToTreatAsEsm\": [\n      \".ts\",\n      \".tsx\",\n      \".graphql\"\n    ],\n    \"transform\": {\n      \"^.+\\\\.(tsx?$)|(js$)|(graphql$)\": \"<rootDir>/jest/transformer.mjs\"\n    },\n    \"resolver\": \"<rootDir>/jest/resolver.cjs\",\n    \"moduleDirectories\": [\n      \"<rootDir>\",\n      \"node_modules\"\n    ],\n    \"setupFiles\": [\n      \"<rootDir>/jest/setup-jest-env.js\"\n    ],\n    \"testPathIgnorePatterns\": [\n      \"/node_modules/\",\n      \"<rootDir>/dist/\",\n      \"<rootDir>/screenshotsDiff\",\n      \"<rootDir>/opensource/\"\n    ],\n    \"transformIgnorePatterns\": [\n      \"/node_modules/\"\n    ]\n  },\n  \"workspaces\": [\n    \"opensource/sdk-js/packages/*\"\n  ],\n  \"dependencies\": {\n    \"@apollo/client\": \"~3.10.4\",\n    \"@auth0/auth0-react\": \"^1.8.0\",\n    \"@aws-sdk/client-auto-scaling\": \"^3.363.0\",\n    \"@aws-sdk/client-cloudfront\": \"^3.363.0\",\n    \"@aws-sdk/client-cloudwatch-logs\": \"^3.363.0\",\n    \"@aws-sdk/client-ec2\": \"^3.363.0\",\n    \"@aws-sdk/client-ecr\": \"^3.363.0\",\n    \"@aws-sdk/client-elastic-load-balancing-v2\": \"^3.363.0\",\n    \"@aws-sdk/client-iam\": \"^3.363.0\",\n    \"@aws-sdk/client-s3\": \"^3.363.0\",\n    \"@aws-sdk/client-secrets-manager\": \"^3.363.0\",\n    \"@aws-sdk/credential-provider-node\": \"^3.363.0\",\n    \"@codesandbox/sandpack-react\": \"^2.6.9\",\n    \"@emotion/react\": \"^11.11.1\",\n    \"@emotion/server\": \"^11.10.0\",\n    \"@emotion/styled\": \"^11.11.0\",\n    \"@floating-ui/react-dom\": \"^1.3.0\",\n    \"@giphy/js-fetch-api\": \"^5.4.0\",\n    \"@giphy/react-components\": \"^9.4.1\",\n    \"@graphql-tools/schema\": \"^8.5.0\",\n    \"@graphql-tools/utils\": \"^8.13.1\",\n    \"@heroicons/react\": \"^2.0.18\",\n    \"@launchdarkly/node-server-sdk\": \"^8.2.4\",\n    \"@leeoniya/ufuzzy\": \"^0.7.0\",\n    \"@material-ui/core\": \"^4.12.4\",\n    \"@material-ui/styles\": \"^4.11.5\",\n    \"@mui/material\": \"^5.13.7\",\n    \"@phosphor-icons/react\": \"^2.0.15\",\n    \"@pyroscope/nodejs\": \"^0.3.11\",\n    \"@radix-ui/react-label\": \"^2.0.2\",\n    \"@radix-ui/react-select\": \"^2.0.0\",\n    \"@radix-ui/react-slot\": \"^1.0.2\",\n    \"@radix-ui/react-tooltip\": \"^1.0.7\",\n    \"@segment/analytics-node\": \"^2.0.0\",\n    \"@sendgrid/mail\": \"^8.1.0\",\n    \"@sentry/browser\": \"^7.57.0\",\n    \"@sentry/node\": \"^7.59.3\",\n    \"@sentry/react\": \"^7.57.0\",\n    \"@sentry/tracing\": \"^7.59.3\",\n    \"@sentry/types\": \"^7.59.3\",\n    \"@slack/events-api\": \"^3.0.1\",\n    \"@slack/web-api\": \"6.11.1\",\n    \"@slack/webhook\": \"^7.0.2\",\n    \"@tanstack/react-query\": \"^4.32.6\",\n    \"@tanstack/react-virtual\": \"^3.5.0\",\n    \"@types/blueimp-md5\": \"^2.7.0\",\n    \"@types/emoji-js\": \"^3.5.2\",\n    \"@types/jsdom\": \"^16.2.5\",\n    \"@types/parse5\": \"^7.0.0\",\n    \"@types/ua-parser-js\": \"^0.7.36\",\n    \"@types/valid-data-url\": \"^2.0.0\",\n    \"@types/wcag-contrast\": \"^3.0.0\",\n    \"ajv\": \"^8.11.0\",\n    \"ajv-formats\": \"^2.1.1\",\n    \"apollo-server-core\": \"^3.12.1\",\n    \"apollo-server-express\": \"^3.12.1\",\n    \"at-least-node\": \"^1.0.0\",\n    \"auth0\": \"^3.7.2\",\n    \"axios\": \"^1.6.8\",\n    \"backo2\": \"^1.0.2\",\n    \"bluebird\": \"^3.7.2\",\n    \"blueimp-md5\": \"^2.18.0\",\n    \"buffer\": \"^5.6.0\",\n    \"cheerio\": \"^1.0.0-rc.12\",\n    \"classnames\": \"^2.5.1\",\n    \"cookie\": \"^0.4.1\",\n    \"cookie-parser\": \"^1.4.6\",\n    \"cors\": \"^2.8.5\",\n    \"dataloader\": \"^2.0.0\",\n    \"dayjs\": \"^1.11.11\",\n    \"dockerode\": \"^3.3.0\",\n    \"dotenv\": \"^8.2.0\",\n    \"email-addresses\": \"^5.0.0\",\n    \"emoji-js\": \"^3.8.0\",\n    \"emoji-picker-element\": \"^1.16.0\",\n    \"express\": \"^4.19.2\",\n    \"express-basic-auth\": \"^1.2.0\",\n    \"fast-json-stable-stringify\": \"^2.1.0\",\n    \"form-data\": \"^3.0.1\",\n    \"framer-motion\": \"^6.5.1\",\n    \"free-email-domains\": \"^1.2.4\",\n    \"graphql\": \"^15.8.0\",\n    \"graphql-iso-date\": \"^3.6.1\",\n    \"graphql-redis-subscriptions\": \"^2.5.0\",\n    \"graphql-subscriptions\": \"^2.0.0\",\n    \"graphql-tag\": \"^2.12.6\",\n    \"graphql-type-json\": \"^0.3.2\",\n    \"graphql-type-uuid\": \"^0.2.0\",\n    \"handlebars\": \"^4.7.7\",\n    \"highcharts\": \"^10.2.1\",\n    \"highcharts-react-official\": \"^3.1.0\",\n    \"html-entities\": \"^2.1.0\",\n    \"i18next\": \"^23.8.2\",\n    \"ioredis\": \"^5.2.2\",\n    \"ipaddr.js\": \"^2.2.0\",\n    \"is-hotkey\": \"^0.2.0\",\n    \"iterall\": \"^1.3.0\",\n    \"jose\": \"^4.15.5\",\n    \"jotai\": \"^2.6.3\",\n    \"js-base64\": \"^3.7.7\",\n    \"jsdom\": \"^24.0.0\",\n    \"jsonwebtoken\": \"^9.0.2\",\n    \"jss\": \"^10.9.0\",\n    \"jwks-rsa\": \"^2.0.5\",\n    \"jwt-encode\": \"^1.0.1\",\n    \"linkify-react\": \"^4.1.3\",\n    \"linkifyjs\": \"^4.1.3\",\n    \"markdown-to-jsx\": \"^7.4.0\",\n    \"multer\": \"^1.4.4-lts.1\",\n    \"nanoid\": \"^3.3.6\",\n    \"neat-csv\": \"^7.0.0\",\n    \"node-cache\": \"^5.1.2\",\n    \"node-email-reply-parser\": \"^0.1.4\",\n    \"node-fetch\": \"^3.3.2\",\n    \"oauth\": \"^0.9.15\",\n    \"open\": \"^8.4.2\",\n    \"openai\": \"^4.22.0\",\n    \"parse5\": \"^7.1.2\",\n    \"patch-package\": \"^6.5.1\",\n    \"pg\": \"^8.11.5\",\n    \"pg-boss\": \"^8.4.2\",\n    \"pg-copy-streams\": \"^5.1.1\",\n    \"prom-client\": \"^15.1.2\",\n    \"query-string\": \"^7.1.3\",\n    \"querystring\": \"^0.2.0\",\n    \"radash\": \"^11.0.0\",\n    \"react\": \"^18.2.0\",\n    \"react-bootstrap\": \"^1.6.6\",\n    \"react-country-region-selector\": \"^3.6.1\",\n    \"react-dom\": \"^18.2.0\",\n    \"react-helmet\": \"^6.1.0\",\n    \"react-i18next\": \"^13.2.2\",\n    \"react-jss\": \"^10.9.0\",\n    \"react-markdown\": \"^8.0.5\",\n    \"react-popper\": \"^2.3.0\",\n    \"react-router-dom\": \"^6.8.2\",\n    \"react-sticky-box\": \"^2.0.5\",\n    \"react-syntax-highlighter\": \"^15.5.0\",\n    \"react-window\": \"^1.8.10\",\n    \"redlock\": \"^v5.0.0-beta.2\",\n    \"reflect-metadata\": \"^0.1.13\",\n    \"response-time\": \"^2.3.2\",\n    \"sequelize\": \"^6.37.0\",\n    \"sequelize-cli\": \"^6.6.1\",\n    \"sequelize-typescript\": \"^2.1.6\",\n    \"serialize-error\": \"^11.0.3\",\n    \"sha.js\": \"^2.4.11\",\n    \"sharp\": \"^0.32.6\",\n    \"slack-markdown\": \"0.1.1\",\n    \"slate\": \"^0.100.0\",\n    \"slate-history\": \"^0.100.0\",\n    \"slate-hyperscript\": \"^0.100.0\",\n    \"slate-react\": \"^0.100.1\",\n    \"stripe\": \"^15.4.0\",\n    \"subscriptions-transport-ws\": \"^0.9.19\",\n    \"supertest\": \"^6.1.6\",\n    \"typed-emitter\": \"^1.3.1\",\n    \"ua-parser-js\": \"^1.0.33\",\n    \"url\": \"^0.11.0\",\n    \"url-pattern\": \"^1.0.3\",\n    \"use-sync-external-store\": \"^1.2.0\",\n    \"uuid\": \"^8.3.2\",\n    \"valid-data-url\": \"^3.0.0\",\n    \"validator\": \"^13.7.0\",\n    \"wcag-contrast\": \"^3.0.0\",\n    \"winston\": \"^3.7.2\",\n    \"winston-cloudwatch\": \"^6.2.0\",\n    \"winston-transport\": \"^4.5.0\",\n    \"ws\": \"^7.5.3\"\n  },\n  \"devDependencies\": {\n    \"@cspell/eslint-plugin\": \"^6.31.1\",\n    \"@luckycatfactory/esbuild-graphql-loader\": \"^3.7.0\",\n    \"@microsoft/tsdoc\": \"^0.14.2\",\n    \"@sentry/cli\": \"^2.10.0\",\n    \"@types/analytics-node\": \"^3.1.5\",\n    \"@types/auth0\": \"^3.3.3\",\n    \"@types/backo2\": \"^1.0.1\",\n    \"@types/bluebird\": \"^3.5.32\",\n    \"@types/chrome\": \"^0.0.112\",\n    \"@types/cookie\": \"^0.4.0\",\n    \"@types/cookie-parser\": \"^1.4.3\",\n    \"@types/dockerode\": \"^3.2.6\",\n    \"@types/express\": \"^4.17.14\",\n    \"@types/jest\": \"^29.5.3\",\n    \"@types/jscodeshift\": \"^0.11.6\",\n    \"@types/jsonwebtoken\": \"^8.5.9\",\n    \"@types/multer\": \"^1.4.7\",\n    \"@types/node\": \"^14.18.54\",\n    \"@types/oauth\": \"^0.9.1\",\n    \"@types/pg\": \"^8.11.5\",\n    \"@types/pg-copy-streams\": \"^1.2.1\",\n    \"@types/query-string\": \"^6.3.0\",\n    \"@types/react\": \"^18.2.25\",\n    \"@types/react-dom\": \"^18.2.18\",\n    \"@types/react-helmet\": \"^6.1.6\",\n    \"@types/react-syntax-highlighter\": \"^15.5.6\",\n    \"@types/react-window\": \"^1.8.8\",\n    \"@types/response-time\": \"^2.3.5\",\n    \"@types/sha.js\": \"^2.4.0\",\n    \"@types/supertest\": \"^2.0.11\",\n    \"@types/uuid\": \"^8.3.4\",\n    \"@types/validator\": \"^13.7.3\",\n    \"@types/ws\": \"^7.2.5\",\n    \"@typescript-eslint/eslint-plugin\": \"^7.5.0\",\n    \"@typescript-eslint/parser\": \"^7.5.0\",\n    \"@vanilla-extract/css\": \"^1.15.2\",\n    \"@vanilla-extract/esbuild-plugin\": \"^2.2.2\",\n    \"chokidar\": \"^3.5.3\",\n    \"csstype\": \"^3.1.3\",\n    \"esbuild\": \"^0.21.3\",\n    \"esbuild-plugin-svgr\": \"0.0.1\",\n    \"eslint\": \"^8.31.0\",\n    \"eslint-config-prettier\": \"^8.6.0\",\n    \"eslint-import-resolver-typescript\": \"^3.6.1\",\n    \"eslint-plugin-cypress\": \"^2.12.1\",\n    \"eslint-plugin-i18next\": \"^6.0.3\",\n    \"eslint-plugin-import\": \"^2.28.1\",\n    \"eslint-plugin-jest\": \"^27.9.0\",\n    \"eslint-plugin-no-lookahead-lookbehind-regexp\": \"^0.1.0\",\n    \"eslint-plugin-no-relative-import-paths\": \"^v1.5.2\",\n    \"eslint-plugin-prettier\": \"^5.0.1\",\n    \"eslint-plugin-react\": \"^7.32.2\",\n    \"eslint-plugin-react-hooks\": \"^4.6.0\",\n    \"fake-indexeddb\": \"^3.1.7\",\n    \"glob\": \"^10.3.10\",\n    \"http-server\": \"^14.0.0\",\n    \"ioredis-mock\": \"^7.4.0\",\n    \"jest\": \"^29.7.0\",\n    \"jest-environment-jsdom\": \"^29.6.1\",\n    \"jscodeshift\": \"^0.14.0\",\n    \"lint-staged\": \"12.3.5\",\n    \"nodemon\": \"^3.0.1\",\n    \"pg-formatter\": \"^1.2.0\",\n    \"prettier\": \"^3.0.3\",\n    \"schema-dts\": \"^1.1.2\",\n    \"ts-prune\": \"latest\",\n    \"typescript\": \"~5.1.6\",\n    \"yargs\": \"^17.7.2\"\n  },\n  \"overrides\": {\n    \"@auth0/auth0-react\": {\n      \"react\": \"^18.2.0\",\n      \"react-dom\": \"^18.2.0\"\n    },\n    \"@material-ui/core\": {\n      \"react\": \"^18.2.0\",\n      \"react-dom\": \"^18.2.0\",\n      \"@types/react\": \"^18.2.18\",\n      \"@types/react-dom\": \"^18.0.11\"\n    },\n    \"@material-ui/styles\": {\n      \"react\": \"^18.2.0\",\n      \"react-dom\": \"^18.2.0\",\n      \"@types/react\": \"^18.2.18\"\n    },\n    \"@sentry/cli\": {\n      \"strip-ansi\": \"^7.0.1\"\n    },\n    \"@slack/events-api\": {\n      \"debug\": \"^3.1.0\"\n    },\n    \"apollo-server-express\": {\n      \"debug\": \"^3.1.0\"\n    },\n    \"eslint-plugin-import\": {\n      \"debug\": \"^3.1.0\"\n    },\n    \"graphql-iso-date\": {\n      \"graphql\": \"$graphql\"\n    },\n    \"graphql-postgres-subscriptions\": {\n      \"graphql\": \"$graphql\"\n    },\n    \"postgres-date\": \"2.1.0\"\n  }\n}\n", "import * as http from 'http';\nimport * as https from 'https';\nimport * as path from 'path';\nimport * as url from 'url';\nimport { promises as fsPromises } from 'fs';\nimport * as prom from 'prom-client';\nimport type { Viewer } from 'server/src/auth/index.ts';\nimport { anonymousLogger } from 'server/src/logging/Logger.ts';\n\nimport type { ListenPort } from 'server/src/util/port.ts';\nimport { getHostPortion } from 'server/src/util/port.ts';\n\n// Our build process replaces `BUILDCONSTANTS.loggingProcessName` with an\n// appropriate string (e.g. 'server' or 'asyncWorker')\ndeclare const BUILDCONSTANTS: { loggingProcessName: string };\n\n// Prometheus is an open source monitoring framework. The way it works is that\n// a central Prometheus server periodically (by default once a minute) connects\n// to the processes it is set up to monitor and obtains their metrics\n// measurements. Prometheus stores these time series of data, and typically\n// another open source product, Grafana, is used for visualising this data,\n// building dashboards etc.\n//\n// The kind of metrics that get collected include counters (\"How many requests\n// of type X have we had?\", which will be displayed as a graph showing\n// X-requests per second), and histograms e.g. for execution speed (\"How many\n// requests of type X have had that got processed faster than Y seconds?\",\n// which will be displayed as a graph showing the mean, median or p90\n// processing time over the day).\n//\n// So, for Prometheus to be able to show us metrics about our server, our\n// server has to collect those metrics and expose them so that the Prometheus\n// server can scrape them periodically. That is what this file does.\n//\n// The Prometheus client library (prom-client) does all of the hard work here,\n// of pre-aggregating the metrics in the format that the Prometheus server\n// expects. In this file, we just define a few helper functions that make it\n// even easier to define metrics and instrument the code to collect them.\n//\n// One important thing to understand is that the Prometheus client does not\n// store a list of all individual events, but aggregates data immediately. So,\n// e.g., when we instrument our code to keep track of how long certain GraphQL\n// operations take, the Prometheus client won't store the execution time of\n// each individual request, but rather increments a counter for a certain time\n// range. So the information that an individual request took 15ms is lost, and\n// instead the counter for \"events between 10 and 20ms\" is incremented. This\n// makes the collection of metrics very lightweight, and we do not have to\n// worry about the overhead it introduces. On the other hand we, of course,\n// don't have precise data for every single event anymore, but in practice, if\n// there are hundreds or thousands of such events, the bucketed data works just\n// as well.\n\nconst register = new prom.Registry();\nif (process.env.CORD_WORKER_NAME) {\n  // Remove any punctuation characters that might cause issues for prometheus\n  const sanitizedWorkerName = process.env.CORD_WORKER_NAME.replace(\n    /[^A-Za-z0-9 _-]/g,\n    '',\n  );\n  register.setDefaultLabels({ worker: sanitizedWorkerName });\n}\nprom.AggregatorRegistry.setRegistries([register]);\nprom.collectDefaultMetrics({\n  register,\n  prefix: `${BUILDCONSTANTS.loggingProcessName}_`,\n});\n\n// Helper functions to easily create metrics. They are bound to the Prometheus\n// register whose metrics we expose here. These function also provide some\n// reasonable defaults, e.g. the bucket boundaries for histograms.\nexport const Counter = (configuration: prom.CounterConfiguration<string>) =>\n  new prom.Counter({ registers: [register], ...configuration });\nexport const Gauge = (configuration: prom.GaugeConfiguration<string>) =>\n  new prom.Gauge({ registers: [register], ...configuration });\nexport const TimeHistogram = (\n  configuration: prom.HistogramConfiguration<string>,\n) =>\n  new prom.Histogram({\n    registers: [register],\n    buckets: logBuckets(0.001, 10, 13),\n    ...configuration,\n  });\nexport function logBuckets(min: number, max: number, buckets: number) {\n  // This function creates bucket boundaries for histograms that are\n  // logarithmically equidistant.\n  // E.g. logBuckets(0.001, 10, 5) -> [ 0.001, 0.01, 0.1, 1, 10 ].\n  // If you increase bucket number from 5 to 9, then you get one additional\n  // bucket boundary in the middle between each of those 5 in the example.\n  // ([0.001, x*0.001, 0.01, x*0.01, 0.1, x*0.1, 1, x*1, 10] with x approx 3.16)\n  const logMin = Math.log10(min);\n  const logMax = Math.log10(max);\n  const step = (logMax - logMin) / (buckets - 1);\n  return [...Array(buckets).keys()].map((i) => min * 10 ** (i * step));\n  // The default setting for histograms we use above in the `Histogram` helper\n  // uses logBuckets(0.001, 10, 13), which covers the range from 1ms to 10s\n  // and has the nice property that each bucket's upper limit is roughly\n  // twice that of the previous bucket, and three buckets cover exactly a\n  // factor of 10. In other words, the upper boundaries of the histogram\n  // buckets are:\n  // [ 0.001, 0.00215, 0.00464,\n  //   0.01,  0.0215,  0.0464,\n  //   0.1,   0.215,   0.464,\n  //   1,     2.15,    4.64,\n  //  10 ]\n  // Anything faster than 1ms is counted in the first bucket, anything faster\n  // in than 10s is counted in the last bucket, and anything slower than 10s\n  // is counted as \"slower than 10s\" (Prometheus automatically adds one more\n  // bucket with +Infinity as the upper limit.)\n  //\n  // * Why those limits? 0.001 and 10?\n  // For example, our GraphQL operations (at the time of writing this)\n  // typically are in the tenths or hundreds of milliseconds. The limits here\n  // are chosen to cover that area well with some margin at both sides. More\n  // generally: anything that's faster than a millisecond is so fast that we\n  // don't need to worry about it, whereas anything near 10s is so slow that\n  // it's effectively broken. So the range from 1ms to 10s is chosen to be\n  // sure that we capture the relevant region. If we have a problem and, for\n  // example, the execution time of some operation creeps up, than we still\n  // capture that development until the execution time becomes longer than 10s,\n  // but hopefully we would have spotted a problem before that happens.\n  //\n  // * Why 13 buckets?\n  // 13 happens to be one of the numbers where we will have buckets lining up\n  // with powers of 10, which is nice. Having more buckets means that we have\n  // more precise information in our histograms, but it adds to the memory\n  // overhead. 13 should be good enough to get a good idea what's going on.\n  //\n  // * Why \"logarithmically equidistant\"?\n  // Since we use these histograms for measuring the timing of many different\n  // kinds of processes, this is a good one-fits-all solution. If you knew\n  // that you want to measure times in the range of, say, 10 to 20ms, than\n  // you would probably just have a linear series of bucket boundaries (10,\n  // 11, 12, ..., 20). However, to have a reasonably good resultion for\n  // processes that take around 10ms and at the same time for those that take\n  // around 100 or 1000ms, it's better to have a constant factor between\n  // bucket boundaries. Here, the upper end of a bucket is at 2.15 times the\n  // lower end, and that way we nicely spread out just 13 buckets on the wide\n  // range from 1ms to 10s.\n}\n\nexport function incCounterWithAppID<T extends string>(\n  viewer: Viewer,\n  counter: prom.Counter<T>,\n  labels: prom.LabelValues<T> = {},\n  value = 1,\n): void {\n  counter.inc(\n    { appID: viewer.platformApplicationID || 'null', ...labels },\n    value,\n  );\n}\n\n// Ideally would be instantiated within the cluster-mode-only handler below, but\n// having it out here means that even workers do it, working around this issue:\n// https://github.com/siimon/prom-client/pull/449#issuecomment-922504343\nconst aggregatorRegistry = new prom.AggregatorRegistry();\n\nexport async function metricsMain(port: ListenPort, clusterMode: boolean) {\n  const app = clusterMode\n    ? (_req: http.IncomingMessage, res: http.ServerResponse) => {\n        res.setHeader('Content-type', aggregatorRegistry.contentType);\n        aggregatorRegistry.clusterMetrics().then(\n          (metrics) => res.end(metrics),\n          (err) => {\n            anonymousLogger().logException(\n              'aggregatorRegistry.clusterMetrics() threw an exception',\n              err,\n              undefined,\n              undefined,\n              'warn',\n            );\n            res.statusCode = 500;\n            res.end(`${err.message}`);\n          },\n        );\n      }\n    : (_req: http.IncomingMessage, res: http.ServerResponse) => {\n        res.setHeader('Content-type', register.contentType);\n        register.metrics().then(\n          (metrics) => res.end(metrics),\n          (err) => {\n            anonymousLogger().logException(\n              'register.metrics() threw an exception',\n              err,\n              undefined,\n              undefined,\n              'warn',\n            );\n            res.statusCode = 500;\n            res.end(`${err.message}`);\n          },\n        );\n      };\n\n  const server =\n    process.env.NODE_ENV === 'development' && !process.env.IS_TEST\n      ? https.createServer(\n          {\n            key: await fsPromises.readFile(\n              path.posix.dirname(url.fileURLToPath(import.meta.url)) +\n                '/localhost.key',\n            ),\n            cert: await fsPromises.readFile(\n              path.posix.dirname(url.fileURLToPath(import.meta.url)) +\n                '/localhost.crt',\n            ),\n          },\n          app,\n        )\n      : http.createServer(app);\n\n  // Start our server\n  return await new Promise<void>((resolve, reject) => {\n    server.addListener('error', reject);\n    server.listen(port, () => {\n      server.removeListener('error', reject);\n      resolve();\n      const host = getHostPortion(server.address());\n      anonymousLogger().info(\n        `\uD83D\uDE80 Serving Prometheus metrics at https://${host}/`,\n      );\n    });\n  });\n}\n", "import { JwksClient } from 'jwks-rsa';\n\nimport type { UUID } from 'common/types/index.ts';\nimport env from 'server/src/config/Env.ts';\nimport type { GACookieType } from 'server/src/util/google-analytics.ts';\nimport { ClientFacingError } from 'server/src/util/ClientFacingError.ts';\nimport type { UserEntity } from 'server/src/entity/user/UserEntity.ts';\nimport type { OrgEntity } from 'server/src/entity/org/OrgEntity.ts';\nimport { OrgMembersEntity } from 'server/src/entity/org_members/OrgMembersEntity.ts';\n\nexport const SERVICE_USER_ID = 'service_user';\n\nexport enum AuthProviderType {\n  SLACK = 'slack',\n  PLATFORM = 'platform',\n}\n\nexport const jwksClient = new JwksClient({\n  jwksUri: `https://${env.AUTH0_CUSTOM_LOGIN_DOMAIN}/.well-known/jwks.json`,\n});\n\n// There is a surprising (and growing) amount of stuff that we'll want to store\n// as part of the user session. It makes sense to write this to a DB on the server\n// and to use a very small payload for network round trips (i.e. just the key to\n// the hash table value). This idea is the basis of the 'datr' cookie within\n// Facebook.\nexport interface Session {\n  viewer: Viewer;\n  isAdmin?: boolean;\n  console?: ConsoleSession;\n  utmParameters?: { [key: string]: string | string[] | undefined };\n  ga?: GACookieType;\n}\n\ninterface ConsoleSession {\n  email_verified: boolean;\n}\n\nexport interface Auth0Token {\n  iss: string;\n  sub: string;\n  'https://console.cord.com/email': string;\n  'https://console.cord.com/email_verified': boolean;\n  auth0UserID: string;\n  aud: string | string[];\n}\n\nexport function createAnonymousSession() {\n  return {\n    viewer: Viewer.createAnonymousViewer(),\n  };\n}\n\nexport class Viewer {\n  private constructor(\n    public readonly userID: UUID | undefined,\n    public readonly orgID: UUID | undefined,\n    public readonly platformApplicationID?: UUID,\n    public readonly externalUserID?: string,\n    public readonly externalOrgID?: string,\n    public readonly developerUserID?: string,\n    public readonly originalOrgID?: UUID,\n    public readonly relevantOrgIDs?: UUID[],\n  ) {\n    if (orgID !== undefined && relevantOrgIDs !== undefined) {\n      // Note that a constructed Viewer can have both of these fields set at the\n      // same time -- we do that in the third case below for backwards-compat.\n      // But you can't specify the creation of a Viewer with both of these, to\n      // try to force new code to \"do the right thing\".\n      if (relevantOrgIDs.length !== 1 || relevantOrgIDs[0] !== orgID) {\n        throw new Error(\n          'You specified both a single orgID and relevantOrgIDs. ' +\n            'You should pass undefined for the orgID to catch places not using relevantOrgIDs. Be bold!',\n        );\n      }\n    } else if (orgID !== undefined) {\n      this.relevantOrgIDs = [orgID];\n    }\n  }\n\n  static async createLoggedInPlatformViewer({\n    user,\n    org,\n  }: {\n    user: UserEntity;\n    org: OrgEntity | null;\n  }): Promise<Viewer> {\n    if (!user.platformApplicationID) {\n      throw new Error('Platform viewer must have platformApplicationID');\n    }\n\n    const relevantOrgIDs = org\n      ? undefined\n      : // OrgMembersLoader.loadAllImmediateOrgIDsForUser but we can't call that since we\n        // don't have a viewer yet!\n        (\n          await OrgMembersEntity.findAll({\n            where: {\n              userID: user.id,\n            },\n          })\n        ).map((e) => e.orgID);\n\n    return new Viewer(\n      user.id,\n      org?.id,\n      user.platformApplicationID,\n      user.externalID,\n      org?.externalID,\n      undefined,\n      undefined,\n      relevantOrgIDs,\n    );\n  }\n\n  static createLoggedInViewer(userID: UUID, orgID: UUID): Viewer {\n    return new Viewer(userID, orgID);\n  }\n\n  static createOrgViewer(orgID: UUID, platformApplicationID?: UUID): Viewer {\n    return new Viewer(undefined, orgID, platformApplicationID);\n  }\n\n  static createServiceViewer() {\n    return new Viewer(SERVICE_USER_ID, undefined);\n  }\n\n  static createAnonymousViewer() {\n    return new Viewer(undefined, undefined);\n  }\n\n  static createConsoleViewer(devUserID: string): Viewer {\n    return new Viewer(\n      undefined,\n      undefined,\n      undefined,\n      undefined,\n      undefined,\n      devUserID,\n    );\n  }\n\n  static createFromSerializedState(serializedViewer: Viewer): Viewer {\n    const {\n      userID,\n      orgID,\n      platformApplicationID,\n      externalUserID,\n      externalOrgID,\n      developerUserID,\n      originalOrgID,\n      relevantOrgIDs,\n      ...rest\n    } = serializedViewer;\n    const _: Record<string, never> = rest;\n\n    return new Viewer(\n      userID,\n      orgID,\n      platformApplicationID,\n      externalUserID,\n      externalOrgID,\n      developerUserID,\n      originalOrgID,\n      relevantOrgIDs,\n    );\n  }\n\n  /**\n   * Returns a version of this Viewer with the orgID set to the given org ID,\n   * used in situations where a user logged into one org wants to take an action\n   * as themselves in another org, such as sending a message from the unified\n   * inbox.  If the orgID given is the same as this Viewer's org ID, just\n   * returns this Viewer again.\n   */\n  public viewerInOtherOrg(\n    orgID: UUID | undefined,\n    externalOrgID: string | undefined,\n    relevantOrgIDs?: UUID[],\n  ): Viewer {\n    if (orgID === this.orgID && orgID !== undefined) {\n      return this;\n    }\n    if (orgID === undefined && relevantOrgIDs === undefined) {\n      throw new Error('viewerInOtherOrg provided with no orgs at all');\n    }\n    return new Viewer(\n      this.userID,\n      orgID,\n      this.platformApplicationID,\n      this.externalUserID,\n      externalOrgID,\n      this.developerUserID,\n      this.originalOrgID ?? this.orgID,\n      relevantOrgIDs,\n    );\n  }\n}\n\nexport const assertViewerHasIdentity = (\n  viewer: Viewer,\n): {\n  userID: UUID;\n  orgID: UUID;\n} => {\n  if (!viewer.userID || !viewer.orgID) {\n    throw new Error('Viewer must not be anonymous.');\n  }\n\n  return {\n    userID: viewer.userID,\n    orgID: viewer.orgID,\n  };\n};\n\nexport function assertViewerHasPlatformIdentity(viewer: Viewer): {\n  userID: UUID;\n  orgID: UUID;\n  externalUserID: string;\n  externalOrgID: string;\n  platformApplicationID: string;\n} {\n  const { userID, orgID } = assertViewerHasIdentity(viewer);\n\n  if (\n    !viewer.externalUserID ||\n    !viewer.externalOrgID ||\n    !viewer.platformApplicationID\n  ) {\n    throw new Error('Viewer must be a platform viewer');\n  }\n\n  return {\n    userID,\n    orgID,\n    platformApplicationID: viewer.platformApplicationID,\n    externalUserID: viewer.externalUserID,\n    externalOrgID: viewer.externalOrgID,\n  };\n}\n\nexport function viewerHasIdentity(viewer: Viewer) {\n  return !!viewer.userID && !!viewer.orgID;\n}\n\nexport function assertViewerHasUser(viewer: Viewer): UUID {\n  const { userID } = viewer;\n\n  if (!userID) {\n    throw new Error('Viewer user must not be anonymous.');\n  }\n\n  return userID;\n}\n\nexport function assertViewerHasOrg(viewer: Viewer): UUID {\n  const { orgID } = viewer;\n\n  if (!orgID) {\n    throw new Error('Viewer org must not be anonymous.');\n  }\n\n  return orgID;\n}\n\n/**\n * Does basically the same thing as `assertViewerHasOrg`, except it throws a\n * client-facing error -- the idea being that you call this when it's *their*\n * error for not giving us a single org ID, instead of our internal logic error.\n * This also centralises all of the places we require a single org ID for\n * writes, so we can refactor/rethink/categorize/whatever them later.\n */\nexport function assertViewerHasSingleOrgForWrite(\n  viewer: Viewer,\n  error: string,\n): UUID {\n  const { orgID } = viewer;\n\n  // Specifically check for viewer.orgID, and not\n  // viewer.relevantOrgIDs.length === 1, so that we error in the case\n  // where they didn't give us an org but the user happens to only be in\n  // one -- to prevent sudden explosions when that user is added to\n  // another org, require that they always explicitly specify.\n  if (!orgID) {\n    throw new ClientFacingError(error);\n  }\n\n  return orgID;\n}\n\nexport function assertViewerHasOrgs(viewer: Viewer): UUID[] {\n  const { relevantOrgIDs } = viewer;\n\n  if (!relevantOrgIDs) {\n    throw new Error('Viewer orgs must be nonempty.');\n  }\n\n  return relevantOrgIDs;\n}\n\nexport function assertViewerHasPlatformUser(viewer: Viewer) {\n  const { userID, externalUserID, platformApplicationID } = viewer;\n\n  if (!userID || !externalUserID || !platformApplicationID) {\n    throw new Error('Viewer must have a platform user');\n  }\n\n  return { userID, externalUserID, platformApplicationID };\n}\n\nexport function assertViewerHasPlatformApplicationID(viewer: Viewer): UUID {\n  const { platformApplicationID } = viewer;\n\n  if (!platformApplicationID) {\n    throw new Error('Viewer must have a platform app ID');\n  }\n\n  return platformApplicationID;\n}\n\nexport function assertServiceViewer(viewer: Viewer) {\n  if (viewer.userID !== SERVICE_USER_ID) {\n    throw new Error('Viewer must be service user.');\n  }\n}\n\nexport function assertConsoleUser(viewer: Viewer) {\n  if (!viewer.developerUserID) {\n    throw new Error('User must have an email');\n  }\n\n  return { email: viewer.developerUserID };\n}\n\nexport function viewerIsUsingOrgsAsFilter(viewer: Viewer) {\n  // Right now, platform viewers are in one of two states:\n  //   - everything is org-less, in which case relevantOrgIDs is filled out and\n  //     orgID is undefined\n  //   - we have an org, either via the token or an explicit `filter`, which\n  //     sets orgID and sets relevantOrgIDs to [orgID]\n  // This code looks for the second case. This is a bit of a hack -- it is going\n  // to break as soon as we allow multiple org IDs as a filter (which will have\n  // to stuff them into relevantOrgIDs), but at least there's one codepath to\n  // update when we build that, through here.\n  return viewer.orgID !== undefined;\n}\n", "import type { JsonObject } from 'common/types/index.ts';\nimport type { LoggingTags } from 'server/src/logging/Logger.ts';\n\n// Extending Error type solution taken from here:\n// https://stackoverflow.com/questions/41102060/typescript-extending-error-class\nexport class CordError extends Error {\n  constructor(\n    message?: string,\n    public loggingMetadata?: JsonObject,\n    public loggingTags?: LoggingTags,\n  ) {\n    // 'Error' breaks prototype chain here\n    super(message);\n\n    // restore prototype chain\n    Object.setPrototypeOf(this, new.target.prototype);\n  }\n}\n", "import { Table, Column, Model } from 'sequelize-typescript';\nimport type {\n  CreationOptional,\n  InferAttributes,\n  InferCreationAttributes,\n} from 'sequelize';\nimport { DataTypes } from 'sequelize';\nimport type { UUID } from 'common/types/index.ts';\n\n@Table({\n  tableName: 'org_members',\n  timestamps: false,\n})\nexport class OrgMembersEntity extends Model<\n  InferAttributes<OrgMembersEntity>,\n  InferCreationAttributes<OrgMembersEntity>\n> {\n  @Column({\n    type: DataTypes.UUID,\n    primaryKey: true,\n    allowNull: false,\n  })\n  userID!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    primaryKey: true,\n    allowNull: false,\n  })\n  orgID!: UUID;\n\n  @Column({\n    type: DataTypes.UUID,\n    allowNull: true,\n  })\n  platformApplicationID!: UUID | null;\n\n  @Column({\n    type: DataTypes.TIME,\n  })\n  createdTimestamp!: CreationOptional<Date>;\n}\n", "export type DatabaseConfig = {\n  database?: string;\n  host?: string;\n  password?: string;\n  port?: number;\n  user?: string;\n};\n\nexport function getReadReplicaDbConfigFromEnv(\n  env: Record<string, string | undefined>,\n): DatabaseConfig {\n  return {\n    host: env.POSTGRES_READ_HOST ?? env.POSTGRES_HOST,\n    port: Number(env.POSTGRES_READ_PORT ?? env.POSTGRES_PORT),\n    database: env.POSTGRES_DB,\n    user: env.POSTGRES_USER,\n    password: env.POSTGRES_PASSWORD,\n  };\n}\n"],
  "mappings": "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",
  "names": ["Table", "Column", "Model", "DataTypes", "defaultValue", "Table", "Column", "Model", "DataTypes", "Model", "Column", "DataTypes", "Table", "Table", "Column", "Model", "DataTypes", "Model", "Column", "DataTypes", "Table", "FeatureFlags", "Model", "Column", "DataTypes", "Table", "Counter", "Table", "Column", "Model", "DataTypes", "Model", "Column", "DataTypes", "Table", "Counter", "error", "spawn", "where", "resolve"]
}
