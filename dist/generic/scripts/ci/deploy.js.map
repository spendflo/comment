{
  "version": 3,
  "sources": ["scripts/ci/deploy.ts", "ops/aws/src/radical-stack/Config.ts", "server/src/config/MagicEnv.ts", "server/src/config/Env.ts", "scripts/ci/lib/helpers.ts", "common/util/sleep.ts"],
  "sourcesContent": ["#!/usr/bin/env -S node --enable-source-maps\r\n\r\nimport { inspect, promisify } from 'util';\r\n\r\nimport 'dotenv/config.js';\r\nimport * as fs from 'fs/promises';\r\nimport * as zlib from 'zlib';\r\nimport * as autoscaling from '@aws-sdk/client-auto-scaling';\r\nimport * as cloudfront from '@aws-sdk/client-cloudfront';\r\nimport * as ec2 from '@aws-sdk/client-ec2';\r\nimport * as ecr from '@aws-sdk/client-ecr';\r\nimport * as elbv2 from '@aws-sdk/client-elastic-load-balancing-v2';\r\nimport Docker from 'dockerode';\r\nimport { decode } from 'js-base64';\r\nimport type * as pg from 'pg';\r\nimport yargs from 'yargs';\r\n\r\nimport { AWS_REGION } from 'ops/aws/src/radical-stack/Config.ts';\r\nimport env from 'server/src/config/Env.ts';\r\nimport {\r\n  runCommandLine,\r\n  connectToDatabase,\r\n  postMessageFactory,\r\n  sleepSeconds,\r\n} from 'scripts/ci/lib/helpers.ts';\r\n\r\nfunction log(...stuff: any[]): void {\r\n  const ts = new Date().toISOString();\r\n  console.log(`[${ts}]`, ...stuff);\r\n}\r\n\r\nfunction logError(...stuff: any[]) {\r\n  log('ERROR:', ...stuff);\r\n}\r\n\r\n// This script may return these exit codes:\r\n// 0: success! Deployment complete.\r\n// 1: error!\r\n// 2: deployment skipped (`automaticDeploy` switched off and `--force` option\r\n// wasn't given)\r\n\r\n// No easy way to retrieve these AWS ids, so they are defined here as constants,\r\n// as looked up on the AWS console.\r\nconst CONFIG = {\r\n  prod: {\r\n    targetGroups: {\r\n      api: 'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/prodServerAPITargetGroup/372ac2f0bcb95756',\r\n      console:\r\n        'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/prodServerConsoleTargetGroup/4ba4279d4c45284b',\r\n      docs: 'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/prodServerDocsTargetGroup/f993310fd5f1062e',\r\n      admin:\r\n        'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/prodServerAdminTargetGroup/7f29f18a9aa7f7f2',\r\n    },\r\n    cloudFrontDistributionID: 'E2P1Z0TBFUA575',\r\n  },\r\n  staging: {\r\n    targetGroups: {\r\n      api: 'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/stagingServerAPITargetGroup/8819231831fc0427',\r\n      console:\r\n        'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/stagingServerConsoleTargetGroup/0fab9fe8f850d0ac',\r\n      docs: 'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/stagingServerDocsTargetGroup/562c2760e4255468',\r\n      admin:\r\n        'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/stagingServerAdminTargetGroup/dde44005f9f01b4c',\r\n    },\r\n    cloudFrontDistributionID: 'E2EZOYZW0TRYBC',\r\n  },\r\n  loadtest: {\r\n    targetGroups: {\r\n      api: 'arn:aws:elasticloadbalancing:eu-west-2:869934154475:targetgroup/loadtestServerAPITargetGroup/7c337619a9e59828',\r\n    },\r\n    cloudFrontDistributionID: 'E32RS03NTNGW0X',\r\n  },\r\n};\r\n\r\nconst argv = yargs(process.argv.slice(2))\r\n  .option('pullImage', {\r\n    type: 'string',\r\n    description: 'Docker image to pull and deploy',\r\n    default: '869934154475.dkr.ecr.eu-west-2.amazonaws.com/server:latest',\r\n  })\r\n  .option('pushOnSuccess', {\r\n    type: 'string',\r\n    description: 'Docker tag to push after successful deploy',\r\n  })\r\n  .option('force', {\r\n    type: 'boolean',\r\n    description: 'deploy even if \"automaticDeploy\" is off',\r\n  })\r\n  .option('unattended', {\r\n    type: 'boolean',\r\n    description:\r\n      'flag that the script is executed unattendedly (by a build plan or cron job), results in posting extra messages to Slack',\r\n  })\r\n  .help()\r\n  .alias('help', 'h').argv;\r\n\r\nasync function main(): Promise<number> {\r\n  const { CORD_TIER: tier } = env;\r\n\r\n  if (tier !== 'staging' && tier !== 'prod' && tier !== 'loadtest') {\r\n    throw new Error('tier must be prod, staging, or loadtest');\r\n  }\r\n\r\n  // Connect to the database for a few bits and pieces\r\n  const db = await connectToDatabase();\r\n\r\n  // Get the contents of the heimdall table as one JavaScript object\r\n  const opsConfig: Record<string, any> =\r\n    (\r\n      await db.query(\r\n        `SELECT json_object_agg(key, value) AS config\r\n         FROM cord.heimdall WHERE tier=$1;`,\r\n        [tier],\r\n      )\r\n    )?.rows[0]?.config ?? {};\r\n\r\n  // Get us a function to post error messages to the Slack ops channel\r\n  const postErrorMessage = await postMessageFactory(\r\n    env.CORD_OPS_SLACK_CHANNEL_ID,\r\n  );\r\n\r\n  const postInfoMessage = await postMessageFactory(\r\n    env.PROD_CHANGES_SLACK_CHANNEL_ID,\r\n  );\r\n\r\n  try {\r\n    const exitCode = await deployTier(\r\n      tier,\r\n      postErrorMessage,\r\n      postInfoMessage,\r\n      opsConfig,\r\n      db,\r\n    );\r\n    return exitCode;\r\n  } catch (err) {\r\n    await postErrorMessage(`ERROR: push to ${tier} failed with an error\r\n\\`\\`\\`\r\n${inspect(err, false, 10, false)}\r\n\\`\\`\\``);\r\n    throw err;\r\n  }\r\n}\r\n\r\nasync function deployTier(\r\n  tier: 'prod' | 'staging' | 'loadtest',\r\n  postErrorMessage: (text: string) => Promise<void>,\r\n  postInfoMessage: (text: string) => Promise<void>,\r\n  opsConfig: Record<string, any>,\r\n  db: pg.Client,\r\n) {\r\n  log(`Deploying to ${tier} tier`);\r\n  log(`Arguments: ${JSON.stringify(argv, null, 2)}`);\r\n\r\n  const asClient = new autoscaling.AutoScalingClient({ region: AWS_REGION });\r\n  const ec2Client = new ec2.EC2Client({ region: AWS_REGION });\r\n  const ecrClient = new ecr.ECRClient({ region: AWS_REGION });\r\n  const elbv2Client = new elbv2.ElasticLoadBalancingV2Client({\r\n    region: AWS_REGION,\r\n  });\r\n  // API client for local Docker (the one on the machine running this script)\r\n  const localDocker = new Docker();\r\n\r\n  // Get a login token we can use for docker pull/push operations\r\n  const ecrAuth = await getEcrAuth(ecrClient);\r\n\r\n  // Pull the image we want to deploy. In automatic deploys this should be a\r\n  // no-op, because we would have built this image on the same machine as the\r\n  // script is running on. However, when running manually, we might need to pull\r\n  // first.\r\n  await dockerPull(localDocker, argv.pullImage, ecrAuth);\r\n\r\n  // Now that we have pulled the image, we *should* have a repo digest, i.e. an\r\n  // identifier for this specific image that keeps referring to the image even\r\n  // if the tag (e.g. \"latest\") is updated. If Docker doesn't give us a repo\r\n  // digest here, we just continue with the image identifier that we got from\r\n  // the command line.\r\n  const imageInfo = await localDocker.getImage(argv.pullImage).inspect();\r\n  const imageName = imageInfo.RepoDigests[0] ?? argv.pullImage;\r\n  const imageLabels: Record<string, string | undefined> =\r\n    imageInfo.Config.Labels;\r\n  const gitCommitHash = imageLabels['com.cord.git-commit-hash'];\r\n  const gitCommitTitle = imageLabels['com.cord.git-commit-title'];\r\n  const packageVersion = imageLabels['com.cord.version'];\r\n  log(\r\n    `Using Docker image ${imageName} - git commit hash ${gitCommitHash} - package version ${packageVersion}`,\r\n  );\r\n\r\n  // We have obtained information on the image we are about to deploy, but stop\r\n  // here if automatic deployments are switched off and this script wasn't\r\n  // passed the `--force` option.\r\n  if (!argv.force && !opsConfig.automaticDeploy) {\r\n    log(\r\n      \"Automatic deploys are switched off. Use '--force' to deploy nonetheless.\",\r\n    );\r\n    if (argv.unattended) {\r\n      await postErrorMessage(`*NOT* redeploying ${tier} because automatic deployment is switched off\r\n\u2022 Git commit: ${\r\n        gitCommitHash\r\n          ? `<https://github.com/getcord/monorepo/commit/${gitCommitHash}|${gitCommitHash.substr(\r\n              0,\r\n              10,\r\n            )}>`\r\n          : 'unknown'\r\n      } ${gitCommitTitle || ''}\r\n\u2022 Package version: ${packageVersion}\r\n\u2022 Image: \\`${imageName}\\`\r\n\u2022 Activate automatic deploys: https://${env.ADMIN_SERVER_HOST}/heimdall\r\n\u2022 Manual deploy: \\`scripts/manual-deploy.sh ${tier} '${imageName}'\\``);\r\n    }\r\n    return 2;\r\n  }\r\n\r\n  // We are going ahead with the deploy. At this point we create a row in the\r\n  // cord.deploys table.\r\n  const {\r\n    rows: [{ id: deployID }],\r\n  } = await db.query<{ id: string }>(\r\n    `INSERT INTO cord.deploys (\"tier\", \"gitCommitHash\", \"dockerImage\", \"packageVersion\")\r\n     VALUES ($1,$2,$3,$4)\r\n     RETURNING id;`,\r\n    [tier, gitCommitHash ?? null, imageName, packageVersion ?? null],\r\n  );\r\n  log(`Added deploy '${deployID}' to cord.deploys table`);\r\n\r\n  await (async () => {\r\n    // Retrieve a list of EC2 instances in the autoscaling group. Those are the\r\n    // ones we are going to deploy to.\r\n    const instances = await getAutoscalingGroupInstances(\r\n      `${tier}-server`,\r\n      asClient,\r\n      ec2Client,\r\n    );\r\n\r\n    log('EC2 instances:');\r\n    for (const i of instances) {\r\n      log(`  * ${i.InstanceId} (${i.PrivateDnsName})`);\r\n    }\r\n\r\n    // Pull the Docker container on all instances\r\n    await Promise.all(\r\n      instances.map(async (instance) => {\r\n        log(`docker pull on ${instance.InstanceId}`);\r\n        const remoteDocker = new Docker({\r\n          host: instance.PrivateDnsName!,\r\n          port: 2375,\r\n          protocol: 'http',\r\n        });\r\n        log(`docker prune on ${instance.InstanceId}`);\r\n        // Clean up old images\r\n        await remoteDocker\r\n          .pruneImages({\r\n            filters: JSON.stringify({\r\n              until: { '3h': true },\r\n              dangling: { false: true },\r\n            }),\r\n          })\r\n          .catch(log);\r\n        log(`docker pull image ${imageName} on ${instance.InstanceId}`);\r\n        await dockerPull(remoteDocker, imageName, ecrAuth);\r\n        if (argv.pullImage !== imageName) {\r\n          log(`docker tag ${imageName} as ${argv.pullImage}`);\r\n\r\n          // `argv.pullImage` is the image name passed to this script. We\r\n          // resolve that into a repo digest above, which we use on each\r\n          // instance to make extra sure we're deploying the same image\r\n          // everywhere. The two may be the same (if the script was started with\r\n          // a repo digest in the first place), but if they are not, we tag the\r\n          // image we pulled (by repo disgest) with the name that was passed to\r\n          // the script. For example: if the script is started with a image name\r\n          // like '.../server:latest`, then we resolve it to a concrete repo\r\n          // digest once above, we pull that image by digest here on each\r\n          // instance, and then tag it with given name to update the tag\r\n          // ('latest' in this example) on the instance.\r\n          // We could also just pull 'latest' on each instance, but this way\r\n          // it's just that little bit safer (e.g. if the 'latest' tag get\r\n          // updated while this script is running)\r\n          await dockerTag(remoteDocker, imageName, argv.pullImage);\r\n        }\r\n\r\n        log(`finished docker pull on ${instance.InstanceId}`);\r\n      }),\r\n    );\r\n\r\n    // Now it's time to redeploy all instances\r\n\r\n    for (const instance of instances) {\r\n      log(`\\n\\nInstance: ${instance.InstanceId} (${instance.PrivateDnsName})`);\r\n\r\n      // Check the instance health (according to the load balancer)\r\n      let instanceHealth = (\r\n        await getInstanceHealth(CONFIG[tier].targetGroups.api, elbv2Client)\r\n      )[instance.InstanceId!];\r\n\r\n      if (instanceHealth !== 'healthy') {\r\n        // If we are not healthy to begin with, we better not touch this instance\r\n        log(`Skipping - instance health is ${instanceHealth}`);\r\n        void postErrorMessage(`During deployment to ${tier}, skipping an instance due to its health status\r\n\\`\\`\\`\r\nInstance ID: ${instance.InstanceId}\r\nHost name: ${instance.PrivateDnsName}\r\nHealth status: ${instanceHealth}\r\n\\`\\`\\`\r\n`);\r\n        continue;\r\n      }\r\n\r\n      // Deregister this instance from the load balancer.\r\n      for (const [name, arn] of Object.entries(CONFIG[tier].targetGroups)) {\r\n        do {\r\n          log(`Deregistering from load balancer ${name} target group...`);\r\n          await elbv2Client.send(\r\n            new elbv2.DeregisterTargetsCommand({\r\n              TargetGroupArn: arn,\r\n              Targets: [{ Id: instance.InstanceId! }],\r\n            }),\r\n          );\r\n\r\n          // Wait one second before checking instance health again\r\n          await sleepSeconds(1);\r\n\r\n          instanceHealth = (await getInstanceHealth(arn, elbv2Client))[\r\n            instance.InstanceId!\r\n          ];\r\n          log(`Instance health is now: ${instanceHealth}`);\r\n        } while (instanceHealth === 'healthy');\r\n      }\r\n\r\n      // Despite the above checks, we still see that requests to our API can\r\n      // fail with an error 502 during deployment. Adding an extra delay between\r\n      // removing an instance from the load balancer and shutting down the\r\n      // instance seems to solve this reliably.\r\n\r\n      if (process.env.ACCELERATE_DEPLOY === 'true') {\r\n        log('Skipping 30 second pause because ACCELERATE_DEPLOY is true');\r\n      } else {\r\n        log('Pausing for 30 seconds to help settle load balancer state');\r\n        await sleepSeconds(30);\r\n        log('Continuing...');\r\n      }\r\n\r\n      // Connect to Docker on the instance, stop and remove the current `server`\r\n      // container\r\n      const remoteDocker = new Docker({\r\n        host: instance.PrivateDnsName!,\r\n        port: 2375,\r\n        protocol: 'http',\r\n      });\r\n\r\n      try {\r\n        await remoteDocker\r\n          .getContainer('server')\r\n          .update({ RestartPolicy: { Name: '' } });\r\n      } catch (err) {\r\n        log(\r\n          'Updating the restart policy of the existing server container failed:',\r\n          err,\r\n        );\r\n      }\r\n\r\n      await drainServer(instance.PrivateDnsName!);\r\n\r\n      try {\r\n        await remoteDocker.getContainer('server').stop();\r\n        await remoteDocker.getContainer('server').remove();\r\n      } catch (err) {\r\n        // If we cannot stop/remove the container, it might just be because it\r\n        // wasn't running. If that's the case we can still go ahead and start\r\n        // the server on this instance.\r\n\r\n        log(`Could not stop/remove existing container on instance:`, err);\r\n      }\r\n\r\n      // Create and then start the new server container\r\n      const container = await remoteDocker.createContainer({\r\n        Image: imageName,\r\n        name: 'server',\r\n        AttachStdin: false,\r\n        AttachStdout: false,\r\n        AttachStderr: false,\r\n        Env: [`CORD_TIER=${tier}`],\r\n        HostConfig: {\r\n          NetworkMode: 'host',\r\n          RestartPolicy: { Name: 'always' },\r\n        },\r\n      });\r\n      await container.start();\r\n\r\n      // Wait for the server to be up and running and ready to serve requests\r\n      await waitForServerInit(instance.PrivateDnsName!);\r\n\r\n      // Register this instance with the load balancer\r\n      await Promise.all(\r\n        Object.values(CONFIG[tier].targetGroups).map((arn) =>\r\n          elbv2Client.send(\r\n            new elbv2.RegisterTargetsCommand({\r\n              TargetGroupArn: arn,\r\n              Targets: [{ Id: instance.InstanceId! }],\r\n            }),\r\n          ),\r\n        ),\r\n      );\r\n\r\n      // Wait for this instance to successfully register with the load balancer\r\n      // before moving on to refreshing the next instance\r\n      for (;;) {\r\n        await sleepSeconds(3);\r\n        instanceHealth = (\r\n          await getInstanceHealth(CONFIG[tier].targetGroups.api, elbv2Client)\r\n        )[instance.InstanceId!];\r\n\r\n        log(`Instance health: ${instanceHealth}`);\r\n\r\n        // Instance health should be 'initial' while it's registering and\r\n        // 'healthy' when it's registered It may enter another state e.g. if at\r\n        // that moment the scaling group decides to cut the instance In which\r\n        // case, move on to the next instance to avoid getting stuck on the dying\r\n        // instance\r\n        if (instanceHealth === 'healthy') {\r\n          log('Instance is back online!');\r\n          break;\r\n        } else if (instanceHealth !== 'initial') {\r\n          log(\r\n            `Instance is in an unexpected state (${instanceHealth}) - moving on to next instance`,\r\n          );\r\n          void postErrorMessage(`During deployment to ${tier}, instance in unexpected health state after server restart\r\n\\`\\`\\`\r\nInstance ID: ${instance.InstanceId}\r\nHost name: ${instance.PrivateDnsName}\r\nHealth status: ${instanceHealth}\r\n\\`\\`\\`\r\n`);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Job done. Let's post about it!\r\n    let msg = `Redeployed ${tier}: ${gitCommitTitle || ''}${\r\n      gitCommitHash\r\n        ? ` (<https://github.com/getcord/monorepo/commit/${gitCommitHash}|${gitCommitHash.substr(\r\n            0,\r\n            10,\r\n          )}>)`\r\n        : ''\r\n    }\r\n\u2022 Package version: ${packageVersion}\r\n\u2022 Image: \\`${imageName}\\``;\r\n\r\n    try {\r\n      const compress = promisify(zlib.brotliCompress);\r\n      const sdk = await fs.readFile(\r\n        `dist/${tier}/external/sdk/v1/sdk.latest.js`,\r\n      );\r\n      const compressed = await compress(sdk);\r\n\r\n      const sdkBytes = sdk.length;\r\n      const sdkCompressedBytes = compressed.length;\r\n\r\n      await db.query(\r\n        'UPDATE cord.deploys SET \"sdkBytes\"=$1, \"sdkCompressedBytes\"=$2 WHERE id=$3',\r\n        [sdkBytes, sdkCompressedBytes, deployID],\r\n      );\r\n      msg += `\r\n\u2022 SDK size: ${sdkBytes} bytes, ${sdkCompressedBytes} bytes compressed`;\r\n    } catch (err) {\r\n      log('Failed to estimate sdk size', err);\r\n    }\r\n\r\n    await postInfoMessage(msg);\r\n    // We should catch any exceptions thrown by the following code, because if\r\n    // we don't we will post the generic \"push failed\" error message to Slack.\r\n\r\n    // Finally, upload static content to S3 and tell CloudFront to invalidate its\r\n    // caches.\r\n    try {\r\n      log('Upload static content to S3');\r\n      await Promise.all([\r\n        runCommandLine('aws', [\r\n          's3',\r\n          'cp',\r\n          '--recursive',\r\n          '--exclude',\r\n          '*.js',\r\n          `dist/${tier}/external/`,\r\n          `s3://${env.APP_SERVER_HOST}/`,\r\n        ]),\r\n        runCommandLine('aws', [\r\n          's3',\r\n          'cp',\r\n          '--recursive',\r\n          '--exclude',\r\n          '*',\r\n          '--include',\r\n          '*.js',\r\n          '--content-type',\r\n          'application/javascript; charset=utf-8',\r\n          `dist/${tier}/external/`,\r\n          `s3://${env.APP_SERVER_HOST}/`,\r\n        ]),\r\n      ]).then((codes) => {\r\n        if (codes[0] !== 0 || codes[1] !== 0) {\r\n          throw new Error(`'aws s3 cp' failed with exit code ${codes}`);\r\n        }\r\n      });\r\n    } catch (err) {\r\n      await postErrorMessage(`Publishing assets on S3 failed with error\r\n\\`\\`\\`\r\n${inspect(err, false, 10, false)}\r\n\\`\\`\\``);\r\n    }\r\n\r\n    // Invalidate S3 CloudFront\r\n    log('Invalidate S3 CloudFront');\r\n\r\n    try {\r\n      await retryOnError(\r\n        'Invalidating S3 CloudFront',\r\n        async () => {\r\n          const cloudfrontClient = new cloudfront.CloudFrontClient({\r\n            region: AWS_REGION,\r\n          });\r\n\r\n          const invalidation = await cloudfrontClient.send(\r\n            new cloudfront.CreateInvalidationCommand({\r\n              DistributionId: CONFIG[tier].cloudFrontDistributionID,\r\n              InvalidationBatch: {\r\n                Paths: { Quantity: 1, Items: ['/*'] },\r\n                CallerReference: `deploy-${Date.now()}`,\r\n              },\r\n            }),\r\n          );\r\n          log(\r\n            `Created CloudFront invalidation (id: ${invalidation.Invalidation?.Id})`,\r\n          );\r\n        },\r\n        {\r\n          retries: 10,\r\n          retryIf: (err) => err.Code === 'ServiceUnavailable',\r\n        },\r\n      );\r\n    } catch (err) {\r\n      await postErrorMessage(`Invalidating S3 CloudFront failed\r\n\\`\\`\\`\r\n${inspect(err, false, 10, false)}\r\n\\`\\`\\``);\r\n      // Continue the script anyway, this isn't a major problem\r\n    }\r\n\r\n    // If requested on the command line, tag the deployed image. This is useful,\r\n    // e.g. when we are deploying to staging to keep updating the \"staging\" tag in\r\n    // the Docker registry to point to the latest image that got successfully\r\n    // deployed to staging.\r\n    if (argv.pushOnSuccess) {\r\n      try {\r\n        await dockerTag(localDocker, imageName, argv.pushOnSuccess);\r\n\r\n        await localDocker\r\n          .getImage(argv.pushOnSuccess)\r\n          .push({ authconfig: ecrAuth } as any);\r\n      } catch (err) {\r\n        await postErrorMessage(`Updating the Docker tag '${\r\n          argv.pushOnSuccess\r\n        }' failed\r\n  \\`\\`\\`\r\n  ${inspect(err, false, 10, false)}\r\n  \\`\\`\\``);\r\n      }\r\n    }\r\n\r\n    await postInfoMessage('Deployment procedure finished');\r\n  })().then(\r\n    () =>\r\n      db.query(\r\n        `UPDATE cord.deploys SET \"deployFinishTime\"=NOW(), success=TRUE WHERE id=$1;`,\r\n        [deployID],\r\n      ),\r\n    async (error) => {\r\n      let errorString = '';\r\n      try {\r\n        errorString = inspect(error);\r\n      } catch (_) {\r\n        errorString = `${error}`;\r\n      }\r\n      await db.query(\r\n        `UPDATE cord.deploys SET \"deployFinishTime\"=NOW(), success=FALSE, error=$1 WHERE id=$2;`,\r\n        [errorString, deployID],\r\n      );\r\n      return await Promise.reject(error);\r\n    },\r\n  );\r\n\r\n  // Finally, just do an instance refresh for the async worker, to get it\r\n  // replaced with the current version. (Before triggering an instance refresh,\r\n  // cancel any ongoing ones.)\r\n  await asClient\r\n    .send(\r\n      new autoscaling.CancelInstanceRefreshCommand({\r\n        AutoScalingGroupName: `${tier}-asyncWorker`,\r\n      }),\r\n    )\r\n    // Ignore ActiveInstanceRefreshNotFound errors\r\n    .catch((err) =>\r\n      err.Error?.Code === 'ActiveInstanceRefreshNotFound'\r\n        ? null\r\n        : Promise.reject(err),\r\n    );\r\n\r\n  await asClient.send(\r\n    new autoscaling.StartInstanceRefreshCommand({\r\n      AutoScalingGroupName: `${tier}-asyncWorker`,\r\n    }),\r\n  );\r\n\r\n  return 0;\r\n}\r\n\r\n/**\r\n * Obtain a list of ec2.Instance objects for a given autoscaling group name\r\n */\r\nasync function getAutoscalingGroupInstances(\r\n  autoScalingGroupName: string,\r\n  asClient: autoscaling.AutoScalingClient,\r\n  ec2Client: ec2.EC2Client,\r\n) {\r\n  const { AutoScalingInstances: asInstances } = await asClient.send(\r\n    new autoscaling.DescribeAutoScalingInstancesCommand({}),\r\n  );\r\n  const instanceIDs = (asInstances ?? [])\r\n    .filter(\r\n      (instance) =>\r\n        instance.AutoScalingGroupName === autoScalingGroupName &&\r\n        instance.LifecycleState === 'InService',\r\n    )\r\n    .map((instance) => instance.InstanceId)\r\n    .filter((x?: string): x is string => x !== undefined);\r\n\r\n  const response = await ec2Client.send(\r\n    new ec2.DescribeInstancesCommand({ InstanceIds: instanceIDs }),\r\n  );\r\n\r\n  return (\r\n    (response.Reservations ?? [])\r\n      .map((reservation) => reservation.Instances ?? [])\r\n      .flat()\r\n      // only return instances that have these fields\r\n      .filter(({ InstanceId, PrivateDnsName }) => InstanceId && PrivateDnsName)\r\n  );\r\n}\r\n\r\n/**\r\n * Obtain auth object for Docker pull\r\n */\r\nasync function getEcrAuth(ecrClient: ecr.ECRClient) {\r\n  const ecrAuthToken = await ecrClient.send(\r\n    new ecr.GetAuthorizationTokenCommand({}),\r\n  );\r\n  const token = ecrAuthToken.authorizationData?.[0].authorizationToken;\r\n\r\n  if (!token) {\r\n    throw new Error('Could not obtain ECR login credentials');\r\n  }\r\n\r\n  const f = decode(token).split(':');\r\n\r\n  if (f.length !== 2) {\r\n    throw new Error('Invalid ECR login credentials');\r\n  }\r\n\r\n  return { username: f[0], password: f[1] };\r\n}\r\n\r\n/**\r\n * Pull an image from a remote Docker repository\r\n *\r\n * The Dockerode API is a bit awkward here: since we want to pass authentication\r\n * details, we must provide a callback instead of getting a promise returned.\r\n * This function wraps that awkward API to reduce code clutter.\r\n */\r\nfunction dockerPull(\r\n  docker: Docker,\r\n  repoTag: string,\r\n  auth: { username: string; password: string },\r\n): Promise<void> {\r\n  return retryOnError(\r\n    'dockerPull',\r\n    () =>\r\n      new Promise<void>((resolve, reject) =>\r\n        docker.pull(\r\n          repoTag,\r\n          {},\r\n          (err, stream: NodeJS.ReadableStream | undefined) => {\r\n            if (stream && !err) {\r\n              let error: any = undefined;\r\n\r\n              // Discard all data. If we don't register this event handler, the\r\n              // stream just blocks.\r\n              stream.on('data', (data: Buffer) => {\r\n                if (error === undefined) {\r\n                  try {\r\n                    const parsed = JSON.parse(data.toString('utf-8'));\r\n                    if (parsed.error) {\r\n                      error = new Error(parsed.error);\r\n                    }\r\n                    // eslint-disable-next-line @typescript-eslint/no-shadow -- Disabling for pre-existing problems. Please do not copy this comment, and consider fixing this one!\r\n                  } catch (err: any) {\r\n                    error = err;\r\n                  }\r\n                }\r\n              });\r\n              stream.once('end', () => {\r\n                if (error !== undefined) {\r\n                  reject(error);\r\n                } else {\r\n                  resolve();\r\n                }\r\n              });\r\n            } else {\r\n              reject(err);\r\n            }\r\n          },\r\n          auth,\r\n        ),\r\n      ),\r\n    {\r\n      retryIf: (err) => err.statusCode === 404,\r\n    },\r\n  );\r\n}\r\n\r\n/**\r\n * Tag a Docker image\r\n */\r\nasync function dockerTag(\r\n  docker: Docker,\r\n  existingImage: string,\r\n  newTag: string,\r\n) {\r\n  // If \"newTag\" is not of the form \"repo:tag\", then we can't add that tag. We\r\n  // can just silently ignore this case here.\r\n\r\n  const match = /^(?<repo>.*):(?<tag>.*)$/.exec(newTag);\r\n  if (match && match.groups) {\r\n    const { repo, tag } = match.groups;\r\n    await docker.getImage(existingImage).tag({ repo, tag });\r\n  }\r\n}\r\n\r\nasync function getInstanceHealth(\r\n  targetGroupArn: string,\r\n  elbv2Client: elbv2.ElasticLoadBalancingV2Client,\r\n) {\r\n  const response = await elbv2Client.send(\r\n    new elbv2.DescribeTargetHealthCommand({\r\n      TargetGroupArn: targetGroupArn,\r\n    }),\r\n  );\r\n  return Object.fromEntries<string>(\r\n    (response.TargetHealthDescriptions ?? [])\r\n      .map((hd) => [hd.Target?.Id, hd.TargetHealth?.State])\r\n      .filter((x: any): x is [string, string] => x[0] && x[1]),\r\n  );\r\n}\r\n\r\nasync function drainServer(hostname: string) {\r\n  const port = Number(env.STATUS_SERVER_PORT);\r\n\r\n  if (!Number.isNaN(port)) {\r\n    log('Contacting instance and requesting graceful shutdown');\r\n    const response = await fetch(\r\n      `http://${hostname}:${env.STATUS_SERVER_PORT}/drain-and-wait`,\r\n      {\r\n        method: 'POST',\r\n        // Don't wait longer than one minute here!\r\n        signal: AbortSignal.timeout(60 * 1000),\r\n      },\r\n    ).catch((err) => {\r\n      logError(err);\r\n      return null;\r\n    });\r\n\r\n    if (\r\n      response &&\r\n      response.status === 200 &&\r\n      (await response.text()) === 'terminating'\r\n    ) {\r\n      // All is well, we can return immediately\r\n      log('Server terminated gracefully');\r\n      return;\r\n    }\r\n  }\r\n\r\n  // We couldn't connect to the server, or requesting the draining somehow\r\n  // failed (or timed out). Let's wait another 10s and hope for the best.\r\n  log(`Could not trigger graceful shutdown of ${hostname} - waiting 10s`);\r\n  await sleepSeconds(10);\r\n}\r\n\r\nasync function waitForServerInit(hostname: string) {\r\n  const port = Number(env.STATUS_SERVER_PORT);\r\n\r\n  if (Number.isNaN(port)) {\r\n    log(\r\n      `Server status port not configured - cannot check for initialisation - waiting 10s and hoping for the best`,\r\n    );\r\n    return await sleepSeconds(10);\r\n  }\r\n\r\n  // Contact the newly started server's status port and request\r\n  // `/wait-for-init`. This might fail because the server is still starting up\r\n  // and is not listening on that port yet. In that case we wait 2 seconds and\r\n  // retry, up to 10 times. If it fails for another reason, we also retry\r\n  // after 2 seconds. Once we get the 'ok' from the server, we return from\r\n  // this function. If that doesn't happen after 10 attempts, we throw an\r\n  // error. At this point it looks like the new server version doesn't work -\r\n  // abort the deploy!\r\n  await retryOnError(\r\n    'Wait for init',\r\n    async () => {\r\n      const response = await fetch(\r\n        `http://${hostname}:${env.STATUS_SERVER_PORT}/wait-for-init`,\r\n        {\r\n          // Once we can connect to the server, the start-up is usually super\r\n          // quick, so we don't expect to have to wait for a long time. Don't wait\r\n          // longer than ten seconds here!\r\n          signal: AbortSignal.timeout(10 * 1000),\r\n        },\r\n      );\r\n      if (\r\n        !(\r\n          response &&\r\n          response.status === 200 &&\r\n          (await response.text()) === 'ok'\r\n        )\r\n      ) {\r\n        throw new Error('Received bad response from server');\r\n      }\r\n    },\r\n    {\r\n      retries: 10,\r\n      retryDelaySeconds: 2,\r\n    },\r\n  );\r\n}\r\n\r\ntype RetryOptions = {\r\n  retries?: number;\r\n  retryIf?: (err: any) => boolean;\r\n  retryDelaySeconds?: number;\r\n};\r\n\r\nasync function retryOnError<T>(\r\n  operationName: string,\r\n  operation: () => Promise<T>,\r\n  options: RetryOptions,\r\n): Promise<T> {\r\n  const opts: Required<RetryOptions> = {\r\n    retries: 3,\r\n    retryIf: (_) => true,\r\n    retryDelaySeconds: 5,\r\n    ...options,\r\n  };\r\n  try {\r\n    return await operation();\r\n  } catch (err) {\r\n    if (opts.retries > 0 && opts.retryIf(err)) {\r\n      log(`${operationName} failed, retrying (retries=${opts.retries})`);\r\n      await sleepSeconds(opts.retryDelaySeconds);\r\n      return await retryOnError(operationName, operation, {\r\n        ...opts,\r\n        retries: opts.retries - 1,\r\n      });\r\n    } else {\r\n      log(`${operationName} failed:`, inspect(err, false, 10, false));\r\n      throw err;\r\n    }\r\n  }\r\n}\r\n\r\nmain().then(\r\n  (code) => process.exit(code),\r\n  (err) => {\r\n    logError(err);\r\n    process.exit(1);\r\n  },\r\n);\r\n", "import type { Tier } from 'ops/aws/src/common.ts';\r\n\r\n// AWS Environment values\r\nexport const AWS_REGION = 'eu-west-2';\r\n\r\n// Default resource owner, used for tagging resources with tags that Vanta reads\r\nexport const DEFAULT_OWNER = 'dmmiller@cord.com';\r\n\r\n// all the domains under which we serve the product\r\nexport const CORD_COM_DOMAINS = [\r\n  'cord.com',\r\n  'getradical.co',\r\n  'cord.so',\r\n  'cord.fyi',\r\n];\r\n\r\n// Web site domain name\r\nexport const WEB_SITE_DOMAIN = 'cord.com';\r\n\r\n// domains for which we set up gmail\r\nexport const GMAIL_DOMAINS = ['cord.com', 'cord.so', 'getradical.co'];\r\n\r\n// Domain TXT records, for Google site verification and such things\r\nexport const TXT_RECORDS = {\r\n  'getradical.co': [\r\n    'google-site-verification=BtgOe3c6_AitAdNHNDU-2dedVumtkfO5OAHpnUNrEyM',\r\n  ],\r\n  'cord.com': [\r\n    'google-site-verification=o0E3i6wuU7HmxGIf_D7jLS089pFF7l19xfj8OebZ8ds',\r\n    'google-site-verification=33uewWcG3InRmPHAs8TUHCjGTHZonvQzd7MxjPZSaEo',\r\n    'OSSRH-82140',\r\n    'ahrefs-site-verification_4b6190ed0dbc98695c8737c1ad9070106203ccfca7f7cd1f309a73010d2cf744',\r\n  ],\r\n  'cord.so': [\r\n    'google-site-verification=gjiL3OQHqmQnYx7KyujYpX29mEvyyxnCwfRfIMwr1cQ',\r\n  ],\r\n};\r\n\r\n// Domain keys for DKIM\r\nexport const DOMAIN_KEYS = {\r\n  'getradical.co': {\r\n    // google = Google (our email)\r\n    google:\r\n      'v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA9UaUXI2l/R6DevMnY5lLzBGSmaK3sS5l1TGNMTu/oSlPTEaNJyiDt3b3zNrmoqWpMziPL6O5WwAG+l8CowD7gAnvjHujrIcPyP+EQ2k7+wh2pHk7prgITmTurljQKi2VedEfbRyT4u7UFctazXU0k4axUZGIjiQwrEAWR4ubgg9KEhZrFWPszOKeHTUsF9KahoasIJoPFfDS1FAiDYJcMDXAKg+4RjKM9aH42ADHht/gx98oQe4uwtJuCmfo/IvS5txTdRZMBeQ8Aip4jRRzqzdJVTTzsCE6eOnlsHyIpfWVtHK8uO41Est2s76EhpikVGt3NMRdsbHiJNgVYmmaCwIDAQAB',\r\n  },\r\n  'cord.com': {\r\n    // google = Google (our email)\r\n    google:\r\n      'v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAiwzgkiUn2tEnh417+3ate4MfoK72XsUU2PKXAyQ8BOzmb3AcpnrYcyafFLWGxSZfFvai3F2PcRGe02JWDq2+x7YlS/JICm6vyyofM/F1qu1/YZv2+7xNyDEx0R2ccQGgOXrczX2ecWu7aHnCRWgQB0UtKE/78OYXEvoKeSQnFjmeY2v4KGu1W35gQ9o7Y44jNJrXKrsPTV+iIwuoaqh/F2zsDBgt0izEiiQcSaNJyXx3RKinQDhlKMTCR9gM4yQ4Zmi+S+M4BrZZ6WZD0P1sBiO5vfs4k7zCwWr2c+MLYwPIexw12T6socOtqcAjoHLkZ3gYHCGzNIz3Ct6aM/is4wIDAQAB',\r\n  },\r\n  'cord.so': {\r\n    // google = Google (our email)\r\n    // random strings: ...amazonses.com = Loops (marketing)\r\n    google:\r\n      'v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAn/NFJgjIFscAVGv8jbgDL0wr+Dh3nJxKAyxy31FyhEzUIJYwEtR9KyQXWeAO7D/sCEQ7dA+Dqum6kuiLc/OSFg4vu8bkYkQb0Vw5+2eQbTKoh/DQ5ju8Txiudd0r0SzQGx7YWzmJcfLPe1Jqa4AaYraZRCLyRDbfdg9bhOxaLJ+aUbX7xZVPEL35RfkW2Stlf3Ny7rl25bHRPFUnJQJflOkldXLZyRknXGP3s6eCXoAH84WVNr5XjPbUEUFwS9/TbDj7QKcQIcAPwRPH8/4arvw2j8nSzZHpVidIVyPO+J8ToUnRia33JT6uvqgsE3jBEQTSJyFOGNXiJ8eu8G/SZQIDAQAB',\r\n    gw7lwwllla3tk33rzzpi4pkk7b7vzw65:\r\n      'CNAME:gw7lwwllla3tk33rzzpi4pkk7b7vzw65.dkim.amazonses.com.',\r\n    jgxjf2ny7ruwqsflekpn27zft64maxn7:\r\n      'CNAME:jgxjf2ny7ruwqsflekpn27zft64maxn7.dkim.amazonses.com.',\r\n    wwmfgpjwizpjhbulmahzlx65e22z6oko:\r\n      'CNAME:wwmfgpjwizpjhbulmahzlx65e22z6oko.dkim.amazonses.com.',\r\n  },\r\n  'cord.fyi': {\r\n    // s1, s2 = Sendgrid (product notifications)\r\n    s1: 'CNAME:s1.domainkey.u16847044.wl045.sendgrid.net',\r\n    s2: 'CNAME:s2.domainkey.u16847044.wl045.sendgrid.net',\r\n  },\r\n};\r\n\r\ntype SpfType = Record<string, string | Record<string, string> | undefined> & {\r\n  default: string;\r\n};\r\n\r\n// SPF records\r\nexport const SPF_RECORDS: SpfType = {\r\n  // _spf.google.com = Google (our email)\r\n  // amazonses.com = Loops (marketing)\r\n  // sendgrid.net = Sendgrid (product notifications)\r\n  default: 'v=spf1 include:_spf.google.com ~all',\r\n  'cord.com': 'v=spf1 include:_spf.google.com ~all',\r\n  'cord.so': {\r\n    '@': 'v=spf1 include:_spf.google.com ~all',\r\n    envelope: 'v=spf1 include:amazonses.com ~all',\r\n  },\r\n  'cord.fyi': 'v=spf1 include:sendgrid.net -all',\r\n};\r\n\r\n// CI/CD values\r\nexport const ECR_SERVER_REPO_NAME = 'server';\r\nexport const ECR_ONCALL_REPO_NAME = 'oncall';\r\n\r\nexport const SLACK_OAUTH_STATE_SIGNING_SECRET = 'SlackOauthStateSigningSecret';\r\nexport const SLACK_OAUTH_STATE_SIGNING_KEY_REF_NAME =\r\n  'SlackOauthStateSigningSecretKey';\r\n\r\nexport const SENDGRID_INBOUND_WEBHOOK_SECRET = 'SendgridInboundWebhookSecret';\r\nexport const SENDGRID_INBOUND_WEBHOOK_SECRET_KEY_REF_NAME =\r\n  'SendgridInboundWebhookSecretKey';\r\n\r\nexport const CORD_COM_WILDCARD_CERTIFICATE_US_EAST_1 =\r\n  'arn:aws:acm:us-east-1:869934154475:certificate/179f1ac1-4c87-429c-87fd-e3b9a2af4f0b';\r\nexport const STAGING_CORD_COM_WILDCARD_CERTIFICATE_US_EAST_1 =\r\n  'arn:aws:acm:us-east-1:869934154475:certificate/6247511e-1ff8-4ca4-a008-b17cb7c1346b';\r\nexport const LOADTEST_CORD_COM_WILDCARD_CERTIFICATE_US_EAST_1 =\r\n  'arn:aws:acm:us-east-1:869934154475:certificate/793e84be-608a-4e54-bdee-efadbc068510';\r\n\r\ntype ScalingConstraints = {\r\n  minCapacity: number;\r\n  maxCapacity: number;\r\n};\r\nexport const SERVER_AUTOSCALING_CAPACITY: {\r\n  [k in Tier]: ScalingConstraints;\r\n} = {\r\n  prod: {\r\n    minCapacity: 6,\r\n    maxCapacity: 12,\r\n  },\r\n  staging: {\r\n    minCapacity: 2,\r\n    maxCapacity: 4,\r\n  },\r\n  loadtest: {\r\n    minCapacity: 4,\r\n    maxCapacity: 4,\r\n  },\r\n};\r\n", "// There is some TypeScript trickery in this file. It is optimised for making\r\n// the use of `magicEnv` look good. The call to `magicEnv` should look readable\r\n// and self-explanatory, and the type hints displayed by the IDE should be\r\n// useful.\r\n\r\n// Define types to declare variables as required, optional or having a default\r\n// value.  If these classes were empty, TypeScript would treat them as\r\n// interchangeable. By giving them different shapes (i.e. different members),\r\n// TypeScript will keep them apart.\r\nclass RequiredVariable {\r\n  public readonly req = true;\r\n}\r\nclass OptionalVariable {\r\n  public readonly opt = true;\r\n}\r\nclass VariableWithDefaultValue {\r\n  constructor(public readonly defaultValue: string) {}\r\n}\r\n\r\n// These are the helpers that are used by the caller of `magicEnv` to define\r\n// their environment fields.\r\nexport const required = new RequiredVariable();\r\nexport const optional = new OptionalVariable();\r\n// eslint-disable-next-line @typescript-eslint/no-shadow -- Disabling for pre-existing problems. Please do not copy this comment, and consider fixing this one!\r\nexport const defaultValue = (defaultValue: string) =>\r\n  new VariableWithDefaultValue(defaultValue);\r\n\r\n// Here comes the main function of this module: `magicEnv`. It takes one\r\n// parameter: a JavaScript object with string keys and values of type\r\n// RequiredVariable, OptionalVariable or VariableWithDefaultValue.\r\n//\r\n// `magicEnv` is a template function, which is quite important.\r\n// `EnvDefinitionType` is the specific type of the environment definition.\r\n// That type must comply with the restriction that it is an object with string\r\n// keys and those variable types as values.  However, we will need the\r\n// *specific* type, i.e. a TypeScript type that contains the specific keys with\r\n// the corresponding value types. We get access to this type by templating this\r\n// function.\r\nexport function magicEnv<\r\n  EnvDefinitionType extends {\r\n    [key: string]:\r\n      | RequiredVariable\r\n      | OptionalVariable\r\n      | VariableWithDefaultValue;\r\n  },\r\n>(\r\n  processEnv: { [key: string]: string | undefined },\r\n  envDefinition: EnvDefinitionType,\r\n) {\r\n  // Now start constructing the result of this function.\r\n  const env: Partial<{ [k in keyof EnvDefinitionType]: string }> = {};\r\n\r\n  // And now we iterate through the `envDefinition` object, which we received\r\n  // from the callback function.\r\n  for (const key of Object.keys(envDefinition) as (string &\r\n    keyof EnvDefinitionType)[]) {\r\n    // This is the value from the process environment\r\n    const value: string | undefined = processEnv[key];\r\n\r\n    // This is the value from the definition object at the top\r\n    const fieldDefinition:\r\n      | RequiredVariable\r\n      | OptionalVariable\r\n      | VariableWithDefaultValue = envDefinition[key];\r\n\r\n    if ((fieldDefinition as any).req) {\r\n      // This is a required variable.\r\n\r\n      if (value === undefined) {\r\n        throw new Error(`Missing key ${key} in environment`);\r\n      } else {\r\n        env[key] = value;\r\n      }\r\n    } else if ((fieldDefinition as any).opt) {\r\n      // This is an optional variable. `value` may be a string or undefined.\r\n\r\n      env[key] = value;\r\n    } else {\r\n      // This is a variable with a default value (the value of\r\n      // `fieldDefinition`)\r\n\r\n      if (value === undefined) {\r\n        env[key] = (fieldDefinition as VariableWithDefaultValue).defaultValue;\r\n      } else {\r\n        env[key] = value;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Return the `env` object that we have just constructed, but return with a\r\n  // special type that we define here: it is an object which contains all the\r\n  // keys that the definition object has. The value type is `string`, except\r\n  // for fields that correspond to optional variables, those have type\r\n  // `string | undefined`. All fields are declared readonly.\r\n  return env as {\r\n    readonly [k in keyof EnvDefinitionType]: EnvDefinitionType[k] extends OptionalVariable\r\n      ? string | undefined\r\n      : string;\r\n  };\r\n}\r\n", "import {\r\n  magicEnv,\r\n  required,\r\n  optional,\r\n  defaultValue,\r\n} from 'server/src/config/MagicEnv.ts';\r\n\r\nexport default magicEnv(process.env, {\r\n  // `process.env.NODE_ENV` is used in our code, but also in many third party\r\n  // libraries we import, to switch between development and production mode.\r\n  // Just to make sure it is set in the process environment, we include it here.\r\n  NODE_ENV: required,\r\n\r\n  // Normally one of `prod`, `staging`, `dev`, `test`, or `loadtest`\r\n  CORD_TIER: required,\r\n\r\n  // Accept connections on these ports\r\n  API_SERVER_PORT: optional,\r\n  ADMIN_SERVER_PORT: optional,\r\n  METRICS_SERVER_PORT: optional,\r\n  STATUS_SERVER_PORT: optional,\r\n  CONSOLE_SERVER_PORT: optional,\r\n  DOCS_SERVER_PORT: optional,\r\n\r\n  // PostgreSQL connection configuration - required\r\n  POSTGRES_HOST: required,\r\n  POSTGRES_PORT: required,\r\n  POSTGRES_USER: required,\r\n  POSTGRES_PASSWORD: required,\r\n  POSTGRES_DB: required,\r\n\r\n  // PostgreSQL read-only server, if there is one (user/password/db setting same\r\n  // as above)\r\n  POSTGRES_READ_HOST: optional,\r\n  POSTGRES_READ_PORT: optional,\r\n\r\n  // Redis connection configuration\r\n  REDIS_PORT: required,\r\n  REDIS_HOST: required,\r\n  PREDIS_PORT: required,\r\n  PREDIS_HOST: required,\r\n\r\n  // URLs pointing to our own endpoints\r\n  TOP_SERVER_HOST: required,\r\n  APP_SERVER_HOST: required,\r\n  API_SERVER_HOST: required,\r\n  API_SERVER_HOST_PRODUCTION: required,\r\n  ADMIN_SERVER_HOST: required,\r\n  MARKETING_SERVER_HOST: required,\r\n  PUBLIC_UPLOADS_HOST: required,\r\n  CONSOLE_SERVER_HOST: required,\r\n  CORD_TO_HOST: required,\r\n  DOCS_SERVER_HOST: required,\r\n  CLACK_SERVER_HOST: optional,\r\n  COMMUNITY_SERVER_HOST: required,\r\n\r\n  // Slack App credentials - required\r\n  SLACK_APP_CLIENT_SECRET: required,\r\n  SLACK_DEV_APP_CLIENT_SECRET: required,\r\n  SLACK_ADMIN_LOGIN_REDIRECT_HOST: optional,\r\n  SLACK_APP_REDIRECT_HOST: optional,\r\n  SLACK_SIGNING_SECRET: required,\r\n  SLACK_ADMIN_CLIENT_SECRET: required,\r\n  SLACK_ADMIN_SIGNING_SECRET: required,\r\n  SLACK_INTERNAL_BOT_TOKEN: required,\r\n  SLACK_INTERNAL_SIGNING_SECRET: required,\r\n  SLACK_CUSTOMER_UPDATES_BOT_TOKEN: required,\r\n\r\n  // S3 Bucket File storage\r\n  S3_ACCESS_KEY_ID: optional,\r\n  S3_ACCESS_KEY_SECRET: optional,\r\n  S3_REGION: required,\r\n  S3_BUCKET: required,\r\n  S3_PUBLIC_BUCKET: required,\r\n  S3_ENDPOINT: required,\r\n  S3_USE_PATH_BASED_URLS: required,\r\n\r\n  EMAIL_LINKS_TOKEN_SECRET: required,\r\n\r\n  // Jira App credentials - required\r\n  JIRA_APP_CLIENT_ID: required,\r\n  JIRA_APP_CLIENT_SECRET: required,\r\n\r\n  // Asana App credentials - required\r\n  ASANA_APP_CLIENT_ID: required,\r\n  ASANA_APP_CLIENT_SECRET: required,\r\n\r\n  // Linear App credentials - required\r\n  LINEAR_APP_CLIENT_ID: required,\r\n  LINEAR_APP_CLIENT_SECRET: required,\r\n\r\n  // Trello App credentials - required\r\n  TRELLO_APP_CLIENT_ID: required,\r\n  TRELLO_APP_CLIENT_SECRET: required,\r\n\r\n  // Monday App credentials - required\r\n  MONDAY_APP_CLIENT_ID: required,\r\n  MONDAY_APP_CLIENT_SECRET: required,\r\n\r\n  // Secret for session tokens - required\r\n  JWT_SIGNING_SECRET: required,\r\n\r\n  // Secret for signing OAuth flow state variables encoding the user and org IDs\r\n  OAUTH_STATE_SIGNING_SECRET: required,\r\n\r\n  // Secret for signing Slack OAuth flow state variables encoding the user and org IDs\r\n  SLACK_OAUTH_STATE_SIGNING_SECRET: required,\r\n\r\n  // Log level for console logging - optional ('info' if not provided)\r\n  LOGLEVEL: defaultValue('info'),\r\n\r\n  // Post error messages to this Slack channel,\r\n  CORD_OPS_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Post informational changes to prod setup, including deploy and db migration\r\n  // messages, to this Slack channel\r\n  PROD_CHANGES_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Post security/SOC2 compliance messages to this Slack channel,\r\n  CORD_SECURITY_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Post info about go redirects to this Slack channel\r\n  CORD_GO_REDIRECTS_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Post messages from customers to this Slack channel\r\n  CORD_ALL_CUSTOMERS_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Post client request messages to this Slack channel\r\n  CORD_CLIENT_REQUESTS_SLACK_CHANNEL_ID: optional,\r\n\r\n  // For sending search queries from the docs site to Slack\r\n  CORD_DOCS_SEARCH_SLACK_CHANNEL_ID: optional,\r\n\r\n  // Cloudwatch config - optional. If these are not provided, Cloudwatch\r\n  // logging is disabled\r\n  CLOUDWATCH_LOGLEVEL: optional,\r\n  CLOUDWATCH_AWS_REGION: defaultValue('eu-west-2'), // our default region, London\r\n  CLOUDWATCH_LOG_GROUP_NAME: optional,\r\n  CLOUDWATCH_LOG_STREAM_NAME: optional,\r\n\r\n  // Host used when developing locally but an externally accessible url is\r\n  // needed. (example: d92dd1d1fa99.ngrok.io)\r\n  EXTERNAL_API_HOST_FOR_DEVELOPMENT: optional,\r\n\r\n  // path to static files for the admin app\r\n  ADMIN_SERVER_STATIC_PATH: defaultValue('dist/server/admin'),\r\n\r\n  // path to static files for the console app\r\n  CONSOLE_SERVER_STATIC_PATH: defaultValue('dist/server/console'),\r\n\r\n  // path to static files for the docs app\r\n  DOCS_SERVER_STATIC_PATH: defaultValue('dist/docs/static'),\r\n\r\n  // API key used to send transactional email notifications through Sendgrid.\r\n  SENDGRID_API_KEY: required,\r\n\r\n  // HTTP Basic Auth name and password for SendGrid's Inbound Parse webhooks\r\n  SENDGRID_INBOUND_WEBHOOK_USER: required,\r\n  SENDGRID_INBOUND_WEBHOOK_PASSWORD: required,\r\n\r\n  // API key used to fetch feature flags from LaunchDarkly\r\n  LAUNCHDARKLY_API_KEY: optional,\r\n\r\n  // Number of extra workers to run the api server in: 'auto' makes one per CPU; otherwise a specific number can be used\r\n  NUM_WORKERS: optional,\r\n\r\n  // Encryption key used when storing secrets in the database\r\n  PLATFORM_SECRETS_ENCRYPTION_KEY: required,\r\n\r\n  // Encryption key used when generating file permalinks\r\n  FILE_PROXY_SIGNING_SECRET_KEY: required,\r\n\r\n  // sentry.io environment setting\r\n  SENTRY_ENVIRONMENT: optional,\r\n  SENTRY_RELEASE: optional,\r\n  SENTRY_TRACE_SAMPLE_RATE: optional,\r\n\r\n  // Auth0 Environment variables\r\n  // 1) For SPA application\r\n  AUTH0_CLIENT_ID: required,\r\n  AUTH0_CUSTOM_LOGIN_DOMAIN: required,\r\n\r\n  // 2) For verifying incoming events\r\n  AUTH0_WEBHOOK_SECRET: required,\r\n\r\n  // 3) For server to server communication\r\n  AUTH0_MTM_CLIENT_ID: required,\r\n  AUTH0_MTM_CLIENT_SECRET: required,\r\n  AUTH0_GENERAL_DOMAIN: required,\r\n\r\n  // console.cord.com cord app credentials\r\n  DEV_CONSOLE_CORD_APP_SECRET: required,\r\n\r\n  // secret for signing admin tokens to serve as proof user is logged in to\r\n  // admin\r\n  ADMIN_TOKEN_SECRET: required,\r\n\r\n  // flag whether the SDK testbed should be built and served\r\n  INCLUDE_SDK_TESTBED: optional,\r\n\r\n  // secret for cookies on the docs web site\r\n  DOCS_COOKIE_PARSER_SECRET: optional,\r\n\r\n  // set email for all notifications when testing with users on testbed\r\n  TESTBED_USERS_EMAIL: optional,\r\n\r\n  // secret for creating searchable embeddings and generating search\r\n  // results within our docs\r\n  OPENAI_API_SECRET: required,\r\n\r\n  // secret for getting geographic information from an IP address\r\n  IPSTACK_API_SECRET: optional,\r\n\r\n  // Host for where we generate the ai chat bot in the docs\r\n  DOCS_AI_CHATBOT_SERVER_HOST: required,\r\n\r\n  // Google analytic events\r\n  GA_MEASUREMENT_ID: required,\r\n  GA_MEASUREMENT_PROTOCOL_API_SECRET: required,\r\n\r\n  // secret for stripe\r\n  STRIPE_SECRET_KEY: required,\r\n  STRIPE_WEBHOOK_SECRET_KEY: required,\r\n\r\n  DEMO_APPS_SHARED_SECRET: required,\r\n\r\n  // loops.so for sending newletters\r\n  LOOPS_SO_API_KEY: required,\r\n});\r\n", "import * as child_process from 'child_process';\r\n\r\nimport * as Slack from '@slack/web-api';\r\nimport pg from 'pg';\r\n\r\nimport env from 'server/src/config/Env.ts';\r\nimport sleep from 'common/util/sleep.ts';\r\n\r\n/**\r\n * Run a command line and return the exit code\r\n */\r\nexport function runCommandLine(\r\n  cmd: string,\r\n  args: string[],\r\n  options: child_process.SpawnOptions = {},\r\n  stdin?: string,\r\n): Promise<number | null> {\r\n  console.log(`Executing command:\\n  ${cmd} ${args.join(' ')}\\n`);\r\n  return new Promise<number | null>((resolve, reject) => {\r\n    const proc = child_process.spawn(cmd, args, {\r\n      stdio: [stdin === undefined ? 'ignore' : 'pipe', 'inherit', 'inherit'],\r\n      ...options,\r\n    });\r\n    if (stdin !== undefined && proc.stdin) {\r\n      const stream = proc.stdin;\r\n      stream.write(stdin, 'utf-8', () => stream.end());\r\n    }\r\n    proc.on('error', reject);\r\n    proc.once('close', (code) => resolve(code));\r\n  });\r\n}\r\n\r\nexport async function connectToDatabase() {\r\n  const clientConfig: pg.ClientConfig = {\r\n    user: env.POSTGRES_USER,\r\n    host: env.POSTGRES_HOST,\r\n    database: env.POSTGRES_DB,\r\n    password: env.POSTGRES_PASSWORD,\r\n    port:\r\n      env.POSTGRES_PORT !== undefined ? Number(env.POSTGRES_PORT) : undefined,\r\n  };\r\n\r\n  const client = new pg.Client(clientConfig);\r\n  await client.connect();\r\n  return client;\r\n}\r\n\r\nexport async function postMessageFactory(slackChannelID: string | undefined) {\r\n  if (slackChannelID) {\r\n    try {\r\n      const token = env.SLACK_INTERNAL_BOT_TOKEN;\r\n      let prefix = '';\r\n\r\n      const {\r\n        GITHUB_REPOSITORY,\r\n        GITHUB_RUN_ID,\r\n        GITHUB_RUN_NUMBER,\r\n        GITHUB_SERVER_URL,\r\n      } = process.env;\r\n      if (\r\n        GITHUB_REPOSITORY &&\r\n        GITHUB_RUN_ID &&\r\n        GITHUB_RUN_NUMBER &&\r\n        GITHUB_SERVER_URL\r\n      ) {\r\n        prefix = `[<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|#${GITHUB_RUN_NUMBER}>] `;\r\n      }\r\n\r\n      const slackClient = new Slack.WebClient(token);\r\n      return async (text: string) => {\r\n        try {\r\n          await slackClient.chat.postMessage({\r\n            channel: slackChannelID,\r\n            text: prefix + text,\r\n          });\r\n        } catch (err) {\r\n          console.error(`Error posting message to Slack: ${text}`, err);\r\n        }\r\n      };\r\n    } catch (err) {\r\n      console.error('Cannot post messages to Slack:', err);\r\n    }\r\n  }\r\n  return (text: string) => {\r\n    console.log(text);\r\n    return Promise.resolve();\r\n  };\r\n}\r\n\r\nexport const sleepSeconds = (seconds: number) => sleep(seconds * 1000);\r\n", "export default function sleep(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n"],
  "mappings": "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",
  "names": ["defaultValue", "err"]
}
