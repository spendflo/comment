!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiVanilla={})}(this,(function(n){"use strict";var t=0;function e(n){return n(this)}function r(n,t,e){return t(this,"function"==typeof e?e(n(this)):e)}var i,o=function(n,t){return n.unstable_is?n.unstable_is(t):t===n},u=function(n){return"init"in n},a=function(n){return!!n.write},f=new WeakMap,c=function(n,t){var e=f.get(n);e&&(f.delete(n),e(t))},v=function(n,t){n.status="fulfilled",n.value=t},l=function(n,t){n.status="rejected",n.reason=t},d=function(n,t){return!!n&&"v"in n&&"v"in t&&Object.is(n.v,t.v)},s=function(n,t){return!!n&&"e"in n&&"e"in t&&Object.is(n.e,t.e)},h=function(n){return!!n&&"v"in n&&n.v instanceof Promise},g=function(n){if("e"in n)throw n.e;return n.v},w=function(){var n=new WeakMap,t=new WeakMap,e=new Map,r=function(t){return n.get(t)},i=function(t,r){var i=n.get(t);if(n.set(t,r),e.has(t)||e.set(t,i),h(i)){var o="v"in r?r.v instanceof Promise?r.v:Promise.resolve(r.v):Promise.reject(r.e);i.v!==o&&c(i.v,o)}},w=function(n,t,e,r){var i=new Map(r?t.d:null),u=!1;e.forEach((function(e,r){!e&&o(n,r)&&(e=t),e&&(i.set(r,e),t.d.get(r)!==e&&(u=!0))})),(u||t.d.size!==i.size)&&(t.d=i)},p=function(n,t,e,o){var u,a,f=r(n),c={d:(null==f?void 0:f.d)||new Map,v:t};if(e&&w(n,c,e,o),d(f,c)&&f.d===c.d)return f;if(h(f)&&h(c)&&(a=c,"v"in(u=f)&&"v"in a&&u.v.orig&&u.v.orig===a.v.orig)){if(f.d===c.d)return f;c.v=f.v}return i(n,c),c},y=function(n,e,i,o){if("function"==typeof(null==(d=e)?void 0:d.then)){var u,a=function(){var e=r(n);if(h(e)&&e.v===c){var o=p(n,c,i);t.has(n)&&e.d!==o.d&&z(n,o,e.d)}},c=new Promise((function(n,t){var r=!1;e.then((function(t){r||(r=!0,v(c,t),n(t),a())}),(function(n){r||(r=!0,l(c,n),t(n),a())})),u=function(t){r||(r=!0,t.then((function(n){return v(c,n)}),(function(n){return l(c,n)})),n(t))}}));return c.orig=e,c.status="pending",function(n,t){f.set(n,t),n.catch((function(){})).finally((function(){return f.delete(n)}))}(c,(function(n){n&&u(n),null==o||o()})),p(n,c,i,!0)}var d;return p(n,e,i)},E=function n(e,f){var c=r(e);if(!f&&c){if(t.has(e))return c;if(Array.from(c.d).every((function(t){var r=t[0],i=t[1];if(o(e,r))return!0;var u=n(r);return u===i||d(u,i)})))return c}var v,l,h=new Map,p=!0,E={get signal(){return v||(v=new AbortController),v.signal},get setSelf(){return!l&&a(e)&&(l=function(){if(!p){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return b.apply(void 0,[e].concat(t))}}),l}};try{var m=e.read((function(t){if(o(e,t)){var i=r(t);if(i)return h.set(t,i),g(i);if(u(t))return h.set(t,void 0),t.init;throw new Error("no atom init")}var a=n(t);return h.set(t,a),g(a)}),E);return y(e,m,h,(function(){var n;return null==(n=v)?void 0:n.abort()}))}catch(n){return function(n,t,e){var o=r(n),u={d:(null==o?void 0:o.d)||new Map,e:t};return e&&w(n,u,e),s(o,u)&&o.d===u.d?o:(i(n,u),u)}(e,n,h)}finally{p=!1}},m=function(n,t){return!t.l.size&&(!t.t.size||1===t.t.size&&t.t.has(n))},M=function n(i){for(var a=!0,f=arguments.length,c=new Array(f>1?f-1:0),v=1;v<f;v++)c[v-1]=arguments[v];var l=i.write.apply(i,[function(n){return g(E(n))},function(f){for(var c,v=arguments.length,l=new Array(v>1?v-1:0),s=1;s<v;s++)l[s-1]=arguments[s];if(o(i,f)){if(!u(f))throw new Error("atom not writable");var h=r(f),g=y(f,l[0]);d(h,g)||function(n){var i=new Map,o=new WeakMap,u=function(n){var i,o=new Set(null==(i=t.get(n))?void 0:i.t);return e.forEach((function(t,e){var i;null!=(i=r(e))&&i.d.has(n)&&o.add(e)})),o};!function n(t){u(t).forEach((function(e){e!==t&&(i.set(e,(i.get(e)||new Set).add(t)),o.set(e,(o.get(e)||0)+1),n(e))}))}(n),function n(t){u(t).forEach((function(e){if(e!==t){var u=o.get(e);if(u&&o.set(e,--u),!u){var a,f=!(null==(a=i.get(e))||!a.size);if(f){var c=r(e),v=E(e,!0);f=!d(c,v)}f||i.forEach((function(n){return n.delete(e)}))}n(e)}}))}(n)}(f)}else c=n.apply(void 0,[f].concat(l));return a||j(),c}].concat(c));return a=!1,l},b=function(n){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];var i=M.apply(void 0,[n].concat(e));return j(),i},S=function n(e,i,o){var u,f=o||[];null==(u=r(e))||u.d.forEach((function(r,i){var o=t.get(i);o?o.t.add(e):i!==e&&n(i,e,f)})),E(e);var c={t:new Set(i&&[i]),l:new Set};if(t.set(e,c),a(e)&&e.onMount){var v=e.onMount;f.push((function(){var n=v((function(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return b.apply(void 0,[e].concat(t))}));n&&(c.u=n)}))}return o||f.forEach((function(n){return n()})),c},A=function n(e){var i,o=null==(i=t.get(e))?void 0:i.u;o&&o(),t.delete(e);var u=r(e);u&&(h(u)&&c(u.v),u.d.forEach((function(r,i){if(i!==e){var o=t.get(i);o&&(o.t.delete(e),m(i,o)&&n(i))}})))},z=function(n,e,r){var i=new Set(e.d.keys()),o=new Set;null==r||r.forEach((function(e,r){if(i.has(r))i.delete(r);else{o.add(r);var u=t.get(r);u&&u.t.delete(n)}})),i.forEach((function(e){var r=t.get(e);r?r.t.add(n):t.has(n)&&S(e,n)})),o.forEach((function(n){var e=t.get(n);e&&m(n,e)&&A(n)}))},j=function(){for(;e.size;){var n=Array.from(e);e.clear(),n.forEach((function(n){var e=n[0],i=n[1],o=r(e);if(o){var u=t.get(e);u&&o.d!==(null==i?void 0:i.d)&&z(e,o,null==i?void 0:i.d),u&&(h(i)||!d(i,o)&&!s(i,o))&&u.l.forEach((function(n){return n()}))}}))}};return{get:function(n){return g(E(n))},set:b,sub:function(n,e){var r=function(n){var e=t.get(n);return e||(e=S(n)),e}(n);j();var i=r.l;return i.add(e),function(){i.delete(e),function(n){var e=t.get(n);e&&m(n,e)&&A(n)}(n)}}}};n.atom=function(n,i){var o="atom"+ ++t,u={toString:function(){return o}};return"function"==typeof n?u.read=n:(u.init=n,u.read=e,u.write=r),i&&(u.write=i),u},n.createStore=w,n.getDefaultStore=function(){return i||(i=w()),i}}));
