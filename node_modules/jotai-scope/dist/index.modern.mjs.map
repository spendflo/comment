{"version":3,"file":"index.modern.mjs","sources":["../src/createIsolation.tsx","../src/ScopeProvider.tsx"],"sourcesContent":["import { createContext, useContext, useRef } from 'react';\nimport type { ReactNode } from 'react';\nimport { createStore } from 'jotai/vanilla';\nimport {\n  useAtom as useAtomOrig,\n  useAtomValue as useAtomValueOrig,\n  useSetAtom as useSetAtomOrig,\n} from 'jotai/react';\nimport { useHydrateAtoms } from 'jotai/react/utils';\n\ntype Store = ReturnType<typeof createStore>;\ntype InitialValues = Parameters<typeof useHydrateAtoms>[0];\n\nexport function createIsolation() {\n  const StoreContext = createContext<Store | null>(null);\n\n  const Provider = ({\n    store,\n    initialValues = [] as unknown as InitialValues,\n    children,\n  }: {\n    store?: Store;\n    initialValues?: InitialValues;\n    children: ReactNode;\n  }) => {\n    const storeRef = useRef(store);\n    if (!storeRef.current) {\n      storeRef.current = createStore();\n    }\n    useHydrateAtoms(initialValues, { store: storeRef.current });\n    return (\n      <StoreContext.Provider value={storeRef.current}>\n        {children}\n      </StoreContext.Provider>\n    );\n  };\n\n  const useAtom = ((anAtom: any, options?: any) => {\n    const store = useContext(StoreContext);\n    if (!store) {\n      throw new Error('Missing Provider from createIsolation');\n    }\n    return useAtomOrig(anAtom, { store, ...options });\n  }) as typeof useAtomOrig;\n\n  const useAtomValue = ((anAtom: any, options?: any) => {\n    const store = useContext(StoreContext);\n    if (!store) {\n      throw new Error('Missing Provider from createIsolation');\n    }\n    return useAtomValueOrig(anAtom, { store, ...options });\n  }) as typeof useAtomValueOrig;\n\n  const useSetAtom = ((anAtom: any, options?: any) => {\n    const store = useContext(StoreContext);\n    if (!store) {\n      throw new Error('Missing Provider from createIsolation');\n    }\n    return useSetAtomOrig(anAtom, { store, ...options });\n  }) as typeof useSetAtomOrig;\n\n  return { Provider, useAtom, useAtomValue, useSetAtom };\n}\n","import { createContext, useContext, useState } from 'react';\nimport type { ReactNode } from 'react';\nimport { Provider, useStore } from 'jotai/react';\nimport type { Atom, WritableAtom } from 'jotai/vanilla';\n\ntype AnyAtom = Atom<unknown>;\ntype AnyWritableAtom = WritableAtom<unknown, unknown[], unknown>;\ntype GetScopedAtom = <T extends AnyAtom>(anAtom: T) => T;\n\nconst isEqualSet = (a: Set<unknown>, b: Set<unknown>) =>\n  a === b || (a.size === b.size && Array.from(a).every((v) => b.has(v)));\n\nexport const ScopeContext = createContext<GetScopedAtom>((a) => a);\n\nexport const ScopeProvider = ({\n  atoms,\n  children,\n}: {\n  atoms: Iterable<AnyAtom>;\n  children: ReactNode;\n}) => {\n  const store = useStore();\n  const getParentScopedAtom = useContext(ScopeContext);\n  const atomSet = new Set(atoms);\n\n  const initialize = () => {\n    const mapping = new WeakMap<AnyAtom, AnyAtom>();\n    const createScopedAtom = <T extends AnyWritableAtom>(\n      anAtom: T,\n      delegate: boolean,\n    ): T => {\n      const getAtom = <A extends AnyAtom>(\n        thisArg: AnyAtom,\n        orig: AnyAtom,\n        target: A,\n      ): A => {\n        if (target === thisArg) {\n          return delegate ? getParentScopedAtom(orig as A) : target;\n        }\n        return getScopedAtom(target);\n      };\n      const scopedAtom: typeof anAtom = {\n        ...anAtom,\n        ...('read' in anAtom && {\n          read(get, opts) {\n            return anAtom.read.call(\n              this,\n              (a) => get(getAtom(this, anAtom, a)),\n              opts,\n            );\n          },\n        }),\n        ...('write' in anAtom && {\n          write(get, set, ...args) {\n            return anAtom.write.call(\n              this,\n              (a) => get(getAtom(this, anAtom, a)),\n              (a, ...v) => set(getAtom(this, anAtom, a), ...v),\n              ...args,\n            );\n          },\n        }),\n      };\n      return scopedAtom;\n    };\n\n    const getScopedAtom: GetScopedAtom = (anAtom) => {\n      let scopedAtom = mapping.get(anAtom);\n      if (!scopedAtom) {\n        scopedAtom = atomSet.has(anAtom)\n          ? createScopedAtom(anAtom as unknown as AnyWritableAtom, false)\n          : createScopedAtom(anAtom as unknown as AnyWritableAtom, true);\n        mapping.set(anAtom, scopedAtom);\n      }\n      return scopedAtom as typeof anAtom;\n    };\n\n    const patchedStore: typeof store = {\n      ...store,\n      get: (anAtom, ...args) => store.get(getScopedAtom(anAtom), ...args),\n      set: (anAtom, ...args) => store.set(getScopedAtom(anAtom), ...args),\n      sub: (anAtom, ...args) => store.sub(getScopedAtom(anAtom), ...args),\n    };\n\n    return [\n      patchedStore,\n      getScopedAtom,\n      store,\n      getParentScopedAtom,\n      atomSet,\n    ] as const;\n  };\n\n  const [state, setState] = useState(initialize);\n  if (\n    store !== state[2] ||\n    getParentScopedAtom !== state[3] ||\n    !isEqualSet(atomSet, state[4])\n  ) {\n    setState(initialize);\n  }\n  const [patchedStore, getScopedAtom] = state;\n\n  return (\n    <ScopeContext.Provider value={getScopedAtom}>\n      <Provider store={patchedStore}>{children}</Provider>\n    </ScopeContext.Provider>\n  );\n};\n"],"names":["createIsolation","StoreContext","createContext","Provider","store","initialValues","children","storeRef","useRef","current","createStore","useHydrateAtoms","_jsx","value","useAtom","anAtom","options","useContext","Error","useAtomOrig","_extends","useAtomValue","useAtomValueOrig","useSetAtom","useSetAtomOrig","isEqualSet","a","b","size","Array","from","every","v","has","ScopeContext","ScopeProvider","atoms","useStore","getParentScopedAtom","atomSet","Set","initialize","mapping","WeakMap","createScopedAtom","delegate","getAtom","thisArg","orig","target","getScopedAtom","scopedAtom","read","get","opts","call","write","set","args","patchedStore","sub","state","setState","useState"],"mappings":"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"}